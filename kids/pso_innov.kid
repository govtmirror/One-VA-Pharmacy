KIDS Distribution saved on Sep 19, 2014@09:42:35
SEPTEMBER 19TH UPDATES
**KIDS**:PSO INNOVATION 1.0^

**INSTALL NAME**
PSO INNOVATION 1.0
"BLD",8864,0)
PSO INNOVATION 1.0^^0^3140919^n
"BLD",8864,4,0)
^9.64PA^52.09^2
"BLD",8864,4,52,0)
52
"BLD",8864,4,52,2,0)
^9.641^52.2^2
"BLD",8864,4,52,2,52.1,0)
REFILL  (sub-file)
"BLD",8864,4,52,2,52.1,1,0)
^9.6411^93^3
"BLD",8864,4,52,2,52.1,1,91,0)
REMOTE FILL SITE
"BLD",8864,4,52,2,52.1,1,92,0)
REMOTE PHARMACIST
"BLD",8864,4,52,2,52.1,1,93,0)
REMOTE PHARMACIST PHONE
"BLD",8864,4,52,2,52.2,0)
PARTIAL DATE  (sub-file)
"BLD",8864,4,52,2,52.2,1,0)
^9.6411^93^3
"BLD",8864,4,52,2,52.2,1,91,0)
REMOTE FILL SITE
"BLD",8864,4,52,2,52.2,1,92,0)
REMOTE PHARMACIST
"BLD",8864,4,52,2,52.2,1,93,0)
REMOTE PHARMACIST PHONE
"BLD",8864,4,52,222)
y^y^p^^^^n^^n
"BLD",8864,4,52,224)

"BLD",8864,4,52.09,0)
52.09
"BLD",8864,4,52.09,222)
y^y^f^^^^n
"BLD",8864,4,"APDD",52,52.1)

"BLD",8864,4,"APDD",52,52.1,91)

"BLD",8864,4,"APDD",52,52.1,92)

"BLD",8864,4,"APDD",52,52.1,93)

"BLD",8864,4,"APDD",52,52.2)

"BLD",8864,4,"APDD",52,52.2,91)

"BLD",8864,4,"APDD",52,52.2,92)

"BLD",8864,4,"APDD",52,52.2,93)

"BLD",8864,4,"B",52,52)

"BLD",8864,4,"B",52.09,52.09)

"BLD",8864,6.3)
16
"BLD",8864,"KRN",0)
^9.67PA^779.2^20
"BLD",8864,"KRN",.4,0)
.4
"BLD",8864,"KRN",.401,0)
.401
"BLD",8864,"KRN",.402,0)
.402
"BLD",8864,"KRN",.403,0)
.403
"BLD",8864,"KRN",.5,0)
.5
"BLD",8864,"KRN",.84,0)
.84
"BLD",8864,"KRN",3.6,0)
3.6
"BLD",8864,"KRN",3.8,0)
3.8
"BLD",8864,"KRN",9.2,0)
9.2
"BLD",8864,"KRN",9.8,0)
9.8
"BLD",8864,"KRN",9.8,"NM",0)
^9.68A^13^12
"BLD",8864,"KRN",9.8,"NM",1,0)
PSORRX1^^0^B142480212
"BLD",8864,"KRN",9.8,"NM",2,0)
PSORREF^^0^B32242585
"BLD",8864,"KRN",9.8,"NM",3,0)
PSORREF0^^0^B50210673
"BLD",8864,"KRN",9.8,"NM",4,0)
PSORREF1^^0^B3267523
"BLD",8864,"KRN",9.8,"NM",6,0)
PSOROS^^0^B793511
"BLD",8864,"KRN",9.8,"NM",7,0)
PSORX1^^0^B67963824
"BLD",8864,"KRN",9.8,"NM",8,0)
PSOORUT1^^0^B110471579
"BLD",8864,"KRN",9.8,"NM",9,0)
PSOORNE2^^0^B98555491
"BLD",8864,"KRN",9.8,"NM",10,0)
PSORWRAP^^0^B4004
"BLD",8864,"KRN",9.8,"NM",11,0)
PSORRP^^0^B55319118
"BLD",8864,"KRN",9.8,"NM",12,0)
PSORRPA1^^0^B74374750
"BLD",8864,"KRN",9.8,"NM",13,0)
PSORRD^^0^B373794
"BLD",8864,"KRN",9.8,"NM","B","PSOORNE2",9)

"BLD",8864,"KRN",9.8,"NM","B","PSOORUT1",8)

"BLD",8864,"KRN",9.8,"NM","B","PSOROS",6)

"BLD",8864,"KRN",9.8,"NM","B","PSORRD",13)

"BLD",8864,"KRN",9.8,"NM","B","PSORREF",2)

"BLD",8864,"KRN",9.8,"NM","B","PSORREF0",3)

"BLD",8864,"KRN",9.8,"NM","B","PSORREF1",4)

"BLD",8864,"KRN",9.8,"NM","B","PSORRP",11)

"BLD",8864,"KRN",9.8,"NM","B","PSORRPA1",12)

"BLD",8864,"KRN",9.8,"NM","B","PSORRX1",1)

"BLD",8864,"KRN",9.8,"NM","B","PSORWRAP",10)

"BLD",8864,"KRN",9.8,"NM","B","PSORX1",7)

"BLD",8864,"KRN",19,0)
19
"BLD",8864,"KRN",19,"NM",0)
^9.68A^2^2
"BLD",8864,"KRN",19,"NM",1,0)
PSO RX^^0
"BLD",8864,"KRN",19,"NM",2,0)
PSO REMOTE RX REPORT^^0
"BLD",8864,"KRN",19,"NM","B","PSO REMOTE RX REPORT",2)

"BLD",8864,"KRN",19,"NM","B","PSO RX",1)

"BLD",8864,"KRN",19.1,0)
19.1
"BLD",8864,"KRN",101,0)
101
"BLD",8864,"KRN",101,"NM",0)
^9.68A^9^9
"BLD",8864,"KRN",101,"NM",1,0)
ZJTH PHARM QBP-Q13 ESUBS^^0
"BLD",8864,"KRN",101,"NM",2,0)
ZJTH PHARM QBP-Q13 EVENT^^0
"BLD",8864,"KRN",101,"NM",3,0)
ZJTH PHARM RDS-O13 ESUBS^^0
"BLD",8864,"KRN",101,"NM",4,0)
ZJTH PHARM RDS-O13 EVENT^^0
"BLD",8864,"KRN",101,"NM",5,0)
PSO LM REMOTE ORDER MENU^^0
"BLD",8864,"KRN",101,"NM",6,0)
PSO LM REFILL REMOTE ORDER^^0
"BLD",8864,"KRN",101,"NM",7,0)
PSO LM REMOTE PARTIAL^^0
"BLD",8864,"KRN",101,"NM",8,0)
PSO LM REMOTE RX REPORT MENU^^0
"BLD",8864,"KRN",101,"NM",9,0)
PSO LM SELECT REPORT ITEM^^0
"BLD",8864,"KRN",101,"NM","B","PSO LM REFILL REMOTE ORDER",6)

"BLD",8864,"KRN",101,"NM","B","PSO LM REMOTE ORDER MENU",5)

"BLD",8864,"KRN",101,"NM","B","PSO LM REMOTE PARTIAL",7)

"BLD",8864,"KRN",101,"NM","B","PSO LM REMOTE RX REPORT MENU",8)

"BLD",8864,"KRN",101,"NM","B","PSO LM SELECT REPORT ITEM",9)

"BLD",8864,"KRN",101,"NM","B","ZJTH PHARM QBP-Q13 ESUBS",1)

"BLD",8864,"KRN",101,"NM","B","ZJTH PHARM QBP-Q13 EVENT",2)

"BLD",8864,"KRN",101,"NM","B","ZJTH PHARM RDS-O13 ESUBS",3)

"BLD",8864,"KRN",101,"NM","B","ZJTH PHARM RDS-O13 EVENT",4)

"BLD",8864,"KRN",409.61,0)
409.61
"BLD",8864,"KRN",409.61,"NM",0)
^9.68A^3^3
"BLD",8864,"KRN",409.61,"NM",1,0)
PSO LM REMOTE ORDER SELECTION^^0
"BLD",8864,"KRN",409.61,"NM",2,0)
PSO LM REMOTE RX REPORT^^0
"BLD",8864,"KRN",409.61,"NM",3,0)
PSO LM REMOTE REPORT DETAILS^^0
"BLD",8864,"KRN",409.61,"NM","B","PSO LM REMOTE ORDER SELECTION",1)

"BLD",8864,"KRN",409.61,"NM","B","PSO LM REMOTE REPORT DETAILS",3)

"BLD",8864,"KRN",409.61,"NM","B","PSO LM REMOTE RX REPORT",2)

"BLD",8864,"KRN",771,0)
771
"BLD",8864,"KRN",771,"NM",0)
^9.68A^2^2
"BLD",8864,"KRN",771,"NM",1,0)
ZJTH ESB PHARM^^0
"BLD",8864,"KRN",771,"NM",2,0)
ZJTH VISTA PHARM^^0
"BLD",8864,"KRN",771,"NM","B","ZJTH ESB PHARM",1)

"BLD",8864,"KRN",771,"NM","B","ZJTH VISTA PHARM",2)

"BLD",8864,"KRN",779.2,0)
779.2
"BLD",8864,"KRN",779.2,"NM",0)
^9.68A^^
"BLD",8864,"KRN",870,0)
870
"BLD",8864,"KRN",870,"NM",0)
^9.68A^2^2
"BLD",8864,"KRN",870,"NM",1,0)
ZJTHR39550^^0
"BLD",8864,"KRN",870,"NM",2,0)
ZJTHS36500^^0
"BLD",8864,"KRN",870,"NM","B","ZJTHR39550",1)

"BLD",8864,"KRN",870,"NM","B","ZJTHS36500",2)

"BLD",8864,"KRN",8989.51,0)
8989.51
"BLD",8864,"KRN",8989.52,0)
8989.52
"BLD",8864,"KRN",8994,0)
8994
"BLD",8864,"KRN","B",.4,.4)

"BLD",8864,"KRN","B",.401,.401)

"BLD",8864,"KRN","B",.402,.402)

"BLD",8864,"KRN","B",.403,.403)

"BLD",8864,"KRN","B",.5,.5)

"BLD",8864,"KRN","B",.84,.84)

"BLD",8864,"KRN","B",3.6,3.6)

"BLD",8864,"KRN","B",3.8,3.8)

"BLD",8864,"KRN","B",9.2,9.2)

"BLD",8864,"KRN","B",9.8,9.8)

"BLD",8864,"KRN","B",19,19)

"BLD",8864,"KRN","B",19.1,19.1)

"BLD",8864,"KRN","B",101,101)

"BLD",8864,"KRN","B",409.61,409.61)

"BLD",8864,"KRN","B",771,771)

"BLD",8864,"KRN","B",779.2,779.2)

"BLD",8864,"KRN","B",870,870)

"BLD",8864,"KRN","B",8989.51,8989.51)

"BLD",8864,"KRN","B",8989.52,8989.52)

"BLD",8864,"KRN","B",8994,8994)

"BLD",8864,"QUES",0)
^9.62^^
"FIA",52)
PRESCRIPTION
"FIA",52,0)
^PSRX(
"FIA",52,0,0)
52Is
"FIA",52,0,1)
y^y^p^^^^n^^n
"FIA",52,0,10)

"FIA",52,0,11)

"FIA",52,0,"RLRO")

"FIA",52,52)
1
"FIA",52,52.1)
1
"FIA",52,52.1,91)

"FIA",52,52.1,92)

"FIA",52,52.1,93)

"FIA",52,52.2)
1
"FIA",52,52.2,91)

"FIA",52,52.2,92)

"FIA",52,52.2,93)

"FIA",52.09)
REMOTE PRESCRIPTION LOG
"FIA",52.09,0)
^PSRXR(52.09,
"FIA",52.09,0,0)
52.09D
"FIA",52.09,0,1)
y^y^f^^^^n
"FIA",52.09,0,10)

"FIA",52.09,0,11)

"FIA",52.09,0,"RLRO")

"FIA",52.09,52.09)
0
"FIA",52.09,52.092)
0
"FIA",52.09,52.093)
0
"KRN",19,248,-1)
0^1
"KRN",19,248,0)
PSO RX^Rx (Prescriptions)^^M^^^^^^^^OUTPATIENT PHARMACY^^1^
"KRN",19,248,1,0)
^19.06^1^1^3140430^^^^
"KRN",19,248,1,1,0)
This menu gives access to all prescription functions.
"KRN",19,248,10,0)
^19.01IP^24^24
"KRN",19,248,10,24,0)
14286^^2
"KRN",19,248,10,24,"^")
PSO REMOTE RX REPORT
"KRN",19,248,10,"A6359",1)
New Prescription Entry^449^^
"KRN",19,248,10,"A6359",2)
Refill Prescriptions^459^^
"KRN",19,248,10,"A6359",3)
Edit Prescriptions^469^^
"KRN",19,248,10,"A6359",4)
Reprint An Outpatient Label^470^^
"KRN",19,248,10,"A6359",5)
View Prescriptions^475^^
"KRN",19,248,10,"A6359",6)
Cancel Prescription^476^^
"KRN",19,248,10,"A6359",7)
Hold/Remove from Hold^479^^
"KRN",19,248,10,"A6359",8)
Partial Prescription^478^^
"KRN",19,248,15)

"KRN",19,248,20)
D ^PSOLSET:'$D(PSOPAR) D CHK^PSOORFIN
"KRN",19,248,99)
63307,38144
"KRN",19,248,"U")
RX (PRESCRIPTIONS)
"KRN",19,14286,-1)
0^2
"KRN",19,14286,0)
PSO REMOTE RX REPORT^Remote Prescription Report^^A^^^^^^^^^^1
"KRN",19,14286,1,0)
^^1^1^3140430^
"KRN",19,14286,1,1,0)
This report shows what actions have been taken on remote Rx's.
"KRN",19,14286,20)
D ^PSORRP
"KRN",19,14286,"U")
REMOTE PRESCRIPTION REPORT
"KRN",101,6038,-1)
0^2
"KRN",101,6038,0)
ZJTH PHARM QBP-Q13 EVENT^^^E^^^^^^^^
"KRN",101,6038,770)
ZJTH VISTA PHARM^^QBP^Q13^^^^NE^AL^2.5.1^
"KRN",101,6038,775,0)
^101.0775PA^1^1
"KRN",101,6038,775,1,0)
6039
"KRN",101,6038,775,1,"^")
ZJTH PHARM QBP-Q13 ESUBS
"KRN",101,6039,-1)
0^1
"KRN",101,6039,0)
ZJTH PHARM QBP-Q13 ESUBS^^^S^^^^^^^^
"KRN",101,6039,770)
^ZJTH ESB PHARM^^K13^^^ZJTHS36500^^^^RTB
"KRN",101,6042,-1)
0^5
"KRN",101,6042,0)
PSO LM REMOTE ORDER MENU^Remote Order Menu^^M^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6042,4)
40
"KRN",101,6042,10,0)
^101.01PA^2^2
"KRN",101,6042,10,1,0)
6043^RF^1^
"KRN",101,6042,10,1,"^")
PSO LM REFILL REMOTE ORDER
"KRN",101,6042,10,2,0)
6044^PR^2^
"KRN",101,6042,10,2,"^")
PSO LM REMOTE PARTIAL
"KRN",101,6042,26)
D SHOW^VALM
"KRN",101,6042,28)
Select Action:
"KRN",101,6042,99)
63264,71437
"KRN",101,6043,-1)
0^6
"KRN",101,6043,0)
PSO LM REFILL REMOTE ORDER^Refill Remote Order^^A^^^^^^^^
"KRN",101,6043,2,0)
^101.02A^1^1
"KRN",101,6043,2,1,0)
RF
"KRN",101,6043,2,"B","RF",1)

"KRN",101,6043,20)
D REFREQ^PSORRX1
"KRN",101,6043,99)
63236,47172
"KRN",101,6044,-1)
0^7
"KRN",101,6044,0)
PSO LM REMOTE PARTIAL^Partial^^A^^^^^^^^
"KRN",101,6044,20)
D PARTIAL^PSORRX1
"KRN",101,6044,99)
63238,41001
"KRN",101,6047,-1)
0^4
"KRN",101,6047,0)
ZJTH PHARM RDS-O13 EVENT^Pharmacy/Treatment Dispense Message^^E^^^^^^^^
"KRN",101,6047,99)
63260,40758
"KRN",101,6047,770)
ZJTH VISTA PHARM^^RDS^O13^^^^NE^AL^2.5.1^
"KRN",101,6047,775,0)
^101.0775PA^1^1
"KRN",101,6047,775,1,0)
6048
"KRN",101,6047,775,1,"^")
ZJTH PHARM RDS-O13 ESUBS
"KRN",101,6048,-1)
0^3
"KRN",101,6048,0)
ZJTH PHARM RDS-O13 ESUBS^Pharmacy/Treatment Dispense Message^^S^^^^^^^^
"KRN",101,6048,99)
63260,40810
"KRN",101,6048,770)
^ZJTH ESB PHARM^^O14^^^ZJTHS36500^^^^RRD
"KRN",101,6049,-1)
0^8
"KRN",101,6049,0)
PSO LM REMOTE RX REPORT MENU^Remote Rx Selection^^M^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6049,4)
40^9
"KRN",101,6049,10,0)
^101.01PA^1^1
"KRN",101,6049,10,1,0)
6050^SI^^
"KRN",101,6049,10,1,"^")
PSO LM SELECT REPORT ITEM
"KRN",101,6049,26)
D SHOW^VALM
"KRN",101,6049,28)
Select Action:
"KRN",101,6049,99)
63306,53139
"KRN",101,6050,-1)
0^9
"KRN",101,6050,0)
PSO LM SELECT REPORT ITEM^Select Item^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6050,2,0)
^101.02A^^0
"KRN",101,6050,15)
Q
"KRN",101,6050,20)
D SEL^PSORRP
"KRN",101,6050,99)
63306,51893
"KRN",409.61,793,-1)
0^1
"KRN",409.61,793,0)
PSO LM REMOTE ORDER SELECTION^1^^80^8^20^0^1^^PSO LM REMOTE ORDER MENU^PSO LM REMOTE ORDER SELECTION^1^^1
"KRN",409.61,793,1)
^VALM HIDDEN ACTIONS
"KRN",409.61,793,"ARRAY")
 ^TMP("PSOAO",$J)
"KRN",409.61,793,"FNL")
D EXIT^PSOROS
"KRN",409.61,793,"HDR")
D HDR^PSOLMUTL
"KRN",409.61,793,"HLP")
D HELP^PSOROS
"KRN",409.61,793,"INIT")
D INIT^PSOROS
"KRN",409.61,794,-1)
0^2
"KRN",409.61,794,0)
PSO LM REMOTE RX REPORT^1^^80^5^20^0^1^^PSO LM REMOTE RX REPORT MENU^PSO LM REMOTE RX REPORT^1^^1
"KRN",409.61,794,1)
^VALM HIDDEN ACTIONS
"KRN",409.61,794,"COL",0)
^409.621^7^7
"KRN",409.61,794,"COL",1,0)
LINENO^1^4^NO
"KRN",409.61,794,"COL",2,0)
DATE^6^12^DATE
"KRN",409.61,794,"COL",3,0)
PATIENT^20^21^PATIENT
"KRN",409.61,794,"COL",4,0)
DRUG^43^20^DRUG NAME
"KRN",409.61,794,"COL",5,0)
TYPE^65^4^TYPE
"KRN",409.61,794,"COL",6,0)
QTY^71^3^QTY
"KRN",409.61,794,"COL",7,0)
DSUPP^76^4^DSUP
"KRN",409.61,794,"COL","B","DATE",2)

"KRN",409.61,794,"COL","B","DRUG",4)

"KRN",409.61,794,"COL","B","DSUPP",7)

"KRN",409.61,794,"COL","B","LINENO",1)

"KRN",409.61,794,"COL","B","PATIENT",3)

"KRN",409.61,794,"COL","B","QTY",6)

"KRN",409.61,794,"COL","B","TYPE",5)

"KRN",409.61,794,"FNL")
D EXIT^PSORRP
"KRN",409.61,794,"HDR")
D HDR^PSORRP
"KRN",409.61,794,"HLP")
D HELP^PSORRP
"KRN",409.61,794,"INIT")
D INIT^PSORRP
"KRN",409.61,795,-1)
0^3
"KRN",409.61,795,0)
PSO LM REMOTE REPORT DETAILS^2^^80^4^20^0^1^^^PSO LM REMOTE REPORT DETAILS^1^^1
"KRN",409.61,795,1)
^VALM HIDDEN ACTIONS
"KRN",409.61,795,"ARRAY")
 ^TMP("PSORRD",$J)
"KRN",409.61,795,"FNL")
D EXIT^PSORRD
"KRN",409.61,795,"HDR")
D HDR^PSORRD
"KRN",409.61,795,"HLP")
D HELP^PSORRD
"KRN",409.61,795,"INIT")
D INIT^PSORRD
"KRN",771,235,-1)
0^2
"KRN",771,235,0)
ZJTH VISTA PHARM^a^2201^^^^USA
"KRN",771,235,"EC")
^~\&
"KRN",771,235,"FS")
|
"KRN",771,236,-1)
0^1
"KRN",771,236,0)
ZJTH ESB PHARM^a^36500^^^^USA
"KRN",771,236,"EC")
^~\&
"KRN",771,236,"FS")
|
"KRN",870,141,-1)
0^2
"KRN",870,141,0)
ZJTHS36500^^TCP^^^^^^^^^^^^^^^^^^10
"KRN",870,141,200)
^^^^^^^^^R
"KRN",870,141,400)
10.139.26.223^36500^C^N^15^^^^
"KRN",870,142,-1)
0^1
"KRN",870,142,0)
ZJTHR39550^^TCP^^^^^^^^^^^^^^^^^^10
"KRN",870,142,400)
^39500^M^^^^^^
"MBREQ")
0
"ORD",13,870)
870;13;1;;HLLL^XPDTA1;;HLLLE^XPDIA1;;;HLLLDEL^XPDIA1(%)
"ORD",13,870,0)
HL LOGICAL LINK
"ORD",14,771)
771;14;;;HLAP^XPDTA1;HLAPF1^XPDIA1;HLAPE1^XPDIA1;HLAPF2^XPDIA1;;HLAPDEL^XPDIA1(%)
"ORD",14,771,0)
HL7 APPLICATION PARAMETER
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"ORD",17,409.61)
409.61;17;1;;;;LME1^XPDIA1;;;LMDEL^XPDIA1
"ORD",17,409.61,0)
LIST TEMPLATE
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
12
"RTN","PSOORNE2")
0^9^B98555491
"RTN","PSOORNE2",1,0)
PSOORNE2 ;BIR/SAB-display finished orders from backdoor ;9/11/06 10:24am
"RTN","PSOORNE2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,21,23,27,32,37,46,84,103,117,131,146,156,210,148,222,238,264,281,289,251,379,391**;DEC 1997;Build 16
"RTN","PSOORNE2",3,0)
 ;^PSDRUG( -  221
"RTN","PSOORNE2",4,0)
 ;^YSCL(603.01 - 2697
"RTN","PSOORNE2",5,0)
 ;^PS(50.606 - 2174
"RTN","PSOORNE2",6,0)
 ;^PS(50.7 - 2223
"RTN","PSOORNE2",7,0)
 ;PSO*210 add call to WORDWRAP api
"RTN","PSOORNE2",8,0)
 ;$$DAWEXT^PSSDAWUT - 4708
"RTN","PSOORNE2",9,0)
 ;
"RTN","PSOORNE2",10,0)
SEL N ORN,ORD I '$G(PSOCNT) S VALMSG="This patient has no Prescriptions!" S VALMBCK="" Q
"RTN","PSOORNE2",11,0)
 D K1^PSOORNE6 S DIR("A")="Select Orders by number",DIR(0)="LO^1:"_PSOCNT D ^DIR I $D(DIRUT) D KV^PSOVER1 S VALMBCK="" Q
"RTN","PSOORNE2",12,0)
NEWSEL N ORN,ORD D K2^PSOORNE6
"RTN","PSOORNE2",13,0)
 ;
"RTN","PSOORNE2",14,0)
 I +Y S PSOOELSE=1,PSLST=Y K PSOREEDT F ORD=1:1:$L(PSLST,",") Q:$P(PSLST,",",ORD)']""  D  D UL1 K ^TMP("PSORXPO",$J) I $G(PSOQUIT) K PSOQUIT Q
"RTN","PSOORNE2",15,0)
 .; bwf 1/21/2014 - replaced line below with the one that follows for remote rx data handling.
"RTN","PSOORNE2",16,0)
 .;S ORN=+$P(PSLST,",",ORD) D @$S(+PSOLST(ORN)=52:"ACT",1:"PEN^PSOORNE5")
"RTN","PSOORNE2",17,0)
 .S ORN=+$P(PSLST,",",ORD) D @$S(+PSOLST(ORN)=52:"ACT",$P(PSOLST(ORN),"^")="R52":"RACT",1:"PEN^PSOORNE5")
"RTN","PSOORNE2",18,0)
 .K PSOREEDT,PSOSIGFL,PSONACT,SIGOK,PSOFDR,DRET,SIG,INS1
"RTN","PSOORNE2",19,0)
 K PRC,PHI,RTE I '$G(PSOOELSE) S VALMBCK=""
"RTN","PSOORNE2",20,0)
 K PSONACT,PSOOELSE,CLOZPAT W !!,"Updating remote order list...",!! D REMOTERX^PSORRX1(PSODFN),^PSOBUILD,BLD^PSOORUT1,K3^PSOORNE6
"RTN","PSOORNE2",21,0)
 Q
"RTN","PSOORNE2",22,0)
 ;
"RTN","PSOORNE2",23,0)
ACT N REF,RPHKEY,PKIND K ^TMP("PSOAO",$J),PCOMX,PDA,PHI,PRC,ACOM,ANS,PSOFDR,CLOZPAT,ANQREM,DUR,DRET
"RTN","PSOORNE2",24,0)
 S RXN=$P(PSOLST(ORN),"^",2),RX0=^PSRX(RXN,0),RX2=$G(^(2)),RX3=$G(^(3)),ST=+$G(^("STA")),RXOR=$G(^("OR1")),POE=$G(^("POE")),EXDT=$S($P($G(^(2)),"^",6)>DT:1,1:0)
"RTN","PSOORNE2",25,0)
 I 'RX3 S RX3=$P(RX2,"^",2),$P(^PSRX(RXN,3),"^")=$P(RX2,"^",2)
"RTN","PSOORNE2",26,0)
 S PSODRG=+$P(RX0,"^",6),PSODRUG0=^PSDRUG(PSODRG,0),INDT=$G(^("I"))
"RTN","PSOORNE2",27,0)
 ;PSO*7*238;SET PSODRUG ARRAY ; PSOY KILLED AT END OF SET^PSODRG
"RTN","PSOORNE2",28,0)
 K PSODRUG
"RTN","PSOORNE2",29,0)
 S PSOY=PSODRG,PSOY(0)=PSODRUG0 D SET^PSODRG
"RTN","PSOORNE2",30,0)
 I 'RXOR,$P(^PSDRUG(PSODRG,2),"^") S $P(^PSRX(RXN,"OR1"),"^")=$P(^PSDRUG(PSODRG,2),"^"),RXOR=$P(^PSDRUG(PSODRG,2),"^")
"RTN","PSOORNE2",31,0)
 I $P($G(^PSDRUG(PSODRG,"CLOZ1")),"^")="PSOCLO1" D
"RTN","PSOORNE2",32,0)
 .S CLOZPAT=$O(^YSCL(603.01,"C",PSODFN,0)) Q:'CLOZPAT
"RTN","PSOORNE2",33,0)
 .;S CLOZPAT=$S($P(^YSCL(603.01,CLOZPAT,0),"^",3)="B":1,1:0)
"RTN","PSOORNE2",34,0)
 .S CLOZPAT=$P(^YSCL(603.01,CLOZPAT,0),"^",3)
"RTN","PSOORNE2",35,0)
 .S CLOZPAT=$S(CLOZPAT="M":2,CLOZPAT="B":1,1:0)
"RTN","PSOORNE2",36,0)
 S PKIND=$D(^PSRX(RXN,"PKI")),RPHKEY=$S('PKIND&($D(^XUSEC("PSORPH",DUZ))):1,PKIND&($D(^XUSEC("PSDRPH",DUZ))):1,1:0)
"RTN","PSOORNE2",37,0)
 I RPHKEY S RPH=1 D
"RTN","PSOORNE2",38,0)
 .S PSOACT=$S('ST&($G(INDT)]"")&(DT>$G(INDT)):"DHPLATC",ST=1!(ST=4):"DVE",ST=3:"DU",ST=5:"ELTD",ST=11:"ETDPCL",ST=12&EXDT:"EDCL",ST=12&'EXDT:"ECL",(ST=14!(ST=15))&'EXDT:"ECL",ST=13:"L",ST=16:"DL",1:"DHPEATCL")
"RTN","PSOORNE2",39,0)
 .D GET^PSOORNE5 S PSOACT=PSOACT_$S(ACTREN:"N",1:""),PSOACT=PSOACT_$S(ACTREF:"R",1:"")
"RTN","PSOORNE2",40,0)
 .I ST=5 S SURX=$O(^PS(52.5,"B",RXN,0)) I SURX,$P($G(^PS(52.5,SURX,0)),"^",7)="L" S PSOACT="TL" K SURX Q
"RTN","PSOORNE2",41,0)
 .S:ST'=12&('$D(^PS(50.7,+$P(RXOR,"^"),0))) PSOACT="DL",VALMSG="No Pharmacy Orderable Item !",PSONACT=1
"RTN","PSOORNE2",42,0)
 .S:ST=12&('$D(^PS(50.7,+$P(RXOR,"^"),0))) PSOACT="L",VALMSG="No Pharmacy Orderable Item !",PSONACT=1
"RTN","PSOORNE2",43,0)
 .;I ST=14!(ST=15) S VALMSG="Rx Discontinued By "_$S(ST=14:"Provider",1:"Edit")_". Cannot be Reinstated."
"RTN","PSOORNE2",44,0)
 .S:ST=16 VALMSG="Rx Placed on HOLD by Provider."
"RTN","PSOORNE2",45,0)
 E  D
"RTN","PSOORNE2",46,0)
 .I ST=5 S SURX=$O(^PS(52.5,"B",RXN,0)) I SURX,$P($G(^PS(52.5,SURX,0)),"^",7)="L" S PSOACT="TL" Q
"RTN","PSOORNE2",47,0)
 .S PSOACT=$S(ST'<1&(ST'>4)!(ST>12):"",ST=12&EXDT&($P($G(PSOPAR),"^",2)):"CDPLT",1:"CPLT")
"RTN","PSOORNE2",48,0)
 .D GET^PSOORNE5 S PSOACT=PSOACT_$S(ACTREN:"N",1:""),PSOACT=PSOACT_$S(ACTREF:"R",1:"")
"RTN","PSOORNE2",49,0)
 .S:'$D(^PS(50.7,+$P(RXOR,"^"),0)) PSOACT="L",PSONACT=1,VALMSG="No Pharmacy Orderable Item !"
"RTN","PSOORNE2",50,0)
 ;K PSOLKFL D PSOL^PSSLOCK(RXN) I '$G(PSOMSG) K PSOMSG S PSOLKFL=1 S PSOACT="",VALMSG="This Order is being edited by another user."
"RTN","PSOORNE2",51,0)
 K PSOMSG S IEN=0,$P(RN," ",12)=" "
"RTN","PSOORNE2",52,0)
 D DIN^PSONFI(+RXOR,$P(RX0,"^",6))
"RTN","PSOORNE2",53,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=$S($P($G(^PSRX(RXN,"TPB")),"^"):"            TPB Rx #: ",1:"                Rx #: ")
"RTN","PSOORNE2",54,0)
 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_$P(RX0,"^")_$S($G(^PSRX(RXN,"IB")):"$",1:"")_$$ECME^PSOBPSUT(RXN)_$E(RN,$L($P(RX0,"^")_$S($G(^PSRX(RXN,"IB")):"$",1:"")_$$ECME^PSOBPSUT(RXN))+1,12)
"RTN","PSOORNE2",55,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" ("_$S($P(PSOPAR,"^",3):1,1:"#")_")"_" *Orderable Item: "_$S($D(^PS(50.7,$P(+RXOR,"^"),0)):$P(^PS(50.7,$P(+RXOR,"^"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^"),1:"")_NFIO
"RTN","PSOORNE2",56,0)
 S:NFIO["<DIN>" NFIO=IEN_","_($L(^TMP("PSOAO",$J,IEN,0))-4)
"RTN","PSOORNE2",57,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" ("_$S($P(PSOPAR,"^",3):2,1:"#")_")"_$S($D(^PSDRUG("AQ",$P(RX0,"^",6))):"       CMOP ",1:"            ")_"Drug: "_$P(^PSDRUG($P(RX0,"^",6),0),"^")_NFID
"RTN","PSOORNE2",58,0)
 S:NFID["<DIN>" NFID=IEN_","_($L(^TMP("PSOAO",$J,IEN,0))-4)
"RTN","PSOORNE2",59,0)
 I $$STATUS^PSOBPSUT(RXN,0)'="",$$RXRLDT^PSOBPSUT(RXN,0) D
"RTN","PSOORNE2",60,0)
 . S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" "_$S('$P(PSOPAR,"^",3):"(2)",1:"   ")_"             NDC: "_$$GETNDC^PSONDCUT(RXN,0)
"RTN","PSOORNE2",61,0)
 S:$G(^PSRX(RXN,"TN"))]"" IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="          Trade Name: "_$G(^PSRX(RXN,"TN"))
"RTN","PSOORNE2",62,0)
 D DOSE^PSOORNE5
"RTN","PSOORNE2",63,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" (4)Pat Instructions:" D INS^PSOORNE5
"RTN","PSOORNE2",64,0)
 D PC^PSOORNE5
"RTN","PSOORNE2",65,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="                 SIG:"
"RTN","PSOORNE2",66,0)
 I '$P($G(^PSRX(RXN,"SIG")),"^",2) S SIGOK=0 D  G PTST
"RTN","PSOORNE2",67,0)
 .S X=$P($G(^PSRX(RXN,"SIG")),"^") D SIGONE^PSOHELP S SIG=$E($G(INS1),2,250)
"RTN","PSOORNE2",68,0)
 .F SG=1:1:$L(SIG) S:$L(^TMP("PSOAO",$J,IEN,0)_" "_$P(SIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOAO",$J,IEN,0)," ",21)=" " S:$P(SIG," ",SG)'="" ^TMP("PSOAO",$J,IEN,0)=$G(^TMP("PSOAO",$J,IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORNE2",69,0)
 S SIGOK=1
"RTN","PSOORNE2",70,0)
 F I=0:0 S I=$O(^PSRX(RXN,"SIG1",I)) Q:'I  D                  ;PSO*210
"RTN","PSOORNE2",71,0)
 . S MIG=$P(^PSRX(RXN,"SIG1",I,0),"^")
"RTN","PSOORNE2",72,0)
 . D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOAO",$J)),21)
"RTN","PSOORNE2",73,0)
 S SIGOK=1 K MIG,SG
"RTN","PSOORNE2",74,0)
PTST S $P(RN," ",25)=" ",PTST=$S($G(^PS(53,+$P(RX0,"^",3),0))]"":$P($G(^PS(53,+$P(RX0,"^",3),0)),"^"),1:""),IEN=IEN+1
"RTN","PSOORNE2",75,0)
 S ^TMP("PSOAO",$J,IEN,0)=" (5)  Patient Status: "_PTST_$E(RN,$L(PTST)+1,25)
"RTN","PSOORNE2",76,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" (6)      Issue Date: "_$E($P(RX0,"^",13),4,5)_"/"_$E($P(RX0,"^",13),6,7)_"/"_$E($P(RX0,"^",13),2,3)
"RTN","PSOORNE2",77,0)
 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_"               (7)  Fill Date: "_$E($P(RX2,"^",2),4,5)_"/"_$E($P(RX2,"^",2),6,7)_"/"_$E($P(RX2,"^",2),2,3)
"RTN","PSOORNE2",78,0)
 S ROU=$S($P(RX0,"^",11)="W":"Window",1:"Mail")
"RTN","PSOORNE2",79,0)
 S REFL=$P(RX0,"^",9),I=0 F  S I=$O(^PSRX(RXN,1,I)) Q:'I  S REFL=REFL-1,ROU=$S($P(^PSRX(RXN,1,I,0),"^",2)="W":"Window",1:"Mail")
"RTN","PSOORNE2",80,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="      Last Fill Date: "_$E($P(RX3,"^"),4,5)_"/"_$E($P(RX3,"^"),6,7)_"/"_$E($P(RX3,"^"),2,3)
"RTN","PSOORNE2",81,0)
 D CMOP^PSOORNE3
"RTN","PSOORNE2",82,0)
 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_" ("_ROU_$S($G(PSOCMOP)]"":", "_PSOCMOP,1:"")_")" K ROU,PSOCMOP
"RTN","PSOORNE2",83,0)
 S IEN=IEN+1 I $P(RX2,"^",15) S ^TMP("PSOAO",$J,IEN,0)="   Returned to Stock: "_$E($P(RX2,"^",15),4,5)_"/"_$E($P(RX2,"^",15),6,7)_"/"_$E($P(RX2,"^",15),2,3)_$S($P(RX2,"^",14):" (Reprinted)",1:"")
"RTN","PSOORNE2",84,0)
 E  S ^TMP("PSOAO",$J,IEN,0)="   Last Release Date: " D
"RTN","PSOORNE2",85,0)
 .S RLD=$S($P(RX2,"^",13):$E($P(RX2,"^",13),4,5)_"/"_$E($P(RX2,"^",13),6,7)_"/"_$E($P(RX2,"^",13),2,3),1:"")
"RTN","PSOORNE2",86,0)
 .I $O(^PSRX(RXN,1,0)) F I=0:0 S I=$O(^PSRX(RXN,1,I)) Q:'I  D
"RTN","PSOORNE2",87,0)
 ..I $P(^PSRX(RXN,1,I,0),"^",18) S RLD=$E($P(^(0),"^",18),4,5)_"/"_$E($P(^(0),"^",18),6,7)_"/"_$E($P(^(0),"^",18),2,3)
"RTN","PSOORNE2",88,0)
 .S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_$S($G(RLD)]"":RLD,1:"        ")
"RTN","PSOORNE2",89,0)
 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_"               (8)      Lot #: "_$P($G(RX2),"^",4)
"RTN","PSOORNE2",90,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="             Expires: "_$E($P(RX2,"^",6),4,5)_"/"_$E($P(RX2,"^",6),6,7)_"/"_$E($P(RX2,"^",6),2,3)
"RTN","PSOORNE2",91,0)
 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_"                          MFG: "_$P($G(RX2),"^",8)
"RTN","PSOORNE2",92,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(9)      Days Supply: "_$P(RX0,"^",8)_$S($L($P(RX0,"^",8))=1:" ",1:"")
"RTN","PSOORNE2",93,0)
 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_"                    (10)  QTY"_$S($P($G(^PSDRUG($P(RX0,"^",6),660)),"^",8)]"":" ("_$P($G(^PSDRUG($P(RX0,"^",6),660)),"^",8)_")",1:" (  )")_": "_$P(RX0,"^",7)
"RTN","PSOORNE2",94,0)
 I $P($G(^PSDRUG($P(RX0,"^",6),5)),"^")]"" D
"RTN","PSOORNE2",95,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORNE2",96,0)
 .S ^TMP("PSOAO",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG($P(RX0,"^",6),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG($P(RX0,"^",6),5),"^") K RN
"RTN","PSOORNE2",97,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(11)    # of Refills: "_$P(RX0,"^",9)_$S($L($P(RX0,"^",9))=1:" ",1:"")_"                          Remaining: "_REFL
"RTN","PSOORNE2",98,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(12)        Provider: "_$S($D(^VA(200,$P(RX0,"^",4),0)):$P(^VA(200,$P(RX0,"^",4),0),"^"),1:"UNKNOWN")
"RTN","PSOORNE2",99,0)
 I +$P($G(^PSDRUG($P(RX0,"^",6),0)),"^",3)>1,+$P($G(^PSDRUG($P(RX0,"^",6),0)),"^",3)<6 D PRV^PSOORNE5
"RTN","PSOORNE2",100,0)
 I $P(RX3,"^",3) S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="        Cos-Provider: "_$P(^VA(200,$S($G(PSORX("COSIGNING PROVIDER")):PSORX("COSIGNING PROVIDER"),1:$P(RX3,"^",3)),0),"^")
"RTN","PSOORNE2",101,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(13)         Routing: "_$S($P(RX0,"^",11)="M":"MAIL",1:"WINDOW")_"                  (14)     Copies: "_$S($P(RX0,"^",18):$P(RX0,"^",18),1:1)
"RTN","PSOORNE2",102,0)
 S:$P(RX0,"^",11)="W"&($P(PSOPAR,"^",12)) IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="    Method of Pickup: "_$G(^PSRX(RXN,"MP"))
"RTN","PSOORNE2",103,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(15)          Clinic: "_$S($D(^SC(+$P(RX0,"^",5),0)):$P(^SC($P(RX0,"^",5),0),"^"),1:"Not on File")
"RTN","PSOORNE2",104,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(16)        Division: "_$S($G(^PS(59,+$P(RX2,"^",9),0))]"":$P(^PS(59,$P(RX2,"^",9),0),"^")_" ("_$P(^(0),"^",6)_")",1:"UNKNOWN")
"RTN","PSOORNE2",105,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(17)      Pharmacist: "_$S($P(RX2,"^",3):$P(^VA(200,$P(RX2,"^",3),0),"^"),1:"")
"RTN","PSOORNE2",106,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(18)         Remarks:" D RMK^PSOORNE3
"RTN","PSOORNE2",107,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(19)      Counseling: "_$S($P($G(^PSRX(RXN,"PC")),"^"):"YES",1:"NO")_"                      "_$S($P($G(^PSRX(RXN,"PC")),"^"):"Was Counseling Understood: "_$S($P($G(^PSRX(RXN,"PC")),"^",2):"YES",1:"NO"),1:"")
"RTN","PSOORNE2",108,0)
 S:$O(^PSRX(RXN,1,0)) REF=1,IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(20)     Refill Data"
"RTN","PSOORNE2",109,0)
 I $$STATUS^PSOBPSUT(RXN,0)'="" D
"RTN","PSOORNE2",110,0)
 . N DAW S IEN=IEN+1,DAW=$$GETDAW^PSODAWUT(RXN,0)
"RTN","PSOORNE2",111,0)
 . S ^TMP("PSOAO",$J,IEN,0)="(21)        DAW Code: "_DAW_" - "_$$DAWEXT^PSSDAWUT(DAW)
"RTN","PSOORNE2",112,0)
 D DISP^PSOORNE6
"RTN","PSOORNE2",113,0)
 I $G(PSOBEDT),PSOACT["E" S PSOACT="E"
"RTN","PSOORNE2",114,0)
 I $G(PSOBEDT),PSOACT'["E" S PSOACT=""
"RTN","PSOORNE2",115,0)
 Q:$G(PSORXED)!($G(COPY))!($G(UPMI))
"RTN","PSOORNE2",116,0)
 S:$G(PSOBEDT) (PSOEDIT,PSORXED)=1
"RTN","PSOORNE2",117,0)
RENERR S PSORERR=0 D ^PSOLMLST ; I '$G(PSOLKFL) D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSOORNE2",118,0)
 I PSORERR=1 S:$G(PSOBEDT) (PSOEDIT,PSORXED)=1 G RENERR
"RTN","PSOORNE2",119,0)
 K DRET,SIG
"RTN","PSOORNE2",120,0)
 Q
"RTN","PSOORNE2",121,0)
UL1 ;
"RTN","PSOORNE2",122,0)
 ;I +PSOLST(ORN)=52 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) Q
"RTN","PSOORNE2",123,0)
 ;I $D(^PS(52.41,$P(PSOLST(ORN),"^",2),0)) D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)_"S")
"RTN","PSOORNE2",124,0)
 Q
"RTN","PSOORNE2",125,0)
 ; bwf 1/21/2014 - adding display of remote active orders.
"RTN","PSOORNE2",126,0)
RACT ; display remote active order
"RTN","PSOORNE2",127,0)
 N REMSITE,CNT,REMDATA,RSITENM,RRXNUM,RDETSTR,RSIGSTR,RDET,RSIG,REMSIEN,RXSTAT,SIGLOOP,DETLOOP
"RTN","PSOORNE2",128,0)
 K ^TMP("PSOAO",$J)
"RTN","PSOORNE2",129,0)
 S (RSIG,RDET)=""
"RTN","PSOORNE2",130,0)
 S REMSITE=$P(PSOLST(ORN),U,4) Q:'REMSITE
"RTN","PSOORNE2",131,0)
 S REMSIEN=$O(^DIC(4,"D",REMSITE,""))
"RTN","PSOORNE2",132,0)
 S RSITENM=$$GET1^DIQ(4,REMSIEN,.01,"E")
"RTN","PSOORNE2",133,0)
 ; code for development only. if site name cannot be resolved, display something
"RTN","PSOORNE2",134,0)
 I '$L(RSITENM) S RSITENM="PHARMACY TESTING"
"RTN","PSOORNE2",135,0)
 ; do not continue if we are missing the remote order number for some reason
"RTN","PSOORNE2",136,0)
 S RRXNUM=$P(PSOLST(ORN),U,2) Q:'RRXNUM
"RTN","PSOORNE2",137,0)
 S RXSTAT="" F  S RXSTAT=$O(^XTMP("PSORRX1",$J,DFN,REMSITE,RXSTAT)) Q:RXSTAT=""!$D(^XTMP("PSORRX1",$J,DFN,REMSITE,RXSTAT,RRXNUM))
"RTN","PSOORNE2",138,0)
 Q:RXSTAT=""
"RTN","PSOORNE2",139,0)
 S REMDATA=$G(^XTMP("PSORRX1",$J,DFN,REMSITE,RXSTAT,RRXNUM,0))
"RTN","PSOORNE2",140,0)
 S RDETSTR=$G(^XTMP("PSORRX1",$J,DFN,REMSITE,RXSTAT,RRXNUM,"DETAIL"))
"RTN","PSOORNE2",141,0)
 S RSIGSTR=$G(^XTMP("PSORRX1",$J,DFN,REMSITE,RXSTAT,RRXNUM,"SIG"))
"RTN","PSOORNE2",142,0)
 S CNT=1
"RTN","PSOORNE2",143,0)
 S ^TMP("PSOAO",$J,CNT,0)="         Site #: "_REMSITE_"("_RSITENM_")",CNT=CNT+1
"RTN","PSOORNE2",144,0)
 S ^TMP("PSOAO",$J,CNT,0)="           Rx #: "_RRXNUM,CNT=CNT+1
"RTN","PSOORNE2",145,0)
 S ^TMP("PSOAO",$J,CNT,0)="      Drug Name: "_$P(REMDATA,U),CNT=CNT+1
"RTN","PSOORNE2",146,0)
 S ^TMP("PSOAO",$J,CNT,0)="    Days Supply: "_$P(REMDATA,U,4),CNT=CNT+1
"RTN","PSOORNE2",147,0)
 S ^TMP("PSOAO",$J,CNT,0)="       Quantity: "_$P(REMDATA,U,2),CNT=CNT+1
"RTN","PSOORNE2",148,0)
 S ^TMP("PSOAO",$J,CNT,0)="        Refills: "_$P(REMDATA,U,3),CNT=CNT+1
"RTN","PSOORNE2",149,0)
 S ^TMP("PSOAO",$J,CNT,0)="Expiration Date: "_$$RDT($P($P(REMDATA,U,5),".")),CNT=CNT+1
"RTN","PSOORNE2",150,0)
 S ^TMP("PSOAO",$J,CNT,0)="     Issue Date: "_$$RDT($P($P(REMDATA,U,6),".")),CNT=CNT+1
"RTN","PSOORNE2",151,0)
 S ^TMP("PSOAO",$J,CNT,0)="      Stop Date: "_$$RDT($P($P(REMDATA,U,7),".")),CNT=CNT+1
"RTN","PSOORNE2",152,0)
 S ^TMP("PSOAO",$J,CNT,0)=" Last Fill Date: "_$$RDT($P($P(REMDATA,U,8),".")),CNT=CNT+1
"RTN","PSOORNE2",153,0)
 D RCHUNK(.RDET,RDETSTR),RCHUNK(.RSIG,RSIGSTR)
"RTN","PSOORNE2",154,0)
 S ^TMP("PSOAO",$J,CNT,0)="         Detail: "_$G(RDET(1)),CNT=CNT+1
"RTN","PSOORNE2",155,0)
 S DETLOOP=1 F  S DETLOOP=$O(RDET(DETLOOP)) Q:'DETLOOP  D
"RTN","PSOORNE2",156,0)
 .S ^TMP("PSOAO",$J,CNT,0)="               "_RDET(DETLOOP),CNT=CNT+1
"RTN","PSOORNE2",157,0)
 S ^TMP("PSOAO",$J,CNT,0)="            Sig: "_$G(RSIG(1)),CNT=CNT+1
"RTN","PSOORNE2",158,0)
 S SIGLOOP=1 F  S SIGLOOP=$O(RSIG(SIGLOOP)) Q:'SIGLOOP  D
"RTN","PSOORNE2",159,0)
 .S ^TMP("PSOAO",$J,CNT,0)="               "_RSIG(SIGLOOP),CNT=CNT+1
"RTN","PSOORNE2",160,0)
 ; ^PSOLMLST is the local order template
"RTN","PSOORNE2",161,0)
 D EN^PSOROS
"RTN","PSOORNE2",162,0)
 Q
"RTN","PSOORNE2",163,0)
RCHUNK(ARR,STR) ;
"RTN","PSOORNE2",164,0)
 N LINE,CNT,WORD,I,DONE,ARRSTR
"RTN","PSOORNE2",165,0)
 S (CNT,DONE)=0
"RTN","PSOORNE2",166,0)
 I $L(STR)<60 S ARR(1)=STR Q
"RTN","PSOORNE2",167,0)
 S ARRSTR=""
"RTN","PSOORNE2",168,0)
 F I=1:1 D  Q:DONE
"RTN","PSOORNE2",169,0)
 .S WORD=$P(STR," ",I) I WORD="" S DONE=1 Q
"RTN","PSOORNE2",170,0)
 .I $L(ARRSTR)+$L(WORD)>60 S CNT=CNT+1,ARR(CNT)=ARRSTR,ARRSTR=WORD Q
"RTN","PSOORNE2",171,0)
 .I '$L(ARRSTR) S ARRSTR=WORD Q
"RTN","PSOORNE2",172,0)
 .S ARRSTR=ARRSTR_" "_WORD
"RTN","PSOORNE2",173,0)
 Q
"RTN","PSOORNE2",174,0)
RDT(DATE) ;
"RTN","PSOORNE2",175,0)
 N Y,M,D
"RTN","PSOORNE2",176,0)
 S Y=$E(DATE,3,4),M=$E(DATE,5,6),D=$E(DATE,7,8)
"RTN","PSOORNE2",177,0)
 Q M_"/"_D_"/"_Y
"RTN","PSOORUT1")
0^8^B110471579
"RTN","PSOORUT1",1,0)
PSOORUT1 ;BIR/SAB - Utility routine for oerr interface ;02/22/95
"RTN","PSOORUT1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,14,30,46,132,148,233,274,225,305,289,251,387,385**;DEC 1997;Build 16
"RTN","PSOORUT1",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORUT1",4,0)
 ;External reference to ^PSXOPUTL supported by DBIA 2203
"RTN","PSOORUT1",5,0)
 ;called from HD^PSOORUTL
"RTN","PSOORUT1",6,0)
REL ;removed order from hold
"RTN","PSOORUT1",7,0)
 S ACT=1,ORS=0
"RTN","PSOORUT1",8,0)
 I POERR("PSOFILNM")["S" S DA=+POERR("PSOFILNM") D  G EXIT^PSOORUTL
"RTN","PSOORUT1",9,0)
 .Q:'$D(^PS(52.41,DA,0))  Q:$P(^PS(52.41,DA,0),"^",3)="RF"
"RTN","PSOORUT1",10,0)
 .S $P(^PS(52.41,DA,0),"^",3)="NW",POERR("STAT")="OR",POERR("FILLER")=DA_"^P"
"RTN","PSOORUT1",11,0)
 .S:$G(POERR("COMM"))']"" POERR("COMM")="Order RELEASED from HOLD by OE/RR before finished." S $P(^PS(52.41,DA,4),"^")=POERR("COMM"),ORS=1
"RTN","PSOORUT1",12,0)
 S DA=POERR("PSOFILNM") I $D(^PSRX(DA,0)) S ORS=1,PSDA=DA D  G EXIT^PSOORUTL
"RTN","PSOORUT1",13,0)
 .S POERR("FILLER")=DA_"^R",POERR("STAT")="OR"
"RTN","PSOORUT1",14,0)
 .S:'$D(POERR("COMM")) POERR("COMM")="Prescription Released from HOLD by OE/RR"
"RTN","PSOORUT1",15,0)
 .I DT>$P(^PSRX(DA,2),"^",6) D
"RTN","PSOORUT1",16,0)
 ..S EXP=$P(^PSRX(DA,2),"^",6) S:$P(^PSRX(DA,"STA"),"^")<12 $P(^PSRX(DA,"STA"),"^")=11,PSOEXFLG=1 S POERR("STAT")="UR",POERR("COMM")="Medication Expired on "_$E(EXP,4,5)_"/"_$E(EXP,6,7)_"/"_$E(EXP,2,3)_".",POERR("PHARMST")="" D ECAN^PSOUTL(DA) Q
"RTN","PSOORUT1",17,0)
 .I $P(^PSRX(DA,"STA"),"^")'=16 S POERR("STAT")="UR",POERR("COMM")="Unable to Release from Hold" Q
"RTN","PSOORUT1",18,0)
 .S RXFL(DA)=0,FDT=$P(^PSRX(DA,2),"^",2)
"RTN","PSOORUT1",19,0)
 .I $O(^PSRX(DA,1,0)) F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S FDT=$P(^PSRX(DA,1,I,0),"^"),RXFL(DA)=I
"RTN","PSOORUT1",20,0)
 .I FDT>DT N PSOSITEZ,ZPSOPAR6 S PSOSITEZ=$S($P($G(^PSRX(DA,2)),"^",9):$P(^(2),"^",9),1:$O(^PS(59,0))),ZPSOPAR6=$P($G(^PS(59,PSOSITEZ,1)),"^",6) I ZPSOPAR6 D  Q
"RTN","PSOORUT1",21,0)
 ..S RXXDA=DA,DA=$O(^PS(52.5,"B",RXXDA,0)) I DA S DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOORUT1",22,0)
 ..S DA=RXXDA
"RTN","PSOORUT1",23,0)
 ..S DIC="^PS(52.5,",DIC(0)="L",DLAYGO=52.5,X=RXXDA,DIC("DR")=".02///"_FDT_";.03////"_$P(^PSRX(DA,0),"^",2)_";.04///M;.05///0;.06////"_PSOSITEZ_";2///0;9///"_RXFL(DA) K DD,DO D FILE^DICN K RXFL,DD,DO
"RTN","PSOORUT1",24,0)
 ..S DA=RXXDA K RXXDA S $P(^PSRX(DA,"STA"),"^")=5,LFD=$E(FDT,4,5)_"-"_$E(FDT,6,7)_"-"_$E(FDT,2,3) D ACT1
"RTN","PSOORUT1",25,0)
 ..S PSOSUSZ=1
"RTN","PSOORUT1",26,0)
 .E  S $P(^PSRX(DA,"STA"),"^")=0
"RTN","PSOORUT1",27,0)
 .S RXF=0 F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S RXF=I S:I>5 RXF=I+1
"RTN","PSOORUT1",28,0)
 .D ACT^PSOORUTL
"RTN","PSOORUT1",29,0)
 .I $$SUBMIT^PSOBPSUT(DA) D ECMESND^PSOBPSU1(DA,"","",$S('$O(^PSRX(DA,1,0)):"OF",1:"RF"))
"RTN","PSOORUT1",30,0)
 G EXIT^PSOORUTL
"RTN","PSOORUT1",31,0)
ACT1 I '$D(RXF) S RXF=0 F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S RXF=I S:I>5 RXF=I+1
"RTN","PSOORUT1",32,0)
 S IR=0 F FDA=0:0 S FDA=$O(^PSRX(DA,"A",FDA)) Q:'FDA  S IR=FDA
"RTN","PSOORUT1",33,0)
 S IR=IR+1,^PSRX(DA,"A",0)="^52.3DA^"_IR_"^"_IR
"RTN","PSOORUT1",34,0)
 D NOW^%DTC S ^PSRX(DA,"A",IR,0)=%_"^S^"_POERR("USER")_"^"_RXF_"^"_"RX Placed on Suspense until "_LFD
"RTN","PSOORUT1",35,0)
 Q
"RTN","PSOORUT1",36,0)
SUS ;
"RTN","PSOORUT1",37,0)
 I $P($G(^PSRX(+$G(FILLER),"STA")),"^")=5 N PSOMSORR,PLACERXX D EN^PSOHLSN1(+$G(FILLER),"SC","ZS","")
"RTN","PSOORUT1",38,0)
 Q
"RTN","PSOORUT1",39,0)
BLD ;builds med profile for Listman
"RTN","PSOORUT1",40,0)
 K PSODCREV,^TMP("PSOPF",$J),PSOLST S:$G(PSOOPT)'=3 PSOOPT=0 I '$G(PSOSD),'$D(^XTMP("PSORRX1",$J,PSODFN)) S ^TMP("PSOPF",$J,1,0)="This patient has no prescriptions" S PSOCNT=0,PSOPF=1 Q
"RTN","PSOORUT1",41,0)
 D EOJ,SHOW
"RTN","PSOORUT1",42,0)
EOJ ;
"RTN","PSOORUT1",43,0)
 K PSOQFLG,PSODRG,PSODATA,PSOLF
"RTN","PSOORUT1",44,0)
 Q
"RTN","PSOORUT1",45,0)
 ;-----------------------------------------------------------------
"RTN","PSOORUT1",46,0)
SHOW ;
"RTN","PSOORUT1",47,0)
 ; - ePharmacy modification to create a section for Rx with REJECTs
"RTN","PSOORUT1",48,0)
 N PSOTMP,PSOSTS,PSODRNM,I,PSORX
"RTN","PSOORUT1",49,0)
 S (PSOSTS,PSODRNM)=""
"RTN","PSOORUT1",50,0)
 F  S PSOSTS=$O(PSOSD(PSOSTS)) Q:PSOSTS=""  D
"RTN","PSOORUT1",51,0)
 . F  S PSODRNM=$O(PSOSD(PSOSTS,PSODRNM)) Q:PSODRNM=""  D
"RTN","PSOORUT1",52,0)
 . . S PSORX=+$G(PSOSD(PSOSTS,PSODRNM))
"RTN","PSOORUT1",53,0)
 . . I PSOSTS="ACTIVE",$$FIND^PSOREJUT(PSORX,,,"79,88") D  Q
"RTN","PSOORUT1",54,0)
 . . . S PSOTMP(" REJECT",PSODRNM)=PSOSTS
"RTN","PSOORUT1",55,0)
 . . S PSOTMP(PSOSTS,PSODRNM)=PSOSTS
"RTN","PSOORUT1",56,0)
 ;
"RTN","PSOORUT1",57,0)
 S (PSOSTS,PSODRG)="",(PSOCNT,PSOQFLG,IEN)=0
"RTN","PSOORUT1",58,0)
 K RN,DL S $P(RN," ",12)=" ",$P(DL," ",40)=" "
"RTN","PSOORUT1",59,0)
 F PSCNT=0:0 S PSOSTS=$O(PSOTMP(PSOSTS)) Q:PSOSTS=""  D
"RTN","PSOORUT1",60,0)
 . D STA
"RTN","PSOORUT1",61,0)
 . F PSOCT=0:0 S PSODRG=$O(PSOTMP(PSOSTS,PSODRG)) Q:PSODRG=""  Q:PSOCNT>1000!PSOQFLG  D
"RTN","PSOORUT1",62,0)
 . . S PSOSTA=PSOTMP(PSOSTS,PSODRG)
"RTN","PSOORUT1",63,0)
 . . S PSODATA=PSOSD(PSOSTA,PSODRG) I PSOSTA="ZNONVA" D NVA Q
"RTN","PSOORUT1",64,0)
 . . S PSOCNT=PSOCNT+1 I PSOSTA="PENDING" D PEN Q
"RTN","PSOORUT1",65,0)
 . . S:'$D(^PSRX(+PSODATA,0)) PSOCNT=PSOCNT-1 D:$D(^(0)) DISPL
"RTN","PSOORUT1",66,0)
 ;S (VALMCNT,PSOPF)=IEN
"RTN","PSOORUT1",67,0)
 ; bwf - 1/9/2014, PHARMACY INNOVATIONS. Adding display of remote rx's.
"RTN","PSOORUT1",68,0)
SHOWREM ;
"RTN","PSOORUT1",69,0)
 N REMSITE,RRXIEN,RRXDAT,RRXDNAME,RRXDNL,RRXQTY,RRXQTYL,RREFILLS,RRXDSUPP,RRXEXP,RRXISSDT,RRXISSDT1,RRXLFDT,RRXLFDT1,RRXDNSP,RRXQSP,REMSIEN,STAT,STATABBR
"RTN","PSOORUT1",70,0)
 I '$D(^TMP("PSOPF",$J)) S ^TMP("PSOPF",$J,1,0)="<No local prescriptions found.>",IEN=$G(IEN)+1
"RTN","PSOORUT1",71,0)
 ;S IEN=$G(IEN)+1,^TMP("PSOPF",$J,IEN,0)="-------------------------------------REMOTE-------------------------------------"
"RTN","PSOORUT1",72,0)
 S REMSITE=0 F  S REMSITE=$O(^XTMP("PSORRX1",$J,PSODFN,REMSITE)) Q:'REMSITE  D
"RTN","PSOORUT1",73,0)
 .I REMSITE=$G(DUZ(2)) Q
"RTN","PSOORUT1",74,0)
 .S REMSIEN=$O(^DIC(4,"D",REMSITE,0))
"RTN","PSOORUT1",75,0)
 .;S IEN=$G(IEN)+1,^TMP("PSOPF",$J,IEN,0)="----------------------"_$E($$GET1^DIQ(4,REMSIEN,.01,"E"),1,30)_" ("_REMSITE_")"_" "_STAT_" REMOTE---------------------"
"RTN","PSOORUT1",76,0)
 .;I $D(^XTMP("PSORRX1",$J,PSODFN,REMSITE,"ERR")) S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)=$G(^XTMP("PSORRX1",$J,PSODFN,REMSITE,"ERR")) Q
"RTN","PSOORUT1",77,0)
 .S STAT=0 F  S STAT=$O(^XTMP("PSORRX1",$J,PSODFN,REMSITE,STAT)) Q:STAT=""  D
"RTN","PSOORUT1",78,0)
 ..S STATABBR=$S(STAT="ACTIVE":"A",STAT="HOLD":"H",STAT="PROVIDER HOLD":"PH",STAT="SUSPENDED":"S",1:"")
"RTN","PSOORUT1",79,0)
 ..S IEN=$G(IEN)+1,^TMP("PSOPF",$J,IEN,0)="----------------------"_$E($$GET1^DIQ(4,REMSIEN,.01,"E"),1,30)_" ("_REMSITE_")"_$S(STAT="ERR":"",1:" "_STAT)_" REMOTE---------------------"
"RTN","PSOORUT1",80,0)
 ..I $D(^XTMP("PSORRX1",$J,PSODFN,REMSITE,"ERR")) S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)=$G(^XTMP("PSORRX1",$J,PSODFN,REMSITE,"ERR"))
"RTN","PSOORUT1",81,0)
 ..S RRXIEN=0 F  S RRXIEN=$O(^XTMP("PSORRX1",$J,PSODFN,REMSITE,STAT,RRXIEN)) Q:'RRXIEN  D
"RTN","PSOORUT1",82,0)
 ...;S IEN=$G(IEN)+1,^TMP("PSOPF",$J,IEN,0)="----------------------"_$E($$GET1^DIQ(4,REMSIEN,.01,"E"),1,30)_" ("_REMSITE_")"_" ACTIVE REMOTE---------------------"
"RTN","PSOORUT1",83,0)
 ...S RRXDAT=$G(^XTMP("PSORRX1",$J,PSODFN,REMSITE,STAT,RRXIEN,0))
"RTN","PSOORUT1",84,0)
 ...S RRXDNAME=$E($P(RRXDAT,U),1,35),RRXDNL=$L(RRXDNAME),RRXQTY=$P(RRXDAT,U,2),RRXQTYL=$L(RRXQTY),RREFILLS=$P(RRXDAT,U,3),RRXDSUPP=$P(RRXDAT,U,4),RRXEXP=$P(RRXDAT,U,5)
"RTN","PSOORUT1",85,0)
 ...S RRXISSDT=$P($P(RRXDAT,U,6),"."),RRXISSDT1=$E(RRXISSDT,5,6)_"-"_$E(RRXISSDT,7,8),RRXLFDT=$P($P(RRXDAT,U,8),"."),RRXLFDT1=$E(RRXLFDT,5,6)_"-"_$E(RRXLFDT,7,8)
"RTN","PSOORUT1",86,0)
 ...S IEN=$G(IEN)+1,PSOCNT=PSOCNT+1
"RTN","PSOORUT1",87,0)
 ...S RRXDNSP=""
"RTN","PSOORUT1",88,0)
 ...S RRXQSP=" "_STATABBR
"RTN","PSOORUT1",89,0)
 ...S $P(RRXDNSP," ",(39-RRXDNL))=""
"RTN","PSOORUT1",90,0)
 ...S $P(RRXQSP," ",(6-RRXQTYL))=""
"RTN","PSOORUT1",91,0)
 ...S ^TMP("PSOPF",$J,IEN,0)=$J(PSOCNT,2)_$S($L(PSOCNT)<3:" ",1:"")_RRXIEN_"        "_RRXDNAME_RRXDNSP_RRXQTY_RRXQSP_RRXISSDT1_" "_RRXLFDT1_"  "_RREFILLS_$S($L(RREFILLS)=1:"   ",$L(RREFILLS)=2:"  ",1:"")_RRXDSUPP 
"RTN","PSOORUT1",92,0)
 ...S PSORRLST(PSOCNT)=IEN
"RTN","PSOORUT1",93,0)
 ...; BWF/TODO - Need to specify this differently for remote rx's.
"RTN","PSOORUT1",94,0)
 ...S PSOLST(PSOCNT)="R52^"_RRXIEN_"^REMOTE"_U_REMSITE
"RTN","PSOORUT1",95,0)
 S (VALMCNT,PSOPF)=IEN
"RTN","PSOORUT1",96,0)
SHOWX K DIRUT,DTOUT,DUOUT,DIROUT,PSODRGS
"RTN","PSOORUT1",97,0)
 Q
"RTN","PSOORUT1",98,0)
 ;
"RTN","PSOORUT1",99,0)
DISPL S IEN=IEN+1 N PSOID,PSOCMOP,STATLTH,ECME
"RTN","PSOORUT1",100,0)
 K PSOLNT,PSOQTL,PSOLSP S PSOLRX=$S($G(^PSRX(+PSODATA,"IB")):13,1:14)-$L($P(^PSRX(+PSODATA,0),"^")),$P(PSOLNT," ",PSOLRX)=" ",PSODQL=$L($P(PSODRG,"^"))+$L($P(^PSRX(+PSODATA,0),"^",7))
"RTN","PSOORUT1",101,0)
 I PSODQL<39 S $P(PSOQTL," ",(40-PSODQL))=" "
"RTN","PSOORUT1",102,0)
 E  S $P(PSOQTL," ",(52-$L($P(^PSRX(+PSODATA,0),"^",7))))=" ",$P(PSOLSP," ",(41-$L($P(PSODRG,"^"))))=" "
"RTN","PSOORUT1",103,0)
 S ECME=$$ECME^PSOBPSUT(+PSODATA) I ECME'="" S PSOLNT=$E(PSOLNT,1,$L(PSOLNT)-1)
"RTN","PSOORUT1",104,0)
 S ^TMP("PSOPF",$J,IEN,0)=$J(PSOCNT,2)_$S($L(PSOCNT)<3:" ",1:"")_$P(^PSRX(+PSODATA,0),"^")_$S($G(^PSRX(+PSODATA,"IB")):"$",1:"")_ECME_PSOLNT_$P(PSODRG,"^")_$S(PSODQL<39:PSOQTL_$P(^PSRX(+PSODATA,0),"^",7)_" ",1:$G(PSOLSP))
"RTN","PSOORUT1",105,0)
 S STA="A^N^R^H^N^S^^^^^^E^DC^^DP^DE^HP^P^"
"RTN","PSOORUT1",106,0)
 S PSOCMOP=""
"RTN","PSOORUT1",107,0)
 I $D(^PSDRUG("AQ",$P(^PSRX(+PSODATA,0),"^",6))) S PSOCMOP=">"
"RTN","PSOORUT1",108,0)
 N X S X="PSXOPUTL" X ^%ZOSF("TEST") K X I $T D
"RTN","PSOORUT1",109,0)
 .N DA S DA=+PSODATA D ^PSXOPUTL K DA
"RTN","PSOORUT1",110,0)
 .I $G(PSXZ(PSXZ("L")))=0!($G(PSXZ(PSXZ("L")))=2) S PSOCMOP="T"
"RTN","PSOORUT1",111,0)
 .K PSXZ
"RTN","PSOORUT1",112,0)
 N PSOBADR
"RTN","PSOORUT1",113,0)
 S PSOBADR=$O(^PSRX(+PSODATA,"L",9999),-1)
"RTN","PSOORUT1",114,0)
 I PSOBADR'="" S PSOBADR=$G(^PSRX(+PSODATA,"L",PSOBADR,0)) I PSOBADR["(BAD ADDRESS)" S PSOBADR="B"
"RTN","PSOORUT1",115,0)
 I PSOBADR'="B" S PSOBADR=""
"RTN","PSOORUT1",116,0)
 S (STA,STATLTH)=$P(STA,"^",$P(PSODATA,"^",2)+1) D
"RTN","PSOORUT1",117,0)
 .I $G(^PSRX(+PSODATA,"DDSTA"))]"" S (STATLTH,STA)="DD" Q
"RTN","PSOORUT1",118,0)
 .S (STATLTH,STA)=$S($P($G(^PSRX(+PSODATA,7)),"^")=1:"DA",$P($G(^PSRX(+PSODATA,7)),"^")=2:"DF",1:STA)
"RTN","PSOORUT1",119,0)
 S STAPRT=STA_PSOCMOP_PSOBADR,STATLTH=$L(STAPRT)
"RTN","PSOORUT1",120,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_STAPRT_$S(STATLTH=0:"   ",STATLTH=1:"  ",STATLTH=2:" ",1:"")
"RTN","PSOORUT1",121,0)
 S PSOID=$P(^PSRX(+PSODATA,0),"^",13),PSOLF=+$G(^(3)),^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$E(PSOID,4,5)_"-"_$E(PSOID,6,7)_" "
"RTN","PSOORUT1",122,0)
 N RFLZRO,PSOLRD S PSOLRD=$P($G(^PSRX(+PSODATA,2)),"^",13)
"RTN","PSOORUT1",123,0)
 F PSOX=0:0 S PSOX=$O(^PSRX(+PSODATA,1,PSOX)) Q:'PSOX  D
"RTN","PSOORUT1",124,0)
 . S RFLZRO=$G(^PSRX(+PSODATA,1,PSOX,0))
"RTN","PSOORUT1",125,0)
 . I +RFLZRO=PSOLF,$P(RFLZRO,"^",16) S PSOLF=PSOLF_"^R"
"RTN","PSOORUT1",126,0)
 . S:$P(RFLZRO,"^",18)'="" PSOLRD=$P(RFLZRO,"^",18) I $P(RFLZRO,"^",16) S PSOLRD=PSOLRD_"^R"
"RTN","PSOORUT1",127,0)
 K PSOX
"RTN","PSOORUT1",128,0)
 I '$O(^PSRX(+PSODATA,1,0)),$P(^PSRX(+PSODATA,2),"^",15) S PSOLF=PSOLF_"^R",PSOLRD=PSOLRD_"^R"
"RTN","PSOORUT1",129,0)
 S PSOLF=$S($G(PSOLF):$E(PSOLF,4,5),1:"  ")_"-"_$S($G(PSOLF):$E(PSOLF,6,7),1:"  ")_$S($P(PSOLF,"^",2)="R":"R ",1:"  ")
"RTN","PSOORUT1",130,0)
 S PSOLRD=$S($G(PSOLRD):$E(PSOLRD,4,5),1:"  ")_"-"_$S($G(PSOLRD):$E(PSOLRD,6,7),1:"  ")_$S($P(PSOLRD,"^",2)="R":"R ",1:"  ")
"RTN","PSOORUT1",131,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$S($G(PSORFG):PSOLRD,1:PSOLF)
"RTN","PSOORUT1",132,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$J($P(PSODATA,"^",6),2)_" "_$J($P(PSODATA,"^",8),3)
"RTN","PSOORUT1",133,0)
 ;recently dc'd rxs
"RTN","PSOORUT1",134,0)
 I $P($G(^PSRX(+PSODATA,3)),"^",5) D  K X
"RTN","PSOORUT1",135,0)
 .S X2=$S($P(PSOPAR,"^",33):$P(PSOPAR,"^",33),1:7),X1=$P(^PSRX(+PSODATA,3),"^",5) D C^%DTC
"RTN","PSOORUT1",136,0)
 .I DT<X S PSODCREV(IEN)=IEN
"RTN","PSOORUT1",137,0)
 ;recently expired rxs
"RTN","PSOORUT1",138,0)
 I $P($G(^PSRX(+PSODATA,2)),"^",6)<DT,'$P($G(^PSRX(+PSODATA,3)),"^",5) D  K X
"RTN","PSOORUT1",139,0)
 .S X2=$S($P(PSOPAR,"^",33):$P(PSOPAR,"^",33),1:7),X1=$P(^PSRX(+PSODATA,2),"^",6) D C^%DTC
"RTN","PSOORUT1",140,0)
 .I DT<X S PSODCREV(IEN)=IEN
"RTN","PSOORUT1",141,0)
 ;
"RTN","PSOORUT1",142,0)
 I PSODQL>38 S IEN=IEN+1 S ^TMP("PSOPF",$J,IEN,0)=PSOQTL_"Qty: "_$P(^PSRX(+PSODATA,0),"^",7)
"RTN","PSOORUT1",143,0)
 K PSOLNT,PSOQTL,PSOLSP,PSOLRX,PSODQL
"RTN","PSOORUT1",144,0)
 S PSOLST(PSOCNT)="52^"_+PSODATA_"^"_PSOSTA
"RTN","PSOORUT1",145,0)
 K PSODATA,PSOLF S PSOPF=IEN
"RTN","PSOORUT1",146,0)
 Q
"RTN","PSOORUT1",147,0)
 ;
"RTN","PSOORUT1",148,0)
STA N LABEL,LINE,POS
"RTN","PSOORUT1",149,0)
 S LABEL=PSOSTS,IEN=IEN+1
"RTN","PSOORUT1",150,0)
 I PSOSTS="ZNONVA" S LABEL="Non-VA MEDS (Not dispensed by VA)"
"RTN","PSOORUT1",151,0)
 I PSOSTS=" REJECT" S LABEL="REFILL TOO SOON/DUR REJECTS (Third Party)"
"RTN","PSOORUT1",152,0)
 S POS=80-$L(LABEL)/2,$P(LINE,"-",81)="",$E(LINE,POS+1,POS+$L(LABEL))=LABEL
"RTN","PSOORUT1",153,0)
 S ^TMP("PSOPF",$J,IEN,0)=LINE
"RTN","PSOORUT1",154,0)
 Q
"RTN","PSOORUT1",155,0)
PENX S PSOLST(PSOCNT)="52.41^"_$P(PSODATA,"^",10)_"^"_PSOSTA
"RTN","PSOORUT1",156,0)
 K PSODATA,PSOLF,RN,PSOLSP,PSOQTL,PSOLNT
"RTN","PSOORUT1",157,0)
 Q
"RTN","PSOORUT1",158,0)
PEN ;
"RTN","PSOORUT1",159,0)
 N PSOQTL,PSOLNT,PSOLNTZ,PSOQTLX,PSCMOPF,SPACEZ
"RTN","PSOORUT1",160,0)
 Q:'$D(^PS(52.41,$P(PSODATA,"^",10),0))
"RTN","PSOORUT1",161,0)
 S PSCMOPF=0 I $P($G(PSODATA),"^",11),$D(^PSDRUG("AQ",$P(PSODATA,"^",11))) S PSCMOPF=1
"RTN","PSOORUT1",162,0)
 S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)=$J(PSOCNT,2)_$S($L(PSOCNT)<3:" ",1:"")_$P(PSODRG,"^")
"RTN","PSOORUT1",163,0)
 I $P($G(^PS(52.41,+$P(PSODATA,"^",10),0)),"^",23)=1 S ^TMP("PSOPF",$J,IEN,"RV")=""
"RTN","PSOORUT1",164,0)
 S PSOLNT=$L($P(PSODRG,"^")),PSOLNTZ=$L($P(PSODATA,"^",8))
"RTN","PSOORUT1",165,0)
 S $P(PSOQTLX," ",(11-PSOLNTZ))=" "
"RTN","PSOORUT1",166,0)
 S:PSOLNT<37 $P(PSOQTL," ",(37-PSOLNT))=" "
"RTN","PSOORUT1",167,0)
 I PSOLNT<38 D  G PENX
"RTN","PSOORUT1",168,0)
 .I PSOLNT=37 S PSOQTL=""
"RTN","PSOORUT1",169,0)
 .I $P(^PS(52.41,$P(PSODATA,"^",10),0),"^",3)="RF" S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$G(PSOQTL)_"  Refill Request   Rx #: "_$P(^PSRX($P(^PS(52.41,$P(PSODATA,"^",10),0),"^",19),0),"^") Q
"RTN","PSOORUT1",170,0)
 .S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$G(PSOQTL)_"  "_"QTY: "_$P(PSODATA,"^",8)_$G(PSOQTLX)_" ISDT: "_$S('$P(PSODATA,"^",9):"     ",1:$E($P(PSODATA,"^",9),4,5)_"-"_$E($P(PSODATA,"^",9),6,7))_$S($G(PSCMOPF):"> ",1:"  ")
"RTN","PSOORUT1",171,0)
 .S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_"REF: "_$S($L($P(PSODATA,"^",6))>1:"",1:" ")_$P(PSODATA,"^",6)
"RTN","PSOORUT1",172,0)
 S IEN=IEN+1,$P(SPACEZ," ",42)=" "
"RTN","PSOORUT1",173,0)
 I $P(^PS(52.41,$P(PSODATA,"^",10),0),"^",3)="RF" S ^TMP("PSOPF",$J,IEN,0)=SPACEZ_"Refill Request   Rx #: "_$P(^PSRX($P(^PS(52.41,$P(PSODATA,"^",10),0),"^",19),0),"^") G PENX
"RTN","PSOORUT1",174,0)
 S ^TMP("PSOPF",$J,IEN,0)=SPACEZ_"QTY: "_$P(PSODATA,"^",8)_$G(PSOQTLX)_" ISDT: "_$S('$P(PSODATA,"^",9):"     ",1:$E($P(PSODATA,"^",9),4,5)_"-"_$E($P(PSODATA,"^",9),6,7))_$S($G(PSCMOPF):"> ",1:"  ")_"REF: "_$S($L($P(PSODATA,"^",6))>1:"",1:" ")
"RTN","PSOORUT1",175,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$P(PSODATA,"^",6)
"RTN","PSOORUT1",176,0)
 G PENX
"RTN","PSOORUT1",177,0)
 ;
"RTN","PSOORUT1",178,0)
NVA ; Setting the Non-VA Meds on the Medication Profile Screen (ListMan)
"RTN","PSOORUT1",179,0)
 S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)="  "_$P(PSODRG,"^")_" "
"RTN","PSOORUT1",180,0)
 I ($L(^TMP("PSOPF",$J,IEN,0))+$L($P(PSODATA,"^",6))>70) S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)="    "
"RTN","PSOORUT1",181,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$P(PSODATA,"^",6)_" "
"RTN","PSOORUT1",182,0)
 I ($L(^TMP("PSOPF",$J,IEN,0))+$L($P(PSODATA,"^",8))>70) S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)="    "
"RTN","PSOORUT1",183,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$P(PSODATA,"^",8)
"RTN","PSOORUT1",184,0)
 I ($L(^TMP("PSOPF",$J,IEN,0))+20)>70 D  Q
"RTN","PSOORUT1",185,0)
 . S IEN=IEN+1,$P(^TMP("PSOPF",$J,IEN,0)," ",51)="Date Documented: "_$E($P(PSODATA,"^",9),4,5)_"/"_$E($P(PSODATA,"^",9),6,7)_"/"_$E($P(PSODATA,"^",9),2,3)
"RTN","PSOORUT1",186,0)
 F I=0:0 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_" " Q:$L(^TMP("PSOPF",$J,IEN,0))>49
"RTN","PSOORUT1",187,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_"Date Documented: "_$E($P(PSODATA,"^",9),4,5)_"/"_$E($P(PSODATA,"^",9),6,7)_"/"_$E($P(PSODATA,"^",9),2,3)
"RTN","PSOORUT1",188,0)
 Q
"RTN","PSOROS")
0^6^B793511
"RTN","PSOROS",1,0)
PSOROS ;BIRM/BWF - REMOTE RX UTILITY ; 1/24/2014
"RTN","PSOROS",2,0)
 ;;7.0;OUTPATIENT PHARMACY;;DEC 1997;Build 16
"RTN","PSOROS",3,0)
 Q
"RTN","PSOROS",4,0)
 ;
"RTN","PSOROS",5,0)
EN ; -- main entry point for PSO LM REMOTE ORDER SELECTION
"RTN","PSOROS",6,0)
 D EN^VALM("PSO LM REMOTE ORDER SELECTION")
"RTN","PSOROS",7,0)
 Q
"RTN","PSOROS",8,0)
 ;
"RTN","PSOROS",9,0)
HDR ; -- header code
"RTN","PSOROS",10,0)
 S VALMHDR(1)="This is a test header for PSO LM REMOTE ORDER SELECTION."
"RTN","PSOROS",11,0)
 S VALMHDR(2)="This is the second line"
"RTN","PSOROS",12,0)
 Q
"RTN","PSOROS",13,0)
 ;
"RTN","PSOROS",14,0)
INIT ; -- init variables and list array
"RTN","PSOROS",15,0)
 ;F LINE=1:1:30 D SET^VALM10(LINE,LINE_"     Line number "_LINE)
"RTN","PSOROS",16,0)
 ;S VALMCNT=30
"RTN","PSOROS",17,0)
 S $P(RN," ",12)=" ",VALMCNT=PSOPF
"RTN","PSOROS",18,0)
 S VALM("TITLE")="REMOTE OP Medications (ACTIVE)"
"RTN","PSOROS",19,0)
 D RV^PSONFI Q
"RTN","PSOROS",20,0)
 Q
"RTN","PSOROS",21,0)
 ;
"RTN","PSOROS",22,0)
HELP ; -- help code
"RTN","PSOROS",23,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOROS",24,0)
 Q
"RTN","PSOROS",25,0)
 ;
"RTN","PSOROS",26,0)
EXIT ; -- exit code
"RTN","PSOROS",27,0)
 Q
"RTN","PSOROS",28,0)
 ;
"RTN","PSOROS",29,0)
EXPND ; -- expand code
"RTN","PSOROS",30,0)
 Q
"RTN","PSOROS",31,0)
 ;
"RTN","PSORRD")
0^13^B373794
"RTN","PSORRD",1,0)
PSORRD ;SLC/BWF - Remote RX report details ;4/29/14 02:11PM
"RTN","PSORRD",2,0)
 ;;7.0;OUTPATIENT PHARMACY;;DEC 1997;Build 16
"RTN","PSORRD",3,0)
 ;
"RTN","PSORRD",4,0)
EN ; -- main entry point for PSO LM REMOTE REPORT DETAILS
"RTN","PSORRD",5,0)
 D EN^VALM("PSO LM REMOTE REPORT DETAILS")
"RTN","PSORRD",6,0)
 Q
"RTN","PSORRD",7,0)
 ;
"RTN","PSORRD",8,0)
HDR ; -- header code
"RTN","PSORRD",9,0)
 S VALMHDR(1)="Remote Refill/Partial Fill Details"
"RTN","PSORRD",10,0)
 Q
"RTN","PSORRD",11,0)
 ;
"RTN","PSORRD",12,0)
INIT ; -- init variables and list array
"RTN","PSORRD",13,0)
 S VALMCNT=PSORCNT
"RTN","PSORRD",14,0)
 Q
"RTN","PSORRD",15,0)
 ;
"RTN","PSORRD",16,0)
HELP ; -- help code
"RTN","PSORRD",17,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSORRD",18,0)
 Q
"RTN","PSORRD",19,0)
 ;
"RTN","PSORRD",20,0)
EXIT ; -- exit code
"RTN","PSORRD",21,0)
 S VALMBCK="R"
"RTN","PSORRD",22,0)
 Q
"RTN","PSORRD",23,0)
 ;
"RTN","PSORRD",24,0)
EXPND ; -- expand code
"RTN","PSORRD",25,0)
 Q
"RTN","PSORRD",26,0)
 ;
"RTN","PSORREF")
0^2^B32242585
"RTN","PSORREF",1,0)
PSORREF ;ALB/BWF - Remote RX retrieval API ;12/3/2013 2:51pm
"RTN","PSORREF",2,0)
 ;;7.0;OUTPATIENT PHARMACY;;DEC 1997;Build 16
"RTN","PSORREF",3,0)
 Q
"RTN","PSORREF",4,0)
 ; RET    - return data
"RTN","PSORREF",5,0)
 ; RXNUM  - RX Number from remote system
"RTN","PSORREF",6,0)
 ; FDATE  - Fill Date
"RTN","PSORREF",7,0)
 ; MW     - Mail/Window - Default of 'W' for now.
"RTN","PSORREF",8,0)
 ; RPHARM - Pharmacist from remote site
"RTN","PSORREF",9,0)
 ; RPHONE - Contact number
"RTN","PSORREF",10,0)
 ; RSITE  - Filling site number
"RTN","PSORREF",11,0)
 ;
"RTN","PSORREF",12,0)
REMREF(RET,RXNUM,FDATE,MW,RPHARM,RPHONE,RSITE) ;
"RTN","PSORREF",13,0)
 ;
"RTN","PSORREF",14,0)
 N MSG,BACK,PSOPAR,RRXIEN,PSOSIEN,DSUPP,LASTREF,XTMPLOC,PASSLOC,HFSIEN,FULLPTH,HFSDONE,PTHDAT,PTHPIECE,FOUND,STRT,STATION
"RTN","PSORREF",15,0)
 ; check 3rd party payer rejects. Send message to initiating site if applicable.
"RTN","PSORREF",16,0)
 S $ETRAP="D ^%ZTER Q"
"RTN","PSORREF",17,0)
 S RET(0)=""
"RTN","PSORREF",18,0)
 S RRXIEN=$O(^PSRX("B",RXNUM,0)),PSOSIEN=$$GET1^DIQ(52,RRXIEN,20,"I")
"RTN","PSORREF",19,0)
 S PSOPAR=$G(^PS(59,PSOSIEN,1)),PSOSITE=PSOSIEN
"RTN","PSORREF",20,0)
 S RPHONE=$G(RPHONE,"")
"RTN","PSORREF",21,0)
 ; check to see if this action will throw the prescription into suspense. If so, quit and return a message
"RTN","PSORREF",22,0)
 S DSUPP=$$GET1^DIQ(52,RRXIEN,8,"I")
"RTN","PSORREF",23,0)
 S LASTREF=$O(^PSRX(RRXIEN,1,"B",""),-1)
"RTN","PSORREF",24,0)
 I $$FMADD^XLFDT(LASTREF,DSUPP)>DT D RET0 S RET(1)="Cannot refill. This action will put originating RX into suspense." Q
"RTN","PSORREF",25,0)
 S X2=-120,X1=DT D C^%DTC S PSODTCUT=X
"RTN","PSORREF",26,0)
 S (PSODFN,PSOREF("PSODFN"))=$$GET1^DIQ(52,RRXIEN,2,"I") K PSOSD D ^PSOBUILD
"RTN","PSORREF",27,0)
 I $$LMREJ^PSOREJU1(RXNUM,,.MSG,.BACK) S RET(1)=MSG D RET0 Q
"RTN","PSORREF",28,0)
 ;S PSORX("FILL DATE")=FDATE
"RTN","PSORREF",29,0)
 ;todo - may need to pull this when medication API initially grabs the rx, so remote site will know if any of the following apply.
"RTN","PSORREF",30,0)
 ;I $D(RXRP(RXNUM)) S VALMBCK="",VALMSG="A Reprint Label has been requested!" Q
"RTN","PSORREF",31,0)
 ;I $D(RXPR(RXNUM)) S VALMBCK="",VALMSG="A Partial has already been requested!" Q
"RTN","PSORREF",32,0)
 ;I $D(RXRS(RXNUM)) S VALMBCK="",VALMSG="Rx is being pulled from suspense!" Q
"RTN","PSORREF",33,0)
 ;I $D(RXFL(RXNUM)) S PTRX=RXNUM D ^PSOCMOPT I '$G(PSOXFLAG) K PSOXFLAG S VALMBCK="",VALMSG="Fill already requested for CMOP!" Q
"RTN","PSORREF",34,0)
 ;K PSOXFLAG
"RTN","PSORREF",35,0)
 D PSOL^PSSLOCK(RRXIEN) I '$G(PSOMSG) S RET(1)=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order.") D RET0 K PSOMSG Q
"RTN","PSORREF",36,0)
 ;N RXN K PSORX("FILL DATE") D FULL^VALM1 S:$G(PSOFROM)'="NEW" PSOFROM="REFILL" S PSOREF("DFLG")=0,PSOREF("IRXN")=RXNUM,PSOREF("QFLG")=0
"RTN","PSORREF",37,0)
 N RXN K PSORX("FILL DATE") S PSOFROM="REFILL" S PSOREF("DFLG")=0,PSOREF("IRXN")=$O(^PSRX("B",RXNUM,0)),PSOREF("QFLG")=0
"RTN","PSORREF",38,0)
 ; TODO - the next line may be able to be removed. Prompting for data, however we are getting past it somehow.
"RTN","PSORREF",39,0)
 S PSORX("FILL DATE")=FDATE
"RTN","PSORREF",40,0)
 K PSOID D ^PSORREF1 I PSOREF("DFLG") D EOJ Q
"RTN","PSORREF",41,0)
 D PROCESS^PSORREF0(.RET)
"RTN","PSORREF",42,0)
 ; TODO - see if we need to make use of either PSOBUILD or ACT^PSOORNE2 for any reason - doubtful at this point, since it is the building mechanism for List Manager.
"RTN","PSORREF",43,0)
 ;W ! K DIR,DIRUT,DTOUT,DUOUT S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DIRUT,DTOUT,DUOUT S PSORXED=1 D ^PSOBUILD,ACT^PSOORNE2 K PSORXED S VALMBCK="Q" D EOJ
"RTN","PSORREF",44,0)
 I '$D(RET(1)) D
"RTN","PSORREF",45,0)
 .; bwf 8/14/14 - set up needed variables for label printing
"RTN","PSORREF",46,0)
 .S PSODFN=$P(^PSRX(RRXIEN,0),U,2)
"RTN","PSORREF",47,0)
 .S PSORX("PSOL",1)=RRXIEN_","
"RTN","PSORREF",48,0)
 .S PSORX("MAIL/WINDOW")="WINDOW"
"RTN","PSORREF",49,0)
 .S PSORX("NAME")=$$GET1^DIQ(2,PSODFN,.01)
"RTN","PSORREF",50,0)
 .S PSORX("QFLG")=0
"RTN","PSORREF",51,0)
 .S PSORX("METHOD OF PICKUP")=""
"RTN","PSORREF",52,0)
 .S PSOX=$G(^PS(55,PSODFN,"PS")) I PSOX]"" S PSORX("PATIENT STATUS")=$P($G(^PS(53,PSOX,0)),"^")
"RTN","PSORREF",53,0)
 .S PPL1=RRXIEN
"RTN","PSORREF",54,0)
 .; bwf 8/14/14 - end setup for label printing.
"RTN","PSORREF",55,0)
 .; call out to generate label
"RTN","PSORREF",56,0)
 .S HFSIEN=$O(^%ZIS(1,"B","HFS",0)) I 'HFSIEN Q
"RTN","PSORREF",57,0)
 .S FULLPTH=$$GET1^DIQ(3.5,HFSIEN,1,"I")
"RTN","PSORREF",58,0)
 .S HFSDONE=0,PTHDAT=""
"RTN","PSORREF",59,0)
 .F I=1:1 D  Q:HFSDONE
"RTN","PSORREF",60,0)
 ..S PTHPIECE=$P(FULLPTH,"\",I) Q:'$L(PTHPIECE)
"RTN","PSORREF",61,0)
 ..I PTHPIECE["." S PTHFILE=PTHPIECE,HFSDONE=1 Q
"RTN","PSORREF",62,0)
 ..I '$L(PTHDAT) S PTHDAT=PTHPIECE Q
"RTN","PSORREF",63,0)
 ..S PTHDAT=$G(PTHDAT)_"\"_PTHPIECE
"RTN","PSORREF",64,0)
 .;
"RTN","PSORREF",65,0)
 .; lets make the file as unique as possible so it will not be over-written.
"RTN","PSORREF",66,0)
 .S $P(PTHFILE,".")=$P(PTHFILE,".")_"_"_RXNUM_"_"_DT
"RTN","PSORREF",67,0)
 .D LABEL^PSOCPTRI(RRXIEN,"HFS",PSOSITE,DUZ)
"RTN","PSORREF",68,0)
 .S SITENUM=DUZ(2),STATION=$$STA^XUAF4(SITENUM)
"RTN","PSORREF",69,0)
 .; end temp code - remove when in an appropriate environment
"RTN","PSORREF",70,0)
 .S XTMPLOC="^XTMP(""PSORLBL"","_STATION_","_RXNUM_",1,0)"
"RTN","PSORREF",71,0)
 .S PASSLOC="XTMP(""PSORLBL"","_STATION_","_RXNUM_")"
"RTN","PSORREF",72,0)
 .S ^XTMP("PSORLBL",STATION,RXNUM,0)=DT_U_$$FMADD^XLFDT(DT,30)
"RTN","PSORREF",73,0)
 .; looks like we have to wait a moment before the file shows up.
"RTN","PSORREF",74,0)
 .S STRT=$$NOW^XLFDT,FOUND=0
"RTN","PSORREF",75,0)
 .F  D  Q:$$NOW^XLFDT>$$FMADD^XLFDT(STRT,,,1)!(FOUND)
"RTN","PSORREF",76,0)
 ..S FTGOPEN=$$FTG^%ZISH("C:\TEMP\","TMP.DAT",XTMPLOC,4)
"RTN","PSORREF",77,0)
 ..;D FTG^%ZISH(PTHDAT,PTHFILE,XTMPLOC,3)
"RTN","PSORREF",78,0)
 ..;I FTGOPEN S FOUND=1
"RTN","PSORREF",79,0)
 ..I $O(^XTMP("PSORLBL",STATION,RXNUM,0)) S FOUND=1
"RTN","PSORREF",80,0)
 .D UPDREF(.RET,RRXIEN,RPHARM,RPHONE,RSITE,PASSLOC)
"RTN","PSORREF",81,0)
 .S RET(1)="Rx # "_RXNUM_" refilled."
"RTN","PSORREF",82,0)
 D EOJ
"RTN","PSORREF",83,0)
 Q
"RTN","PSORREF",84,0)
EOJ ;
"RTN","PSORREF",85,0)
 D RET0
"RTN","PSORREF",86,0)
 K PSOMSG,PSOREF,PSORX("BAR CODE"),PSOLIST,LFD,MAX,MIN,NODE,PS,PSOERR,REF,RF,RXO,RXN,RXP,RXS,SD,VAERR,PSORX("FILL DATE")
"RTN","PSORREF",87,0)
 D PSOUL^PSSLOCK(RXNUM)
"RTN","PSORREF",88,0)
 Q
"RTN","PSORREF",89,0)
 ; build ret(0) if needed
"RTN","PSORREF",90,0)
RET0 ;
"RTN","PSORREF",91,0)
 I '$L(RET(0)) S RET(0)=0_U_RXNUM_U_RRXIEN_U_U_FDATE,$P(RET(0),U,15)=$G(RPHARM),$P(RET(0),U,16)=$G(RPHONE),$P(RET(0),U,17)=$G(RSITE)
"RTN","PSORREF",92,0)
 Q
"RTN","PSORREF",93,0)
 ;
"RTN","PSORREF",94,0)
ULK D PSOUL^PSSLOCK(RXNUM)
"RTN","PSORREF",95,0)
 Q
"RTN","PSORREF",96,0)
 ; successful refill. Update data, and build response
"RTN","PSORREF",97,0)
UPDREF(PSOMSG,PSOIEN,RPHARM,RPHONE,RSITE,PASSLOC) ;
"RTN","PSORREF",98,0)
 N REFIEN,REFIENS,REFDATA,FIL,RXNUM,RFILLDT,QTY,DSUPP,CLERK,LOGDATE,IDIV,EDIV,DISPDT,NDC,FDA,DNAME,DIEN,DAT
"RTN","PSORREF",99,0)
 S FIL=52.1
"RTN","PSORREF",100,0)
 ; get last refill data node
"RTN","PSORREF",101,0)
 S REFIEN=$O(^PSRX(PSOIEN,1,"B",DT,""),-1)
"RTN","PSORREF",102,0)
 S RXNUM=$$GET1^DIQ(52,PSOIEN,.01,"E")
"RTN","PSORREF",103,0)
 S DNAME=$$GET1^DIQ(52,PSOIEN,6,"E")
"RTN","PSORREF",104,0)
 S DIEN=$$GET1^DIQ(52,PSOIEN,6,"I")
"RTN","PSORREF",105,0)
 S REFIENS=REFIEN_","_PSOIEN_","
"RTN","PSORREF",106,0)
 ; first, set in the remote pharmacist data
"RTN","PSORREF",107,0)
 S FDA(FIL,REFIENS,91)=RSITE
"RTN","PSORREF",108,0)
 S FDA(FIL,REFIENS,92)=RPHARM
"RTN","PSORREF",109,0)
 S FDA(FIL,REFIENS,93)=RPHONE
"RTN","PSORREF",110,0)
 D FILE^DIE(,"FDA") K FDA
"RTN","PSORREF",111,0)
 ;D LOGEVNT(PSOIEN,RPHARM,RPHONE,RSITE)
"RTN","PSORREF",112,0)
 ;S DAT="^^"_RXNUM_U_RSITE_
"RTN","PSORREF",113,0)
 ; now query data and build RET(0) holding accurate information from the refill multiple
"RTN","PSORREF",114,0)
 D GETS^DIQ(FIL,REFIENS,"**","IE","REFDATA")
"RTN","PSORREF",115,0)
 S RFILLDT=$G(REFDATA(FIL,REFIENS,.01,"I"))
"RTN","PSORREF",116,0)
 S QTY=$G(REFDATA(FIL,REFIENS,1,"I"))
"RTN","PSORREF",117,0)
 S DSUPP=$G(REFDATA(FIL,REFIENS,1.1,"I"))
"RTN","PSORREF",118,0)
 S CLERK=$G(REFDATA(FIL,REFIENS,6,"E"))
"RTN","PSORREF",119,0)
 S LOGDATE=$G(REFDATA(FIL,REFIENS,7,"I"))
"RTN","PSORREF",120,0)
 ; internal division number (IEN to PSO SITE file)
"RTN","PSORREF",121,0)
 S IDIV=$G(REFDATA(FIL,REFIENS,8,"I"))
"RTN","PSORREF",122,0)
 S EDIV=$G(REFDATA(FIL,REFIENS,8,"E"))
"RTN","PSORREF",123,0)
 S DISPDT=$G(REFDATA(FIL,REFIENS,10.1,"I"))
"RTN","PSORREF",124,0)
 S NDC=$G(REFDATA(FIL,REFIENS,11,"E"))
"RTN","PSORREF",125,0)
 S RSITE=$G(REFDATA(FIL,REFIENS,91,"I"))
"RTN","PSORREF",126,0)
 S RPHARM=$G(REFDATA(FIL,REFIENS,92,"E"))
"RTN","PSORREF",127,0)
 S RPHONE=$G(REFDATA(FIL,REFIENS,93,"E"))
"RTN","PSORREF",128,0)
 S $P(DAT(1),U,3)=RXNUM,$P(DAT(1),U,4)=RSITE,$P(DAT(1),U,7)=QTY,$P(DAT(1),U,8)=DISPDT,$P(DAT(1),U,9)=DNAME,$P(DAT(1),U,10)=DSUPP,$P(DAT(1),U,11)=RPHARM D LOGDATA^PSORRX1($NA(DAT),"OR")
"RTN","PSORREF",129,0)
 S PSOMSG(0)=1_U_RXNUM_U_PSOIEN_U_REFIEN_U_RFILLDT_U_DNAME_U_QTY_U_DSUPP_U_CLERK_U_LOGDATE_U_IDIV_U_EDIV_U_DISPDT_U_NDC_U_RPHARM_U_RPHONE_U_RSITE_U_PASSLOC
"RTN","PSORREF",130,0)
 Q
"RTN","PSORREF",131,0)
LOGEVNT(PSOIEN,PHARM,PHONE,RSITE) ;
"RTN","PSORREF",132,0)
 Q
"RTN","PSORREF0")
0^3^B50210673
"RTN","PSORREF0",1,0)
PSORREF0 ;ALB/BWF - Remote RX refill API ;2/10/2013 12:25pm
"RTN","PSORREF0",2,0)
 ;;7.0;OUTPATIENT PHARMACY;;DEC 1997;Build 16
"RTN","PSORREF0",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSORREF0",4,0)
 ;
"RTN","PSORREF0",5,0)
 ;PSO*186 add check for DEA Special handling field refill restrictions
"RTN","PSORREF0",6,0)
 Q
"RTN","PSORREF0",7,0)
PROCESS(PSORMSG) ;
"RTN","PSORREF0",8,0)
 K PSODF S PSOREF("RX0")=^PSRX(PSOREF("IRXN"),0),PSOREF("RX2")=^(2),PSOREF("RX3")=^(3),PSOREF("STA")=+$G(^("STA")),PSOREF("SIG")=$P($G(^("SIG")),"^"),PSOREF("PSODFN")=$P(PSOREF("RX0"),"^",2)
"RTN","PSORREF0",9,0)
 S PSOREF("DAYS SUPPLY")=$P(PSOREF("RX0"),"^",8)
"RTN","PSORREF0",10,0)
 ; bwf 3/17/2014 removing bar code and new patient logic for remote fills
"RTN","PSORREF0",11,0)
 ;I $D(PSORX("BAR CODE")),PSODFN'=PSOREF("PSODFN") D NEWPT
"RTN","PSORREF0",12,0)
 ;W !,"Now refilling Rx# ",$P(PSOREF("RX0"),"^")_"   Drug: "_$P(^PSDRUG($P(PSOREF("RX0"),"^",6),0),"^")
"RTN","PSORREF0",13,0)
 K ZD(PSOREF("IRXN"))   ;*306
"RTN","PSORREF0",14,0)
 S PSOREF("DFLG")=0 D DSPLY G:PSOREF("DFLG") PROCESSX
"RTN","PSORREF0",15,0)
 D CHECK G:$G(PSODF) PROCESS G:PSOREF("DFLG") PROCESSX D EN^PSOR52(.PSOREF)
"RTN","PSORREF0",16,0)
 ; BWF 2/11/2014 removed following line for remote fill. do not utilize bingo board when refilling remotely (for now)
"RTN","PSORREF0",17,0)
 ;S:$G(PSOREF("MAIL/WINDOW"))["W" BINGRTE="W",BINGCRT=1
"RTN","PSORREF0",18,0)
PROCESSX D:$G(PSOREF("OLD FILL DATE"))]"" SUSDATEK^PSOUTIL(.PSOREF)
"RTN","PSORREF0",19,0)
 Q
"RTN","PSORREF0",20,0)
DSPLY ;W !!,$P(PSOREF("RX0"),"^"),?12," ",$P(^PSDRUG($P(PSOREF("RX0"),"^",6),0),"^"),?45," SIG: "_PSOREF("SIG"),?60," QTY: ",$P(PSOREF("RX0"),"^",7)
"RTN","PSORREF0",21,0)
 K FSIG,BSIG I $P($G(^PSRX(PSOREF("IRXN"),"SIG")),"^",2) D FSIG^PSOUTLA("R",PSOREF("IRXN"),54) F PSREV=1:1 Q:'$D(FSIG(PSREV))  S BSIG(PSREV)=FSIG(PSREV)
"RTN","PSORREF0",22,0)
 K FSIG,PSREV I '$P($G(^PSRX(PSOREF("IRXN"),"SIG")),"^",2) D EN2^PSOUTLA1(PSOREF("IRXN"),54)
"RTN","PSORREF0",23,0)
 ;W !!,"Qty: ",$P(PSOREF("RX0"),"^",7),?19,"Sig: ",$G(BSIG(1))
"RTN","PSORREF0",24,0)
 I $O(BSIG(1)) F PSREV=1:0 S PSREV=$O(BSIG(PSREV)) Q:'PSREV  W !?24,$G(BSIG(PSREV))
"RTN","PSORREF0",25,0)
 K BSIG,PSREV
"RTN","PSORREF0",26,0)
DSPLYX Q
"RTN","PSORREF0",27,0)
CHECK ;
"RTN","PSORREF0",28,0)
 I '$P(PSOPAR,"^",11),$G(^PSDRUG($P(PSOREF("RX0"),"^",6),"I"))]"",DT>$G(^("I")) D  G CKQ
"RTN","PSORREF0",29,0)
 .S PSORMSG(1)=" *** Drug is inactive for Rx # "_$P(PSOREF("RX0"),"^")_" cannot be refilled ***"
"RTN","PSORREF0",30,0)
 .;W $C(7),!!," *** Drug is inactive for Rx # "_$P(PSOREF("RX0"),"^")_" cannot be refilled ***",!
"RTN","PSORREF0",31,0)
 ; bwf 3/17/14 replacing line below with the one that follows
"RTN","PSORREF0",32,0)
 ;I '$D(PSORX("BAR CODE")),PSOREF("PSODFN")'=PSODFN S PSORMSG="Can't refill Rx # "_$P(PSOREF("RX0"),"^")_", it is not for this patient." G CKQ
"RTN","PSORREF0",33,0)
 I PSOREF("PSODFN")'=PSODFN S PSORMSG="Can't refill Rx # "_$P(PSOREF("RX0"),"^")_", it is not for this patient." G CKQ
"RTN","PSORREF0",34,0)
 ;I '$D(PSORX("BAR CODE")),PSOREF("PSODFN")'=PSODFN W !!,?5,$C(7),"Can't refill Rx # "_$P(PSOREF("RX0"),"^")_", it is not for this patient." G CKQ
"RTN","PSORREF0",35,0)
 S (PSOX,PSOY,STA)=""
"RTN","PSORREF0",36,0)
 I $G(PSOSD) F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S PSOX=$O(PSOSD(STA,PSOX)) Q:PSOX']""!(PSOREF("DFLG"))  I PSOREF("IRXN")=+PSOSD(STA,PSOX) S PSOY=PSOSD(STA,PSOX) I $P(PSOY,"^",4)]"" D
"RTN","PSORREF0",37,0)
 . S PSOREF("DFLG")=1 S:'$G(PSOERR) PSORMSG(1)="Cannot refill Rx # "_$P(PSOREF("RX0"),"^") S PSOREA=$P(PSOY,"^",4),PSOSTAT=PSOREF("STA")
"RTN","PSORREF0",38,0)
 . ;S PSOREF("DFLG")=1 W:'$G(PSOERR) !,$C(7),"Cannot refill Rx # "_$P(PSOREF("RX0"),"^") S PSOREA=$P(PSOY,"^",4),PSOSTAT=PSOREF("STA")
"RTN","PSORREF0",39,0)
 . D STATUS^PSOUTIL(PSOREA,PSOSTAT) K PSOREA,PSOSTAT
"RTN","PSORREF0",40,0)
 . Q
"RTN","PSORREF0",41,0)
 ;I PSOY="" W !,$C(7),"Cannot refill, Rx is discontinued or expired.  Later Rx may exist.",! D  I $G(PSODF) Q
"RTN","PSORREF0",42,0)
 I PSOY="" S PSORMSG(1)="Cannot refill, Rx is discontinued or expired.  Later Rx may exist." D  I $G(PSODF) Q
"RTN","PSORREF0",43,0)
 .; TODO - need a new API for the following call BWF 2/11/2014
"RTN","PSORREF0",44,0)
 .D LOOK^PSOREF2 I $G(PSODF) Q
"RTN","PSORREF0",45,0)
 .S PSOREF("DFLG")=1
"RTN","PSORREF0",46,0)
 K PSOX,PSOY G:PSOREF("DFLG") CHECKX
"RTN","PSORREF0",47,0)
 I $O(^PS(52.5,"B",PSOREF("IRXN"),0)),'$G(^PS(52.5,+$O(^PS(52.5,"B",PSOREF("IRXN"),0)),"P")) S PSORMSG(1)="Rx is in suspense and cannot be refilled" S PSOREF("DFLG")=1 G CHECKX
"RTN","PSORREF0",48,0)
 ;I $O(^PS(52.5,"B",PSOREF("IRXN"),0)),'$G(^PS(52.5,+$O(^PS(52.5,"B",PSOREF("IRXN"),0)),"P")) W !,$C(7),"Rx is in suspense and cannot be refilled" S PSOREF("DFLG")=1 G CHECKX
"RTN","PSORREF0",49,0)
 ;
"RTN","PSORREF0",50,0)
 S PSOREF("RXSTATUS")=PSOREF("STA")
"RTN","PSORREF0",51,0)
 I PSOREF("RXSTATUS"),PSOREF("RXSTATUS")'=6 D  G CHECKX
"RTN","PSORREF0",52,0)
 . S PSOY=";"_PSOREF("RXSTATUS"),PSOX=$P(^DD(52,100,0),"^",3),PSOY=$F(PSOX,PSOY),PSOY=$P($E(PSOX,PSOY,999),";",1)
"RTN","PSORREF0",53,0)
 . S PSORMSG(1)="Rx is in "_PSOY_" status, cannot be refilled" S PSOREF("DFLG")=1
"RTN","PSORREF0",54,0)
 . ;W !,$C(7),"Rx is in "_PSOY_" status, cannot be refilled" S PSOREF("DFLG")=1
"RTN","PSORREF0",55,0)
 D CHKDIV G:PSOREF("DFLG") CHECKX
"RTN","PSORREF0",56,0)
 D NUMBER I PSOREF("NUMBER")>$P(PSOREF("RX0"),"^",9) S PSORMSG(1)="Can't refill, no refills remaining." S PSOREF("DFLG")=1 G CHECKX
"RTN","PSORREF0",57,0)
 ;D NUMBER I PSOREF("NUMBER")>$P(PSOREF("RX0"),"^",9) W !?5,"Can't refill, no refills remaining." S PSOREF("DFLG")=1 G CHECKX
"RTN","PSORREF0",58,0)
 ;
"RTN","PSORREF0",59,0)
 ;PSO*7*186  check DEA, SPEC HNDLG field, in case changed, and apply
"RTN","PSORREF0",60,0)
 N PSODRG,PSODEA,PSODAY
"RTN","PSORREF0",61,0)
 S PSODRG=$G(^PSDRUG($P(PSOREF("RX0"),U,6),0)),PSODEA=$P(PSODRG,U,3)
"RTN","PSORREF0",62,0)
 S PSODAY=$P(PSOREF("RX0"),U,8)
"RTN","PSORREF0",63,0)
 I $$DEACHK^PSOUTLA1(PSOREF("IRXN"),PSODEA,PSODAY) D  G CHECKX
"RTN","PSORREF0",64,0)
 . S PSORMSG(1)="This drug has been changed, No refills allowed"
"RTN","PSORREF0",65,0)
 . ;W $C(7),!!,"This drug has been changed, No refills allowed",!
"RTN","PSORREF0",66,0)
 . S PSOREF("DFLG")=1
"RTN","PSORREF0",67,0)
 ;
"RTN","PSORREF0",68,0)
 D DATES
"RTN","PSORREF0",69,0)
CHECKX Q
"RTN","PSORREF0",70,0)
CKQ ;
"RTN","PSORREF0",71,0)
 S PSOREF("DFLG")=1 D PAUSE^VALM1 G CHECKX
"RTN","PSORREF0",72,0)
 Q
"RTN","PSORREF0",73,0)
 ;
"RTN","PSORREF0",74,0)
CHKDIV G:$P(PSOREF("RX2"),"^",9)=+PSOSITE CHKDIVX
"RTN","PSORREF0",75,0)
 ;W !?5,$C(7),"RX # ",$P(PSOREF("RX0"),"^")," is for (",$P(^PS(59,$P(PSOREF("RX2"),"^",9),0),"^"),") division."
"RTN","PSORREF0",76,0)
 S PSORMSG(1)="RX # "_$P(PSOREF("RX0"),"^")_" is for ("_$P(^PS(59,$P(PSOREF("RX2"),"^",9),0),"^")_") division."
"RTN","PSORREF0",77,0)
 I '$P($G(PSOSYS),"^",2) S (PSOREF("DFLG"),PSOMHV)=1 W !,"********* Not Refilled *********" G CHKDIVX
"RTN","PSORREF0",78,0)
 D:$P($G(PSOSYS),"^",3) DIR
"RTN","PSORREF0",79,0)
CHKDIVX Q
"RTN","PSORREF0",80,0)
 ;
"RTN","PSORREF0",81,0)
NUMBER K PSOX,PSOY S PSOREF("# OF REFILLS")=0
"RTN","PSORREF0",82,0)
 I $G(^PSRX(PSOREF("IRXN"),1,0))]"" F PSOX=0:0 S PSOX=$O(^PSRX(PSOREF("IRXN"),1,PSOX)) Q:'PSOX  S PSOREF("# OF REFILLS")=PSOX
"RTN","PSORREF0",83,0)
 S PSOREF("NUMBER")=PSOREF("# OF REFILLS")+1
"RTN","PSORREF0",84,0)
 Q
"RTN","PSORREF0",85,0)
 ;
"RTN","PSORREF0",86,0)
DATES S PSOREF("STOP DATE")=$P(PSOREF("RX2"),"^",6) D NEXT^PSOUTIL(.PSOREF)
"RTN","PSORREF0",87,0)
 D:$G(PSOBBC("QFLG"))&($P(PSOPAR,"^",6)) EDATE Q:$G(PSOREF("DFLG"))
"RTN","PSORREF0",88,0)
 S PSOREF("FILL DATE")=$S($G(PSOREF("FILL DATE")):PSOREF("FILL DATE"),1:DT)
"RTN","PSORREF0",89,0)
 I $P(PSOPAR,"^",6),PSOREF("FILL DATE")<$P(PSOREF("RX3"),"^",2) D SUSDATE^PSOUTIL(.PSOREF)
"RTN","PSORREF0",90,0)
 ;
"RTN","PSORREF0",91,0)
 I PSOREF("FILL DATE")>PSOREF("STOP DATE") D
"RTN","PSORREF0",92,0)
 . S PSORMSG(1)="Can't refill, Refill Date "_$E(PSOREF("FILL DATE"),4,5)_"/"_$E(PSOREF("FILL DATE"),6,7)_"/"
"RTN","PSORREF0",93,0)
 . S PSORMSG(2)=$E(PSOREF("FILL DATE"),2,3)_" is past Expiration Date "_$E(PSOREF("STOP DATE"),4,5)_"/"_$E(PSOREF("STOP DATE"),6,7)_"/"
"RTN","PSORREF0",94,0)
 . S PSORMSG(3)=$E(PSOREF("STOP DATE"),2,3) S PSOREF("DFLG")=1
"RTN","PSORREF0",95,0)
 . ;W !!?5,$C(7),"Can't refill, Refill Date ",$E(PSOREF("FILL DATE"),4,5),"/",$E(PSOREF("FILL DATE"),6,7),"/"
"RTN","PSORREF0",96,0)
 . ;W $E(PSOREF("FILL DATE"),2,3)," is past Expiration Date ",$E(PSOREF("STOP DATE"),4,5),"/",$E(PSOREF("STOP DATE"),6,7),"/"
"RTN","PSORREF0",97,0)
 . ;W $E(PSOREF("STOP DATE"),2,3) S PSOREF("DFLG")=1
"RTN","PSORREF0",98,0)
EDATE S PSOREF("LAST REFILL DATE")=$P(PSOREF("RX3"),"^",1)
"RTN","PSORREF0",99,0)
 I PSOREF("LAST REFILL DATE"),PSOREF("FILL DATE")=PSOREF("LAST REFILL DATE") D  G DATESX
"RTN","PSORREF0",100,0)
 . ;W !?5,"Can't refill, Fill Date already exists for ",$E(PSOREF("FILL DATE"),4,5),"/",$E(PSOREF("FILL DATE"),6,7),"/",$E(PSOREF("FILL DATE"),2,3)
"RTN","PSORREF0",101,0)
 . S PSORMSG(1)="Can't refill, Fill Date already exists for "_$E(PSOREF("FILL DATE"),4,5)_"/"_$E(PSOREF("FILL DATE"),6,7)_"/"_$E(PSOREF("FILL DATE"),2,3)
"RTN","PSORREF0",102,0)
 . S PSOREF("DFLG")=1
"RTN","PSORREF0",103,0)
 I PSOREF("LAST REFILL DATE"),PSOREF("FILL DATE")<PSOREF("LAST REFILL DATE") D  G DATESX
"RTN","PSORREF0",104,0)
 . ;W !?5,"Can't refill, later Refill Date already exists for ",$E(PSOREF("LAST REFILL DATE"),4,5),"/",$E(PSOREF("LAST REFILL DATE"),6,7),"/",$E(PSOREF("LAST REFILL DATE"),2,3)
"RTN","PSORREF0",105,0)
 . S PSORMSG(1)="Can't refill, later Refill Date already exists for "_$E(PSOREF("LAST REFILL DATE"),4,5)_"/"_$E(PSOREF("LAST REFILL DATE"),6,7)_"/"_$E(PSOREF("LAST REFILL DATE"),2,3)
"RTN","PSORREF0",106,0)
 . S PSOREF("DFLG")=1
"RTN","PSORREF0",107,0)
 I '$P(PSOPAR,"^",6),'$D(PSOREF("EAOK")),$P(PSOREF("RX3"),"^",2)>PSOREF("FILL DATE") D
"RTN","PSORREF0",108,0)
 . S PSOX1=(PSOREF("NUMBER")+1)*PSOREF("DAYS SUPPLY")-10
"RTN","PSORREF0",109,0)
 . W !?5,$C(7),"LESS THAN ",PSOX1," DAYS FOR ",PSOREF("NUMBER")+1," FILLS",! D DIR K PSOX1
"RTN","PSORREF0",110,0)
 I '$P(PSOPAR,"^",6),$G(PSOREF("EAOK"))=0,$P(PSOREF("RX3"),"^",2)>PSOREF("FILL DATE") D
"RTN","PSORREF0",111,0)
 . S Y=$P(PSOREF("RX3"),"^",2) D DD^%DT W !!,$C(7),"Cannot be refilled until "_Y_"." S (PSOREF("DFLG"),PSOMHV)=1 K Y
"RTN","PSORREF0",112,0)
DATESX Q
"RTN","PSORREF0",113,0)
DIR K DIR,X,Y S DIR(0)="Y",DIR("A")="Continue ",DIR("B")="N",DIR("?")="Answer YES to Refill, NO to bypass"
"RTN","PSORREF0",114,0)
 D ^DIR K DIR S:$D(DIRUT)!('Y) (PSOREF("DFLG"),PSOMHV)=1 K DIRUT,DTOUT,DUOUT,X,Y
"RTN","PSORREF0",115,0)
 Q
"RTN","PSORREF0",116,0)
NEWPT S PSOQFLG=0,(DFN,PSODFN)=PSOREF("PSODFN") D ^PSOPTPST I PSOQFLG S PSOREF("DFLG")=1,PSOQFLG=0 G NEWPTX
"RTN","PSORREF0",117,0)
 D PROFILE^PSOREF1
"RTN","PSORREF0",118,0)
NEWPTX Q
"RTN","PSORREF0",119,0)
 ;
"RTN","PSORREF0",120,0)
EN(PSOREF)         ; Entry Point for Batch Barcode Option
"RTN","PSORREF0",121,0)
 D PROCESS K DRUG,PSODF
"RTN","PSORREF0",122,0)
 Q
"RTN","PSORREF1")
0^4^B3267523
"RTN","PSORREF1",1,0)
PSORREF1 ;ALB/BWF - Remote RX refill API ;12/3/2013 2:51pm
"RTN","PSORREF1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;;DEC 1997;Build 16
"RTN","PSORREF1",3,0)
 Q
"RTN","PSORREF1",4,0)
START ;
"RTN","PSORREF1",5,0)
 S (PSOREF("DFLG"),PSOREF("FIELD"),PSOREF1)=0
"RTN","PSORREF1",6,0)
 S X="T-6M",%DT="X" D ^%DT
"RTN","PSORREF1",7,0)
 S (PSOID,PSOREF("ISSUE DATE"))=$S($P(^PSRX(PSOREF("IRXN"),0),"^",13)<Y:Y,1:$P(^PSRX(PSOREF("IRXN"),0),"^",13))
"RTN","PSORREF1",8,0)
 S:$G(PSORX("BAR CODE"))&($G(PSOBBC1("FROM"))="NEW") PSOREF("ISSUE DATE")=DT
"RTN","PSORREF1",9,0)
 K X,X1,X2
"RTN","PSORREF1",10,0)
 S PSOREF("CS")=0,PSODRUG("DEA")=$P(^PSDRUG($P(^PSRX(PSOREF("IRXN"),0),"^",6),0),"^",3)
"RTN","PSORREF1",11,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S $P(PSOREF("CS"),"^")=1 S:$E(+PSODRUG("DEA"),DEA)=2 $P(PSOREF("CS"),"^",2)=1
"RTN","PSORREF1",12,0)
 ;
"RTN","PSORREF1",13,0)
 ;
"RTN","PSORREF1",14,0)
1 S PSONEW("DAYS SUPPLY")=$P(^PSRX(PSOREF("IRXN"),0),"^",8),PSONEW("# OF REFILLS")=$P(^(0),"^",9)
"RTN","PSORREF1",15,0)
 S PSODIR("FILL DATE")=FDATE
"RTN","PSORREF1",16,0)
 ;S PSOREF("FLD")=1 D FILLDT^PSODIR2(.PSOREF) ; Get Fill date
"RTN","PSORREF1",17,0)
 ;G:PSOREF("DFLG") END G:PSOREF("FIELD") @PSOREF("FIELD")
"RTN","PSORREF1",18,0)
 ;
"RTN","PSORREF1",19,0)
2 ;S PSOREF("FLD")=2,PSORX("MAIL/WINDOW")="MAIL" D MW^PSODIR2(.PSOREF)
"RTN","PSORREF1",20,0)
 ;G:PSOREF("DFLG") END G:PSOREF("FIELD") @PSOREF("FIELD")
"RTN","PSORREF1",21,0)
 ;
"RTN","PSORREF1",22,0)
3 ;I $G(DUZ("AG"))="I" S PSOREF("FLD")=3 D CLERK^PSODIR2(.PSOREF) ; Get Clerk Code
"RTN","PSORREF1",23,0)
 ;G:PSOREF("DFLG") END G:PSOREF("FIELD") @PSOREF("FIELD")
"RTN","PSORREF1",24,0)
 ;
"RTN","PSORREF1",25,0)
4 ;I $G(DUZ("AG"))="I" S PSOREF("FLD")=4 D EXP^PSODIR2(.PSOREF) ; Get Expiration Date - Indian Health Service ONLY
"RTN","PSORREF1",26,0)
 ;G:PSOREF("DFLG") END G:PSOREF("FIELD") @PSOREF("FIELD")
"RTN","PSORREF1",27,0)
 ;
"RTN","PSORREF1",28,0)
END ;
"RTN","PSORREF1",29,0)
 K PSOREF1
"RTN","PSORREF1",30,0)
 Q
"RTN","PSORREF1",31,0)
JUMP ;
"RTN","PSORREF1",32,0)
 S PSOREF("FIELD")=$S(+Y=22:1,+Y=11:2,+Y=16:3,+Y=29:4,1:PSOREF("FLD"))
"RTN","PSORREF1",33,0)
 I PSOREF("FIELD")>PSOREF("FLD") W !,$C(7),"Cannot jump ahead ..",! S PSOREF("FIELD")=PSOREF("FLD")
"RTN","PSORREF1",34,0)
 Q
"RTN","PSORREF1",35,0)
 ;
"RTN","PSORRP")
0^11^B55319118
"RTN","PSORRP",1,0)
PSORRP ;SLC/BWF - Remote RX report ;4/29/14 02:11PM
"RTN","PSORRP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;;DEC 1997;Build 16
"RTN","PSORRP",3,0)
 ;
"RTN","PSORRP",4,0)
EN ; -- main entry point for PSO LM REMOTE RX REPORT
"RTN","PSORRP",5,0)
 D EN^VALM("PSO LM REMOTE RX REPORT")
"RTN","PSORRP",6,0)
 Q
"RTN","PSORRP",7,0)
 ;
"RTN","PSORRP",8,0)
HDR ; -- header code
"RTN","PSORRP",9,0)
 S VALMHDR(1)="PSO Report of Remote Rx's refilled or partially filled."
"RTN","PSORRP",10,0)
 Q
"RTN","PSORRP",11,0)
 ;
"RTN","PSORRP",12,0)
INIT ; -- init variables and list array
"RTN","PSORRP",13,0)
 ;F LINE=1:1:30 D SET^VALM10(LINE,LINE_"     Line number "_LINE)
"RTN","PSORRP",14,0)
 ;S VALMCNT=30
"RTN","PSORRP",15,0)
 N SBY,DONE,QUIT,SDATE,EDATE,DFN,SITEIEN,DISP
"RTN","PSORRP",16,0)
 S VALMCNT=0
"RTN","PSORRP",17,0)
 S DIR(0)="S^1:Prescriptions we have filled for other facilities;2:Our prescriptions, filled by other faclities;3:All Remote activity"
"RTN","PSORRP",18,0)
 S DIR("A")="Select item:" D ^DIR
"RTN","PSORRP",19,0)
 I Y="^" S VALMQUIT="" Q
"RTN","PSORRP",20,0)
 S DISP=Y
"RTN","PSORRP",21,0)
 S DISP=$S(DISP=1:"RF^PR",DISP=2:"OR^OP",1:"RF^PR^OR^OP")
"RTN","PSORRP",22,0)
 S DIR(0)="S^D:DATE RANGE;P:PATIENT;S:SITE"
"RTN","PSORRP",23,0)
 S DIR("A")="Search by" D ^DIR
"RTN","PSORRP",24,0)
 I Y="^" S VALMQUIT="" Q
"RTN","PSORRP",25,0)
 S SBY=Y
"RTN","PSORRP",26,0)
 ; if date range
"RTN","PSORRP",27,0)
 S QUIT=0
"RTN","PSORRP",28,0)
 I SBY="D" D  G:QUIT INIT
"RTN","PSORRP",29,0)
 .S DONE=0
"RTN","PSORRP",30,0)
 .F  D  Q:DONE!(QUIT)
"RTN","PSORRP",31,0)
 ..S %DT="A",%DT("A")="Enter start date: ",%DT("B")=$$FMTE^XLFDT($$FMADD^XLFDT(DT,-30),1) D ^%DT
"RTN","PSORRP",32,0)
 ..I Y<0 S QUIT=1 Q
"RTN","PSORRP",33,0)
 ..I Y S SDATE=Y,DONE=1
"RTN","PSORRP",34,0)
 .S DONE=0
"RTN","PSORRP",35,0)
 .F  D  Q:DONE!(QUIT)
"RTN","PSORRP",36,0)
 ..S %DT="A",%DT("A")="Enter end date: ",%DT("B")=$$FMTE^XLFDT(DT,1) D ^%DT
"RTN","PSORRP",37,0)
 ..I Y<0 S QUIT=1 Q
"RTN","PSORRP",38,0)
 ..I Y S EDATE=Y,DONE=1
"RTN","PSORRP",39,0)
 .D DTRNG(SDATE,EDATE,DISP)
"RTN","PSORRP",40,0)
 I SBY="P" D  G:QUIT INIT
"RTN","PSORRP",41,0)
 .S DIC="^DPT(",DIC(0)="QEAMZ" D ^DIC I Y<0 S QUIT=1 Q
"RTN","PSORRP",42,0)
 .S DFN=+Y
"RTN","PSORRP",43,0)
 .D PAT(DFN,DISP)
"RTN","PSORRP",44,0)
 I SBY="S" D  G:QUIT INIT
"RTN","PSORRP",45,0)
 .S DIC="^DIC(4,",DIC(0)="QEAMZ" D ^DIC I Y<0 S QUIT=1 Q
"RTN","PSORRP",46,0)
 .S SITEIEN=+Y
"RTN","PSORRP",47,0)
 .D SITE(SITEIEN,DISP)
"RTN","PSORRP",48,0)
 Q
"RTN","PSORRP",49,0)
INITQ ;
"RTN","PSORRP",50,0)
 Q
"RTN","PSORRP",51,0)
 ;
"RTN","PSORRP",52,0)
HELP ; -- help code
"RTN","PSORRP",53,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSORRP",54,0)
 Q
"RTN","PSORRP",55,0)
 ;
"RTN","PSORRP",56,0)
EXIT ; -- exit code
"RTN","PSORRP",57,0)
 D CLEAN^VALM10
"RTN","PSORRP",58,0)
 Q
"RTN","PSORRP",59,0)
 ;
"RTN","PSORRP",60,0)
EXPND ; -- expand code
"RTN","PSORRP",61,0)
 Q
"RTN","PSORRP",62,0)
 ;
"RTN","PSORRP",63,0)
DTRNG(BEG,END,FLTR) ;
"RTN","PSORRP",64,0)
 N IEN,LINE,TCOST
"RTN","PSORRP",65,0)
 S (LINE,TCOST)=0
"RTN","PSORRP",66,0)
 S BEG=BEG-.01,END=END_.2359
"RTN","PSORRP",67,0)
 F  S BEG=$O(^PSRXR(52.09,"B",BEG)) Q:'BEG!(BEG>END)  D
"RTN","PSORRP",68,0)
 .S IEN=0 F  S IEN=$O(^PSRXR(52.09,"B",BEG,IEN)) Q:'IEN  D
"RTN","PSORRP",69,0)
 ..S TYPE=$$GET1^DIQ(52.09,IEN,.05,"I") I FLTR'[TYPE Q
"RTN","PSORRP",70,0)
 ..S TCOST=$G(TCOST)+$$GET1^DIQ(52.09,IEN,1.2,"I")
"RTN","PSORRP",71,0)
 ..S LINE=LINE+1 D BLDLINE(IEN,.LINE)
"RTN","PSORRP",72,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"") S VALMCNT=VALMCNT+1
"RTN","PSORRP",73,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Total Cost for items in this report: $"_TCOST) S VALMCNT=VALMCNT+1
"RTN","PSORRP",74,0)
 Q
"RTN","PSORRP",75,0)
PAT(DFN,FLTR) ;
"RTN","PSORRP",76,0)
 N IEN,LINE,TCOST
"RTN","PSORRP",77,0)
 S (LINE,TCOST)=0
"RTN","PSORRP",78,0)
 S IEN=0 F  S IEN=$O(^PSRXR(52.09,"C",DFN,IEN)) Q:'IEN  D
"RTN","PSORRP",79,0)
 .S TYPE=$$GET1^DIQ(52.09,IEN,.05,"I") I FLTR'[TYPE Q
"RTN","PSORRP",80,0)
 .S TCOST=$G(TCOST)+$$GET1^DIQ(52.09,IEN,1.2,"I")
"RTN","PSORRP",81,0)
 .S LINE=LINE+1 D BLDLINE(IEN,.LINE)
"RTN","PSORRP",82,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"") S VALMCNT=VALMCNT+1
"RTN","PSORRP",83,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Total Cost for items in this report: $"_TCOST) S VALMCNT=VALMCNT+1
"RTN","PSORRP",84,0)
 Q
"RTN","PSORRP",85,0)
SITE(SITEIEN,FLTR) ;
"RTN","PSORRP",86,0)
 N IEN,LINE,TCOST
"RTN","PSORRP",87,0)
 S (LINE,TCOST)=0
"RTN","PSORRP",88,0)
 S IEN=0 F  S IEN=$O(^PSRXR(52.09,"E",SITEIEN,IEN)) Q:'IEN  D
"RTN","PSORRP",89,0)
 .S TYPE=$$GET1^DIQ(52.09,IEN,.05,"I") I FLTR'[TYPE Q
"RTN","PSORRP",90,0)
 .S TCOST=$G(TCOST)+$$GET1^DIQ(52.09,IEN,1.2,"I")
"RTN","PSORRP",91,0)
 .S LINE=LINE+1 D BLDLINE(IEN,.LINE)
"RTN","PSORRP",92,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"") S VALMCNT=VALMCNT+1
"RTN","PSORRP",93,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Total Cost for items in this report: $"_TCOST) S VALMCNT=VALMCNT+1
"RTN","PSORRP",94,0)
 Q
"RTN","PSORRP",95,0)
BLDLINE(IEN,LINE) ;
"RTN","PSORRP",96,0)
 N DATE,PAT,DRUG,SITE,TYPE,QTY,DSUPP,F,IENS,DATA
"RTN","PSORRP",97,0)
 S IENS=IEN_","
"RTN","PSORRP",98,0)
 S F=52.09
"RTN","PSORRP",99,0)
 D GETS^DIQ(F,IENS,"**","IE","DATA")
"RTN","PSORRP",100,0)
 S LINEVAR=""
"RTN","PSORRP",101,0)
 S DATE=$P(DATA(F,IENS,.01,"E"),U)
"RTN","PSORRP",102,0)
 S PAT=$G(DATA(F,IENS,.02,"E"))
"RTN","PSORRP",103,0)
 S SITE=$G(DATA(F,IENS,.04,"E"))
"RTN","PSORRP",104,0)
 S TYPE=$G(DATA(F,IENS,.05,"I"))
"RTN","PSORRP",105,0)
 S QTY=$G(DATA(F,IENS,.07,"E"))
"RTN","PSORRP",106,0)
 S DSUPP=$G(DATA(F,IENS,.08,"E"))
"RTN","PSORRP",107,0)
 S DRUG=$G(DATA(F,IENS,1,"E"))
"RTN","PSORRP",108,0)
 S LINEVAR=$$SETFLD^VALM1(LINE_".",LINEVAR,"LINENO")
"RTN","PSORRP",109,0)
 S LINEVAR=$$SETFLD^VALM1(DATE,LINEVAR,"DATE")
"RTN","PSORRP",110,0)
 S LINEVAR=$$SETFLD^VALM1(PAT,LINEVAR,"PATIENT")
"RTN","PSORRP",111,0)
 ;S LINEVAR=$$SETFLD^VALM1(SITE,LINEVAR,"SITE")
"RTN","PSORRP",112,0)
 S LINEVAR=$$SETFLD^VALM1(DRUG,LINEVAR,"DRUG")
"RTN","PSORRP",113,0)
 S LINEVAR=$$SETFLD^VALM1(TYPE,LINEVAR,"TYPE")
"RTN","PSORRP",114,0)
 S LINEVAR=$$SETFLD^VALM1(QTY,LINEVAR,"QTY")
"RTN","PSORRP",115,0)
 S LINEVAR=$$SETFLD^VALM1(DSUPP,LINEVAR,"DSUPP")
"RTN","PSORRP",116,0)
 D SET^VALM10(LINE,LINEVAR,IEN)
"RTN","PSORRP",117,0)
 S VALMCNT=$G(VALMCNT)+1
"RTN","PSORRP",118,0)
 Q
"RTN","PSORRP",119,0)
SEL ;
"RTN","PSORRP",120,0)
 N DIR,ITEM,IEN,IENS,DATA,CNT,F,TYPE
"RTN","PSORRP",121,0)
 S ARY=$NA(^TMP("PSORRD",$J))
"RTN","PSORRP",122,0)
 K @ARY
"RTN","PSORRP",123,0)
 S CNT=1
"RTN","PSORRP",124,0)
 S F=52.09
"RTN","PSORRP",125,0)
 S DIR(0)="N^"_VALMBG_":"_VALMLST_":0" D ^DIR Q:'Y
"RTN","PSORRP",126,0)
 S ITEM=Y,IEN=$O(@VALMAR@("IDX",ITEM,0))
"RTN","PSORRP",127,0)
 Q:'IEN
"RTN","PSORRP",128,0)
 S IENS=IEN_","
"RTN","PSORRP",129,0)
 D GETS^DIQ(F,IENS,"**","IE","DATA")
"RTN","PSORRP",130,0)
 S TYPE=$G(DATA(F,IENS,.05,"I"))
"RTN","PSORRP",131,0)
 ; set up data
"RTN","PSORRP",132,0)
 S @ARY@(CNT,0)="Request Date/Time:         "_$G(DATA(F,IENS,.01,"E")),CNT=CNT+1
"RTN","PSORRP",133,0)
 S @ARY@(CNT,0)="Patient:                   "_$G(DATA(F,IENS,.02,"E")),CNT=CNT+1
"RTN","PSORRP",134,0)
 S @ARY@(CNT,0)="RX #:                      "_$G(DATA(F,IENS,.03,"I")),CNT=CNT+1
"RTN","PSORRP",135,0)
 S @ARY@(CNT,0)="Site:                      "_$G(DATA(F,IENS,.04,"E")),CNT=CNT+1
"RTN","PSORRP",136,0)
 S @ARY@(CNT,0)="Request Type:              "_$G(DATA(F,IENS,.05,"E")),CNT=CNT+1
"RTN","PSORRP",137,0)
 S @ARY@(CNT,0)="Requesting Pharmacist:     "_$S((TYPE="PR")!(TYPE="RF"):$G(DATA(F,IENS,.06,"E")),(TYPE="OR")!(TYPE="OP"):$G(DATA(F,IENS,.061,"E"))),CNT=CNT+1
"RTN","PSORRP",138,0)
 S @ARY@(CNT,0)="Quantity: "_$G(DATA(F,IENS,.07,"E"))_"   Days Supply: "_$G(DATA(F,IENS,.08,"E"))
"RTN","PSORRP",139,0)
 S @ARY@(CNT,0)="Dispensed Date:            "_$G(DATA(F,IENS,.1,"E")),CNT=CNT+1
"RTN","PSORRP",140,0)
 S @ARY@(CNT,0)="Remote Drug Name:          "_$G(DATA(F,IENS,1,"E")),CNT=CNT+1
"RTN","PSORRP",141,0)
 S @ARY@(CNT,0)="Local (matched) drug:      "_$G(DATA(F,IENS,1.1,"E")),CNT=CNT+1
"RTN","PSORRP",142,0)
 S @ARY@(CNT,0)="Local Refill/Partial Cost: "_$G(DATA(F,IENS,1.2,"E")),CNT=CNT+1
"RTN","PSORRP",143,0)
 ; TODO - need to add in loops for mesage details and possibly label data.
"RTN","PSORRP",144,0)
 S PSORCNT=CNT
"RTN","PSORRP",145,0)
 D ^PSORRD
"RTN","PSORRP",146,0)
 K @ARY,PSORCNT
"RTN","PSORRP",147,0)
 S VALMBCK="R"
"RTN","PSORRP",148,0)
 Q
"RTN","PSORRP",149,0)
RACT ; display remote active order
"RTN","PSORRP",150,0)
 N REMSITE,CNT,REMDATA,RSITENM,RRXNUM,RDETSTR,RSIGSTR,RDET,RSIG
"RTN","PSORRP",151,0)
 K ^TMP("PSOAO",$J)
"RTN","PSORRP",152,0)
 S (RSIG,RDET)=""
"RTN","PSORRP",153,0)
 S REMSITE=$P(PSOLST(ORN),U,4) Q:'REMSITE
"RTN","PSORRP",154,0)
 S REMSIEN=$O(^DIC(4,"D",REMSITE,""))
"RTN","PSORRP",155,0)
 S RSITENM=$$GET1^DIQ(4,REMSIEN,.01,"E")
"RTN","PSORRP",156,0)
 ; code for development only. if site name cannot be resolved, display something
"RTN","PSORRP",157,0)
 I '$L(RSITENM) S RSITENM="PHARMACY TESTING"
"RTN","PSORRP",158,0)
 ; do not continue if we are missing the remote order number for some reason
"RTN","PSORRP",159,0)
 S RRXNUM=$P(PSOLST(ORN),U,2) Q:'RRXNUM
"RTN","PSORRP",160,0)
 S REMDATA=$G(^XTMP("BWFRRX1",$J,DFN,REMSITE,RRXNUM,0))
"RTN","PSORRP",161,0)
 S RDETSTR=$G(^XTMP("BWFRRX1",$J,DFN,REMSITE,RRXNUM,"DETAIL"))
"RTN","PSORRP",162,0)
 S RSIGSTR=$G(^XTMP("BWFRRX1",$J,DFN,REMSITE,RRXNUM,"SIG"))
"RTN","PSORRP",163,0)
 S CNT=1
"RTN","PSORRP",164,0)
 S ^TMP("PSOAO",$J,CNT,0)="         Site #: "_REMSITE_"("_RSITENM_")",CNT=CNT+1
"RTN","PSORRP",165,0)
 S ^TMP("PSOAO",$J,CNT,0)="           Rx #: "_RRXNUM,CNT=CNT+1
"RTN","PSORRP",166,0)
 S ^TMP("PSOAO",$J,CNT,0)="      Drug Name: "_$P(REMDATA,U),CNT=CNT+1
"RTN","PSORRP",167,0)
 S ^TMP("PSOAO",$J,CNT,0)="    Days Supply: "_$P(REMDATA,U,4),CNT=CNT+1
"RTN","PSORRP",168,0)
 S ^TMP("PSOAO",$J,CNT,0)="       Quantity: "_$P(REMDATA,U,2),CNT=CNT+1
"RTN","PSORRP",169,0)
 S ^TMP("PSOAO",$J,CNT,0)="        Refills: "_$P(REMDATA,U,3),CNT=CNT+1
"RTN","PSORRP",170,0)
 S ^TMP("PSOAO",$J,CNT,0)="Expiration Date: "_$$RDT($P($P(REMDATA,U,5),".")),CNT=CNT+1
"RTN","PSORRP",171,0)
 S ^TMP("PSOAO",$J,CNT,0)="     Issue Date: "_$$RDT($P($P(REMDATA,U,6),".")),CNT=CNT+1
"RTN","PSORRP",172,0)
 S ^TMP("PSOAO",$J,CNT,0)="      Stop Date: "_$$RDT($P($P(REMDATA,U,7),".")),CNT=CNT+1
"RTN","PSORRP",173,0)
 S ^TMP("PSOAO",$J,CNT,0)=" Last Fill Date: "_$$RDT($P($P(REMDATA,U,8),".")),CNT=CNT+1
"RTN","PSORRP",174,0)
 D RCHUNK(.RDET,RDETSTR),RCHUNK(.RSIG,RSIGSTR)
"RTN","PSORRP",175,0)
 S ^TMP("PSOAO",$J,CNT,0)="         Detail: "_RDET(1),CNT=CNT+1
"RTN","PSORRP",176,0)
 S DETLOOP=1 F  S DETLOOP=$O(RDET(DETLOOP)) Q:'DETLOOP  D
"RTN","PSORRP",177,0)
 .S ^TMP("PSOAO",$J,CNT,0)="               "_RDET(DETLOOP),CNT=CNT+1
"RTN","PSORRP",178,0)
 S ^TMP("PSOAO",$J,CNT,0)="            Sig: "_RSIG(1),CNT=CNT+1
"RTN","PSORRP",179,0)
 S SIGLOOP=1 F  S SIGLOOP=$O(RSIG(SIGLOOP)) Q:'SIGLOOP  D
"RTN","PSORRP",180,0)
 .S ^TMP("PSOAO",$J,CNT,0)="               "_RSIG(DETLOOP),CNT=CNT+1
"RTN","PSORRP",181,0)
 ; ^PSOLMLST is the local order template
"RTN","PSORRP",182,0)
 D EN^PSOROS
"RTN","PSORRP",183,0)
 Q
"RTN","PSORRPA1")
0^12^B74374750
"RTN","PSORRPA1",1,0)
PSORRPA1 ;INO/BWF - remote partial prescriptions ;3/11/2014
"RTN","PSORRPA1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,56,77,130,152,181,174,287,385**;DEC 1997;Build 16
"RTN","PSORRPA1",3,0)
 ;External references L,UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORRPA1",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSORRPA1",5,0)
 ;External reference to ^DD(52 supported by DBIA 999
"RTN","PSORRPA1",6,0)
 ; bwf - 2/24/14 adding PAR refill tag for API usage.
"RTN","PSORRPA1",7,0)
 ; VALMSG  - return data for remote facility
"RTN","PSORRPA1",8,0)
 ; RXNUM   - rx number
"RTN","PSORRPA1",9,0)
 ; PFDATE  - Partial Fill Date
"RTN","PSORRPA1",10,0)
 ; MW      - Mail or Window
"RTN","PSORRPA1",11,0)
 ; QTY     - Quantity
"RTN","PSORRPA1",12,0)
 ; DSUPP   - Days Supply
"RTN","PSORRPA1",13,0)
 ; REMARKS - Remarks entered by 'remote' (filling) facility.
"RTN","PSORRPA1",14,0)
 ; PHARM   - Remote pharmacist's name
"RTN","PSORRPA1",15,0)
 ; PHONE   - remote pharmacists phone number
"RTN","PSORRPA1",16,0)
 ; SITE    - remote filling site.
"RTN","PSORRPA1",17,0)
 ;
"RTN","PSORRPA1",18,0)
PAR(VALMSG,RXNUM,PFDATE,MW,QTY,DSUPP,REMARKS,PHARM,PHONE,SITE) ;
"RTN","PSORRPA1",19,0)
 N RRXIEN,PSOPAR,ORN,PSOLST,XTMPLOC,PASSLOC,HFSIEN,FULLPTH,HFSDONE,PTHDAT,PTHPIECE,DEL,DELARR,FTGOPEN,FOUND,STRT,STATION
"RTN","PSORRPA1",20,0)
 S $ETRAP="D ^%ZTER Q"
"RTN","PSORRPA1",21,0)
 S RET(0)=""
"RTN","PSORRPA1",22,0)
 S RRXIEN=$O(^PSRX("B",RXNUM,0)),PSOSIEN=$$GET1^DIQ(52,RRXIEN,20,"I")
"RTN","PSORRPA1",23,0)
 S PSOPAR=$G(^PS(59,PSOSIEN,1)),PSOSITE=PSOSIEN
"RTN","PSORRPA1",24,0)
 ; set up PSOLST
"RTN","PSORRPA1",25,0)
 S ORN=1,PSOLST(ORN)=52_U_RRXIEN_U_U
"RTN","PSORRPA1",26,0)
 ;I $D(RXRP($P(PSOLST(ORN),"^",2))) S VALMSG(1)="A Reprint Label has been requested!" Q
"RTN","PSORRPA1",27,0)
 ;I $D(RXPR($P(PSOLST(ORN),"^",2))) S VALMBCK="",VALMSG="A Partial has already been requested!" Q
"RTN","PSORRPA1",28,0)
 ;I $D(RXRS($P(PSOLST(ORN),"^",2))) S VALMSG(1)="Rx is being pulled from suspense!" Q
"RTN","PSORRPA1",29,0)
 S PSORPDFN=+$P($G(^PSRX($P(PSOLST(ORN),"^",2),0)),"^",2)
"RTN","PSORRPA1",30,0)
 S PSOPLCK=$$L^PSSLOCK(PSORPDFN,0) I $P(PSOPLCK,U)=0 S VALMSG(1)=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK,PSORPDFN D PARFAIL(.VALMSG,RRXIEN,PHARM,PHONE,SITE)  Q
"RTN","PSORRPA1",31,0)
 K PSOPLCK D PSOL^PSSLOCK(RRXIEN) I '$G(PSOMSG) D UL^PSSLOCK(PSORPDFN) S VALMSG(1)=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order.") K PSOMSG,PSORPDFN D PARFAIL(.VALMSG,RRXIEN,PHARM,PHONE,SITE) Q
"RTN","PSORRPA1",32,0)
 ;I '$G(RXPR($P(PSOLST(ORN),"^",2))) S RX=$P(PSOLST(ORN),"^",2) D VALID^PSORXRP1 I $G(QFLG) S VALMSG(1)="A New Label has been requested already!" K QFLG,RX D ULK Q
"RTN","PSORRPA1",33,0)
 ;D FULL^VALM1
"RTN","PSORRPA1",34,0)
 ;I '$D(PSOPAR) D ^PSOLSET D:'$D(PSOPAR) ULK G:'$D(PSOPAR) KL
"RTN","PSORRPA1",35,0)
 S DA=$P(PSOLST(ORN),"^",2),RX0=^PSRX(DA,0),J=DA,RX2=$G(^(2)),R3=$G(^(3)) S:'$G(BBFLG) BBRX(1)=""
"RTN","PSORRPA1",36,0)
 N PSORF,PSOTRIC D TRIC^PSORXL1(DA) I PSOTRIC&($$STATUS^PSOBPSUT(DA,PSORF)'["PAYABLE") D  Q
"RTN","PSORRPA1",37,0)
 . S VALMSG(1)="Partial cannot be filled on Tricare non-payable Rx."
"RTN","PSORRPA1",38,0)
 . D PARFAIL(.VALMSG,RRXIEN,PHARM,PHONE,SITE)
"RTN","PSORRPA1",39,0)
 I +$P($G(^PSRX(DA,2)),"^",6)<DT D
"RTN","PSORRPA1",40,0)
 .S:$P($G(^PSRX(DA,"STA")),"^")<12 $P(^PSRX(DA,"STA"),"^")=11
"RTN","PSORRPA1",41,0)
 .S COMM="Medication Expired on "_$E($P(^PSRX(DA,2),"^",6),4,5)_"/"_$E($P(^(2),"^",6),6,7)_"/"_$E($P(^(2),"^",6),2,3)
"RTN","PSORRPA1",42,0)
 .S STAT="SC",PHARMST="ZE" D EN^PSOHLSN1(DA,STAT,PHARMST,COMM) K STAT,PHARMST,COMM,RX0,J,RX2,R3
"RTN","PSORRPA1",43,0)
 ;I +$P($G(^PSRX(DA,2)),"^",6)<PSODTCUT D  K DA S VALMBCK="R" Q
"RTN","PSORRPA1",44,0)
 ;.S VALMSG="Medication Expired on "_$E($P(^PSRX(DA,2),"^",6),4,5)_"/"_$E($P(^(2),"^",6),6,7)_"/"_$E($P(^(2),"^",6),2,3)
"RTN","PSORRPA1",45,0)
 I +^PSRX(DA,"STA"),+^("STA")'=5,+^("STA")'=11 D  K DA D ULK Q
"RTN","PSORRPA1",46,0)
 .S C=";"_+^PSRX(DA,"STA")_":",X=$P(^DD(52,100,0),"^",3),E=$F(X,C),D=$P($E(X,E,999),";")
"RTN","PSORRPA1",47,0)
 .S VALMSG(1)="Prescription is in a "_D_" status."
"RTN","PSORRPA1",48,0)
 .D PARFAIL(.VALMSG,RRXIEN,PHARM,PHONE,SITE)
"RTN","PSORRPA1",49,0)
 I $G(PSXSYS),($O(^PS(52.5,"B",DA,""))) S PSOZ1=$O(^PS(52.5,"B",DA,"")) D
"RTN","PSORRPA1",50,0)
 .I $P($G(^PS(52.5,PSOZ1,0)),"^",7)="Q"!($P($G(^(0)),"^",7)="L") D
"RTN","PSORRPA1",51,0)
 ..S VALMSG(1)="A partial entered for this Rx cannot be suspended."
"RTN","PSORRPA1",52,0)
 ..S VALMSG(2)="A fill for this Rx is already suspended for CMOP transmission."
"RTN","PSORRPA1",53,0)
 ..S VALMSG(3)="You may pull this fill from suspense or enter a partial and print the label."
"RTN","PSORRPA1",54,0)
 ..D PARFAIL(.VALMSG,RRXIEN,PHARM,PHONE,SITE)
"RTN","PSORRPA1",55,0)
 ;..S PSOZZ=1 K PSOZ1
"RTN","PSORRPA1",56,0)
CLC S PSOCLC=DUZ,PHYS=$P(^PSRX(DA,0),"^",4),DRG=$P(^(0),"^",6)
"RTN","PSORRPA1",57,0)
 I 'PHYS,$O(^PSRX(DA,1,0)) F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S PHYS=$S($P(^PSRX(DA,1,I,0),"^",17):$P(^PSRX(DA,1,I,0),"^",17),1:PHYS)
"RTN","PSORRPA1",58,0)
 S PSOPRZ=0 I $O(^PSRX(DA,"P",0)) N Z2 F Z2=0:0 S Z2=$O(^PSRX(DA,"P",Z2)) Q:'Z2  S PSOPRZ=Z2
"RTN","PSORRPA1",59,0)
 ; todo - bwf 2/24/2014
"RTN","PSORRPA1",60,0)
 ; prompts will need to be removed from api and placed on the calling system
"RTN","PSORRPA1",61,0)
 ;K Z1,PRMK S PM=1,RXN=DA,RXF=6,DIE("NO^")="BACKOUTOK",DIE=52
"RTN","PSORRPA1",62,0)
 ; bwf - replaced line above with line below
"RTN","PSORRPA1",63,0)
 K Z1,PRMK S PM=1,RXN=DA,RXF=6
"RTN","PSORRPA1",64,0)
 ;DR="[PSO PARTIAL]"
"RTN","PSORRPA1",65,0)
 ;S DR="K PM,PQ;60;Q;S:$O(Y(1))]""""!($G(PM)) Y=""@1"";35;@1;K PM;"
"RTN","PSORRPA1",66,0)
 ;S DR(2,52.2)=".01;S Z1=D1;.02;S:X=""M""!('$P($G(PSOPAR),U,12)) PM=1;.04;S:X=U PQ=1;.041R;S:X=U PQ=1;.05;.07////^S X=DUZ;6////^S X=PHYS;Q;.08///^S X=""NOW"";S PDT=X;.09////^S X=PSOSITE;.03;S:X=U PQ=1;S PRMK=X"
"RTN","PSORRPA1",67,0)
 ;D ^DIE
"RTN","PSORRPA1",68,0)
 ; bwf - save information into database, just as it would be through ^DIE
"RTN","PSORRPA1",69,0)
 S FDA(52.2,"+1,"_RXN_",",.01)=PFDATE D UPDATE^DIE(,"FDA","NEWPFIEN") K FDA
"RTN","PSORRPA1",70,0)
 S PFIEN=$O(NEWPFIEN(0)),PFIEN=$G(NEWPFIEN(PFIEN))
"RTN","PSORRPA1",71,0)
 ; set Z1 variable as was done in the ^DIE call for later use.
"RTN","PSORRPA1",72,0)
 S Z1=PFIEN
"RTN","PSORRPA1",73,0)
 S PFIENS=PFIEN_","_RRXIEN_","
"RTN","PSORRPA1",74,0)
 ; set PM variable as was done in the ^DIE call for later use.
"RTN","PSORRPA1",75,0)
 I MW="M"!('$P($G(PSOPAR),U,12)) S PM=1
"RTN","PSORRPA1",76,0)
 S FDA(52.2,PFIENS,.02)=MW
"RTN","PSORRPA1",77,0)
 S FDA(52.2,PFIENS,.04)=QTY
"RTN","PSORRPA1",78,0)
 S FDA(52.2,PFIENS,.041)=DSUPP
"RTN","PSORRPA1",79,0)
 ; todo - currently we have no local pharmacist. May need to add entry to file 200 for 'REMOTE,PHARMACIST' or 'PHARMACIST,REMOTE'
"RTN","PSORRPA1",80,0)
 S FDA(52.2,PFIENS,.05)=DUZ
"RTN","PSORRPA1",81,0)
 ; todo - can we use DUZ as the clerk code, or will this need another value??
"RTN","PSORRPA1",82,0)
 S FDA(52.2,PFIENS,.07)=DUZ
"RTN","PSORRPA1",83,0)
 ; todo - can we use the PHYS value that is determined by the system?? similar to the pharmacist issue above.
"RTN","PSORRPA1",84,0)
 S FDA(52.2,PFIENS,6)=PHYS
"RTN","PSORRPA1",85,0)
 S FDA(52.2,PFIENS,.08)=$$NOW^XLFDT
"RTN","PSORRPA1",86,0)
 ; todo - check this. This is setting the division to the 'originating' site. Is this allowed, or does it need to reflect the filling facility?
"RTN","PSORRPA1",87,0)
 ; note - filling facility will have its own field in the event this rx was filled remotely. May not need this field. Not a required field, and points to the OUTPATIENT SITE file (#59)
"RTN","PSORRPA1",88,0)
 S FDA(52.2,PFIENS,.09)=PSOSITE
"RTN","PSORRPA1",89,0)
 S FDA(52.2,PFIENS,.03)=REMARKS
"RTN","PSORRPA1",90,0)
 ; file the rest of the data onto the newly created multiple.
"RTN","PSORRPA1",91,0)
 D FILE^DIE(,"FDA") K FDA
"RTN","PSORRPA1",92,0)
 ; TODO - will we need to update other fields such as 'released date/time' etc? within this subfile?
"RTN","PSORRPA1",93,0)
 S PRMK=REMARKS
"RTN","PSORRPA1",94,0)
 ; todo - bwf end prompts
"RTN","PSORRPA1",95,0)
 I $D(RXPR(DA)),'$D(^PSRX(DA,"P",$G(RXPR(DA)))) D RMP^PSOCAN3
"RTN","PSORRPA1",96,0)
 G:'$G(Z1) CLCX
"RTN","PSORRPA1",97,0)
 I $G(PRMK)']"",Z1>PSOPRZ D ULK G KILL
"RTN","PSORRPA1",98,0)
 ; todo bwf 3/11/2014 - below logic uses PSOHDR which is a display mechanism. May need to remove or adjust this logic.
"RTN","PSORRPA1",99,0)
 ;I Z1,$G(PRMK)]"" D  D:$T(EN^PSOHDR)]"" EN^PSOHDR("PPAR",RXN) K DIE,RXN,RXF
"RTN","PSORRPA1",100,0)
 .;D ACT S:$P($G(^PSRX(RXN,"P",Z1,0)),"^",2)["W" PSODFN=$P(^PSRX(RXN,0),"^",2),BINGRTE="W",BBFLG=1,BBRX(1)=$G(BBRX(1))_RXN_","
"RTN","PSORRPA1",101,0)
 .;S ZD(RXN)=+^PSRX(RXN,"P",Z1,0),^PSRX(RXN,"TYPE")=Z1,$P(^PSRX(RXN,"P",Z1,0),"^",11)=$P($G(^PSDRUG(DRG,660)),"^",6),RXF=6,RXP=Z1,RXPR(RXN)=RXP
"RTN","PSORRPA1",102,0)
 .;I $G(PSOZZ)=1,($G(Z1)) D Q1^PSORXL K Z1,PSOZZ Q
"RTN","PSORRPA1",103,0)
 .;I $G(PSORX("PSOL",1))']"" S PSORX("PSOL",1)=RXN_"," Q
"RTN","PSORRPA1",104,0)
 .;F PSOX1=0:0 S PSOX1=$O(PSORX("PSOL",PSOX1)) Q:'PSOX1  Q:PSORX("PSOL",PSOX1)[RXN_","  S PSOX2=PSOX1
"RTN","PSORRPA1",105,0)
 .;I PSOX1 Q
"RTN","PSORRPA1",106,0)
 .;I $L(PSORX("PSOL",PSOX2))+$L(RXN)<220 S:PSORX("PSOL",PSOX2)'[RXN_"," PSORX("PSOL",PSOX2)=PSORX("PSOL",PSOX2)_RXN_","
"RTN","PSORRPA1",107,0)
 .;E  S PSORX("PSOL",PSOX2+1)=RXN_","
"RTN","PSORRPA1",108,0)
 S:'$D(PSOFROM) PSOFROM="PARTIAL" S BINGCRT=1 ;D:$D(BINGRTE)&($D(DISGROUP)) ^PSOBING1 K BINGRTE,TM,TM1
"RTN","PSORRPA1",109,0)
 ; bwf 8/14/14 - set up needed variables for label printing
"RTN","PSORRPA1",110,0)
 S PSODFN=$P(^PSRX(RRXIEN,0),U,2)
"RTN","PSORRPA1",111,0)
 S PSORX("PSOL",1)=RRXIEN_","
"RTN","PSORRPA1",112,0)
 S PSORX("MAIL/WINDOW")="WINDOW"
"RTN","PSORRPA1",113,0)
 S PSORX("NAME")=$$GET1^DIQ(2,PSODFN,.01)
"RTN","PSORRPA1",114,0)
 S PSORX("QFLG")=0
"RTN","PSORRPA1",115,0)
 S PSORX("METHOD OF PICKUP")=""
"RTN","PSORRPA1",116,0)
 S PSOX=$G(^PS(55,PSODFN,"PS")) I PSOX]"" S PSORX("PATIENT STATUS")=$P($G(^PS(53,PSOX,0)),"^")
"RTN","PSORRPA1",117,0)
 S PPL1=RRXIEN
"RTN","PSORRPA1",118,0)
 ; bwf 8/14/14 - end setup for label printing.
"RTN","PSORRPA1",119,0)
 ; call out to generate label
"RTN","PSORRPA1",120,0)
 S HFSIEN=$O(^%ZIS(1,"B","HFS",0)) I 'HFSIEN Q
"RTN","PSORRPA1",121,0)
 S FULLPTH=$$GET1^DIQ(3.5,HFSIEN,1,"I")
"RTN","PSORRPA1",122,0)
 S HFSDONE=0,PTHDAT=""
"RTN","PSORRPA1",123,0)
 F I=1:1 D  Q:HFSDONE
"RTN","PSORRPA1",124,0)
 .S PTHPIECE=$P(FULLPTH,"\",I) Q:'$L(PTHPIECE)
"RTN","PSORRPA1",125,0)
 .I PTHPIECE["." S PTHFILE=PTHPIECE,HFSDONE=1 Q
"RTN","PSORRPA1",126,0)
 .I '$L(PTHDAT) S PTHDAT=PTHPIECE Q
"RTN","PSORRPA1",127,0)
 .S PTHDAT=$G(PTHDAT)_"\"_PTHPIECE
"RTN","PSORRPA1",128,0)
 ;
"RTN","PSORRPA1",129,0)
 ; lets make the file as unique as possible so it will not be over-written.
"RTN","PSORRPA1",130,0)
 ;S $P(PTHFILE,".")=$P(PTHFILE,".")_"_"_RXNUM_"_"_DT
"RTN","PSORRPA1",131,0)
 ; delete the file first to ensure there isn't one lingering around
"RTN","PSORRPA1",132,0)
 ; keep in mind that since this is innovations, the hard coded path and file names need to be addressed.
"RTN","PSORRPA1",133,0)
 ; This will most likely require some modifications to the printing process itself to attempt to make the file names
"RTN","PSORRPA1",134,0)
 ; unique.
"RTN","PSORRPA1",135,0)
 S DELARR("TMP.DAT")="" S DEL=$$DEL^%ZISH("C:\TEMP\",$NA(DELARR))
"RTN","PSORRPA1",136,0)
 D LABEL^PSOCPTRI(RRXIEN,"HFS",PSOSITE,DUZ)
"RTN","PSORRPA1",137,0)
 ; temporary, for testing/dev, since the DUZ(2) is not correct - remove this logic when in mirror or test environment
"RTN","PSORRPA1",138,0)
 S STATION=$$STA^XUAF4(DUZ(2))
"RTN","PSORRPA1",139,0)
 ; end temp code - remove when in an appropriate environment
"RTN","PSORRPA1",140,0)
 S XTMPLOC="^XTMP(""PSORLBL"","_STATION_","_RXNUM_",1,0)"
"RTN","PSORRPA1",141,0)
 S PASSLOC="XTMP(""PSORLBL"","_STATION_","_RXNUM_")"
"RTN","PSORRPA1",142,0)
 S ^XTMP("PSORLBL",STATION,RXNUM,0)=DT_U_$$FMADD^XLFDT(DT,30)
"RTN","PSORRPA1",143,0)
 ; looks like we have to wait a moment before the file shows up.
"RTN","PSORRPA1",144,0)
 S STRT=$$NOW^XLFDT,FOUND=0
"RTN","PSORRPA1",145,0)
 F  D  Q:$$NOW^XLFDT>$$FMADD^XLFDT(STRT,,,1)!(FOUND)
"RTN","PSORRPA1",146,0)
 .S FTGOPEN=$$FTG^%ZISH("C:\TEMP\","TMP.DAT",XTMPLOC,4)
"RTN","PSORRPA1",147,0)
 .;D FTG^%ZISH(PTHDAT,PTHFILE,XTMPLOC,3)
"RTN","PSORRPA1",148,0)
 .I $O(^XTMP("PSORLBL",STATION,RXNUM,0)) S FOUND=1
"RTN","PSORRPA1",149,0)
 D UPDPAR(.VALMSG,RRXIEN,PHARM,PHONE,SITE,PASSLOC)
"RTN","PSORRPA1",150,0)
CLCX D ULK K DR,DIE,DRG,PPL,RXP,IOP,DA,PHYS,PSOPRZ Q
"RTN","PSORRPA1",151,0)
 ;
"RTN","PSORRPA1",152,0)
KILL S DA=Z1,DIK="^PSRX("_RXN_",""P""," D ^DIK S ^PSRX(RXN,"TYPE")=0
"RTN","PSORRPA1",153,0)
 D ULK S VALMSG(1)="No Partial Fill Dispensed" D PARFAIL(.VALMSG,RRXIEN,PHARM,PHONE,SITE) Q
"RTN","PSORRPA1",154,0)
KL K DFN,RFDAT,RLL,%,PRMK,PM,%Y,%X,D0,D1,DA,DI,DIC,DIE,DLAYGO,DQ,DR,I,II,J,JJJ,N,PHYS,PS,PSDATE,RFL,RFL1,RXF,ST,ST0,Z,Z1,X,Y,PDT,PSL,PSNP
"RTN","PSORRPA1",155,0)
 K PSOM,PSOP,PSOD,PSOU,DIK,DUOUT,IFN,RXN,DRG,HRX,I1,PSOCLC,PSOLIST,PSOLST,PSPAR,RXP D KVA^VADPT Q
"RTN","PSORRPA1",156,0)
ACT ;adds activity info for partial rx
"RTN","PSORRPA1",157,0)
 S RXF=0 F I=0:0 S I=$O(^PSRX(RXN,1,I)) Q:'I  S RXF=I S:I>5 RXF=I+1
"RTN","PSORRPA1",158,0)
 S DA=0 F FDA=0:0 S FDA=$O(^PSRX(RXN,"A",FDA)) Q:'FDA  S DA=FDA
"RTN","PSORRPA1",159,0)
 S DA=DA+1,^PSRX(RXN,"A",0)="^52.3DA^"_DA_"^"_DA,^PSRX(RXN,"A",DA,0)=DT_"^"_"P"_"^"_DUZ_"^"_RXF_"^"_PRMK
"RTN","PSORRPA1",160,0)
EX K RXF,I,FDA S DA=RXN
"RTN","PSORRPA1",161,0)
 Q
"RTN","PSORRPA1",162,0)
ULK ;
"RTN","PSORRPA1",163,0)
 D UL^PSSLOCK(+$G(PSORPDFN))
"RTN","PSORRPA1",164,0)
 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSORRPA1",165,0)
 K PSOMSG,PSOPLCK,PSORPDFN
"RTN","PSORRPA1",166,0)
 Q
"RTN","PSORRPA1",167,0)
PARFAIL(PSOMSG,PSOIEN,RPHARM,RPHONE,RSITE) ;
"RTN","PSORRPA1",168,0)
 S PSOMSG(0)=0_U_$$GET1^DIQ(52,PSOIEN,.01,"I")_U_PSOIEN,$P(PSOMSG(0),U,15)=RPHARM,$P(PSOMSG(0),U,16)=RPHONE,$P(PSOMSG(0),U,17)=RSITE
"RTN","PSORRPA1",169,0)
 Q
"RTN","PSORRPA1",170,0)
UPDPAR(PSOMSG,PSOIEN,RPHARM,RPHONE,RSITE,PASSLOC) ;
"RTN","PSORRPA1",171,0)
 N PARIEN,PARIENS,PARDATA,FIL,RXNUM,RFILLDT,QTY,DSUPP,CLERK,LOGDATE,IDIV,EDIV,DISPDT,NDC,FDA,DNAME,DIEN
"RTN","PSORRPA1",172,0)
 S FIL=52.2
"RTN","PSORRPA1",173,0)
 ;quit if PSOMSG(0) is already defined
"RTN","PSORRPA1",174,0)
 Q:$D(PSOMSG(0))
"RTN","PSORRPA1",175,0)
 ; get last partial data node
"RTN","PSORRPA1",176,0)
 S PARIEN=$O(^PSRX(PSOIEN,"P",""),-1)
"RTN","PSORRPA1",177,0)
 S RXNUM=$$GET1^DIQ(52,PSOIEN,.01,"E")
"RTN","PSORRPA1",178,0)
 S DNAME=$$GET1^DIQ(52,PSOIEN,6,"E")
"RTN","PSORRPA1",179,0)
 S DIEN=$$GET1^DIQ(52,PSOIEN,6,"I")
"RTN","PSORRPA1",180,0)
 S PARIENS=PARIEN_","_PSOIEN_","
"RTN","PSORRPA1",181,0)
 ; first, set in the remote pharmacist data
"RTN","PSORRPA1",182,0)
 S FDA(52.2,PARIENS,91)=RSITE
"RTN","PSORRPA1",183,0)
 S FDA(52.2,PARIENS,92)=RPHARM
"RTN","PSORRPA1",184,0)
 S FDA(52.2,PARIENS,93)=RPHONE
"RTN","PSORRPA1",185,0)
 D FILE^DIE(,"FDA") K FDA,RPHARM,RPHONE,RSITE
"RTN","PSORRPA1",186,0)
 ; now query data and build RET(0) holding accurate information from the refill multiple
"RTN","PSORRPA1",187,0)
 D GETS^DIQ(FIL,PARIENS,"**","IE","PARDATA")
"RTN","PSORRPA1",188,0)
 S RFILLDT=$G(PARDATA(FIL,PARIENS,.01,"I"))
"RTN","PSORRPA1",189,0)
 S QTY=$G(PARDATA(FIL,PARIENS,.04,"I"))
"RTN","PSORRPA1",190,0)
 S DSUPP=$G(PARDATA(FIL,PARIENS,.041,"I"))
"RTN","PSORRPA1",191,0)
 S CLERK=$G(PARDATA(FIL,PARIENS,.07,"E"))
"RTN","PSORRPA1",192,0)
 S LOGDATE=$G(PARDATA(FIL,PARIENS,.08,"I"))
"RTN","PSORRPA1",193,0)
 ; internal division number (IEN to PSO SITE file)
"RTN","PSORRPA1",194,0)
 S IDIV=$G(PARDATA(FIL,PARIENS,.09,"I"))
"RTN","PSORRPA1",195,0)
 S EDIV=$G(PARDATA(FIL,PARIENS,.09,"E"))
"RTN","PSORRPA1",196,0)
 S DISPDT=$G(PARDATA(FIL,PARIENS,7.5,"I"))
"RTN","PSORRPA1",197,0)
 S NDC=$G(PARDATA(FIL,PARIENS,1,"E"))
"RTN","PSORRPA1",198,0)
 S RSITE=$G(PARDATA(FIL,PARIENS,91,"I"))
"RTN","PSORRPA1",199,0)
 S RPHARM=$G(PARDATA(FIL,PARIENS,92,"E"))
"RTN","PSORRPA1",200,0)
 S RPHONE=$G(PARDATA(FIL,PARIENS,93,"E"))
"RTN","PSORRPA1",201,0)
 S $P(DAT(1),U,3)=RXNUM,$P(DAT(1),U,4)=RSITE,$P(DAT(1),U,7)=QTY,$P(DAT(1),U,8)=DISPDT,$P(DAT(1),U,9)=DNAME,$P(DAT(1),U,10)=DSUPP,$P(DAT(1),U,11)=RPHARM D LOGDATA^PSORRX1($NA(DAT),"OP")
"RTN","PSORRPA1",202,0)
 S PSOMSG(0)=1_U_RXNUM_U_PSOIEN_U_PARIEN_U_RFILLDT_U_DNAME_U_QTY_U_DSUPP_U_CLERK_U_LOGDATE_U_IDIV_U_EDIV_U_DISPDT_U_NDC_U_RPHARM_U_RPHONE_U_RSITE_U_PASSLOC
"RTN","PSORRPA1",203,0)
 I '$L($G(PSOMSG(1))) S PSOMSG(1)="Partial complete for RX #"_RXNUM_"."
"RTN","PSORRPA1",204,0)
 Q
"RTN","PSORRX1")
0^1^B142480212
"RTN","PSORRX1",1,0)
PSORRX1 ;SLC/BWF - Testing ;12/30/13 01:33Pm
"RTN","PSORRX1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;;DEC 1997;Build 16
"RTN","PSORRX1",3,0)
 Q
"RTN","PSORRX1",4,0)
 ;
"RTN","PSORRX1",5,0)
REMOTERX(DFN) ;
"RTN","PSORRX1",6,0)
 N RXRES,MSG,HLARR,CNT,RXDAT,HLARR,HLPROT,DONE,ORFS,ORCS,ORRS,ORES,ORSS,ORQUIT,HLQUIT,HLDAT,TFLIST
"RTN","PSORRX1",7,0)
 N PID1,PID4,PID5,PID6,TFDAT,TFSTRING,LOOP
"RTN","PSORRX1",8,0)
 S HLARR=$NA(^TMP("HLS",$J)) K @HLARR
"RTN","PSORRX1",9,0)
 S HLDAT=$NA(^XTMP("PSORRX1",$J)) K @HLDAT
"RTN","PSORRX1",10,0)
 ; possibly add error message to be returned if no DFN.
"RTN","PSORRX1",11,0)
 I 'DFN Q
"RTN","PSORRX1",12,0)
 S TFSTRING=$$PIDSEG(DFN) Q:TFSTRING=-1
"RTN","PSORRX1",13,0)
 ;S SITE=$P($$SITE^VASITE(),U)
"RTN","PSORRX1",14,0)
 ;D TFL^VAFCTFU2(.TFLIST,DFN_"^PI^USVHA^"_SITE)
"RTN","PSORRX1",15,0)
 ;I $P(TFLIST(1),U)'=-1 D
"RTN","PSORRX1",16,0)
 ;.S LOOP=0 F  S LOOP=$O(TFLIST(LOOP)) Q:'LOOP  D
"RTN","PSORRX1",17,0)
 ;..S TFDAT=$G(TFLIST(LOOP))
"RTN","PSORRX1",18,0)
 ;..S TFSTRING=$G(TFSTRING)_$P(TFDAT,U)_U_U_U_$P(TFDAT,U,3)_U_$P(TFDAT,U,2)_U_$P(TFDAT,U,4)
"RTN","PSORRX1",19,0)
 ;..; if there is more data, place a separater.
"RTN","PSORRX1",20,0)
 ;..I $O(TFLIST(LOOP)) S TFSTRING=TFSTRING_"~"
"RTN","PSORRX1",21,0)
 ;I '$D(TFSTRING) S TFSTRING=DFN_"^^^USVHA^PI^"_SITE
"RTN","PSORRX1",22,0)
 S HLPROT="ZJTH PHARM QBP-Q13 EVENT"
"RTN","PSORRX1",23,0)
 ; TODO - replace 'UniqueOrRandomNumber' with an actual value.
"RTN","PSORRX1",24,0)
 S @HLARR@(1)="QPD|Q13^Active Prescriptions^HL70471|UniqueOrRandomNumber"
"RTN","PSORRX1",25,0)
 S @HLARR@(2)="PID|||"_TFSTRING
"RTN","PSORRX1",26,0)
 S @HLARR@(3)="RCP|I"
"RTN","PSORRX1",27,0)
 D INIT^HLFNC2(HLPROT,.RXMSG)
"RTN","PSORRX1",28,0)
 D DIRECT^HLMA(HLPROT,"GM",1,.RXDAT)
"RTN","PSORRX1",29,0)
 S ORFS=$G(HL("FS")),ORCS=$E($G(HL("ECH")),1),ORRS=$E($G(HL("ECH")),2),ORES=$E($G(HL("ECH")),3),ORSS=$E($G(HL("ECH")),4)
"RTN","PSORRX1",30,0)
 S HLQUIT=0,ORQUIT="",ORERR=""
"RTN","PSORRX1",31,0)
 I $P(RXDAT,U,3)="No response"!($P(RXDAT,U,3)="Connection Failed") W !,"The pharmacy manager is down or not responding.",!,"Could not query remote prescriptions.",!!,"Contact technical support for further assistance." K DIR S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",32,0)
 F  X HLNEXT Q:HLQUIT'>0!(ORQUIT'="")  D
"RTN","PSORRX1",33,0)
 .I $E(HLNODE,1,3)="MSA"&($P(HLNODE,ORFS,2)'="AA") S ORERR=$P(HLNODE,ORFS,2)
"RTN","PSORRX1",34,0)
 .I $E(HLNODE,1,3)="ERR" D LOGERR(DFN,.HLNODE,.HLDAT) S ORQUIT=$P(HLNODE,ORFS,2)
"RTN","PSORRX1",35,0)
 .I $E(HLNODE,1,3)="ZAK",$P(HLNODE,ORFS,4)'=1 D LOGERR(DFN,.HLNODE,.HLDAT,"Could not connect to site, or site is unavailable.")
"RTN","PSORRX1",36,0)
 .I $E(HLNODE,1,3)="ZAK",$P(HLNODE,ORFS,3)=0,$P(HLNODE,ORFS,4)=1 D LOGERR(DFN,.HLNODE,.HLDAT,"No active prescriptions found.")
"RTN","PSORRX1",37,0)
 .I $E(HLNODE,1,3)="RDT" D
"RTN","PSORRX1",38,0)
 ..S @HLDAT@(0)=$$FMADD^XLFDT($$NOW^XLFDT,2)_U_$$NOW^XLFDT
"RTN","PSORRX1",39,0)
 ..D RXPRSE(DFN,.HLNODE,.HLDAT)
"RTN","PSORRX1",40,0)
 Q
"RTN","PSORRX1",41,0)
LOGERR(DFN,DATA,HLDAT,NMSG) ;
"RTN","PSORRX1",42,0)
 N HLERR,RXSITE
"RTN","PSORRX1",43,0)
 S NMSG=$G(NMSG,"")
"RTN","PSORRX1",44,0)
 S RXSITE=$P(DATA,ORFS,2)
"RTN","PSORRX1",45,0)
 I 'RXSITE W !,"The pharmacy manager is down or not responding.",!,"Could not query remote prescriptions.",! K DIR S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",46,0)
 S HLERR=$S(NMSG'="":NMSG,1:$P($P(DATA,ORFS,4),U,2))
"RTN","PSORRX1",47,0)
 S:'$D(@HLDAT@(0)) @HLDAT@(0)=$$FMADD^XLFDT($$NOW^XLFDT,2)_U_$$NOW^XLFDT
"RTN","PSORRX1",48,0)
 S @HLDAT@(DFN,RXSITE,"ERR")="<"_HLERR_">"
"RTN","PSORRX1",49,0)
 Q
"RTN","PSORRX1",50,0)
 ; parse rx data from RDF segment
"RTN","PSORRX1",51,0)
RXPRSE(DFN,DATA,HLDAT) ;
"RTN","PSORRX1",52,0)
 ;RDF|12|Site Number~Rx Number~Drug Name~Quantity~Refills~Days Supply~Expiration Date
"RTN","PSORRX1",53,0)
 ;~Issue Date~Stop Date~Last Fill Date~Sig~Detail
"RTN","PSORRX1",54,0)
 N RXSITE,RXNUM,DNAME,QTY,REFILLS,DSUPP,EXPDT,ISSDATE,STOPDT,LFDT,SIG,DETAIL,STAT,STATNM,STATERR,DDONE,I
"RTN","PSORRX1",55,0)
 ; put data into one variable. This handles overflow nodes
"RTN","PSORRX1",56,0)
 S DAT=0 F  S DAT=$O(DATA(DAT)) Q:'DAT  D
"RTN","PSORRX1",57,0)
 .S DATA=$G(DATA)_$G(DATA(DAT))
"RTN","PSORRX1",58,0)
 S RXSITE=$P(DATA,ORFS,2),RXNUM=$P(DATA,ORFS,3),DNAME=$P(DATA,ORFS,4),QTY=$P(DATA,ORFS,5)
"RTN","PSORRX1",59,0)
 S REFILLS=$P(DATA,ORFS,6),DSUPP=$P(DATA,ORFS,7),EXPDT=$P(DATA,ORFS,8),ISSDATE=$P(DATA,ORFS,9)
"RTN","PSORRX1",60,0)
 S STOPDT=$P(DATA,ORFS,10),LFDT=$P(DATA,ORFS,11),SIG=$P(DATA,ORFS,12),DETAIL=$P(DATA,ORFS,13)
"RTN","PSORRX1",61,0)
 S STAT=$P(DATA,ORFS,14) Q:STAT=""
"RTN","PSORRX1",62,0)
 S STATNM=$$EXTERNAL^DILFD(52,100,"",STAT,"STATERR")
"RTN","PSORRX1",63,0)
 ; if status name does not exist, or a message was returned, we cannot process this entry.
"RTN","PSORRX1",64,0)
 I $D(STATERR)!(STATNM="") Q
"RTN","PSORRX1",65,0)
 ;Q:STATNM'="ACTIVE"
"RTN","PSORRX1",66,0)
 ; quit if no site# or rx # to prevent null subscript
"RTN","PSORRX1",67,0)
 Q:'RXSITE!('RXNUM)
"RTN","PSORRX1",68,0)
 S @HLDAT@(DFN,RXSITE,STATNM,RXNUM,0)=DNAME_U_QTY_U_REFILLS_U_DSUPP_U_EXPDT_U_ISSDATE_U_STOPDT_U_LFDT_STAT
"RTN","PSORRX1",69,0)
 S @HLDAT@(DFN,RXSITE,STATNM,RXNUM,"SIG")=SIG
"RTN","PSORRX1",70,0)
 S @HLDAT@(DFN,RXSITE,STATNM,RXNUM,"DETAIL")=DETAIL
"RTN","PSORRX1",71,0)
 Q
"RTN","PSORRX1",72,0)
 ;
"RTN","PSORRX1",73,0)
 ; build and send refill request
"RTN","PSORRX1",74,0)
REFREQ ;
"RTN","PSORRX1",75,0)
 N PHARM,PHONE,LOCSITE,DSUPP,MW,FILLDT,MSG,RXNUM,HLSTR,REMSITE,PHARMLN,PHARMFN,PHARMMI,TFSTRING,HLPROT,LOCDRUG
"RTN","PSORRX1",76,0)
 N ORFS,ORCS,ORRS,ORES,ORSS,HLQUIT,ORQUIT,RESP,RETDFN
"RTN","PSORRX1",77,0)
 ;S MSG=$NA(^TMP("BWFRRX",$J)) K @MSG
"RTN","PSORRX1",78,0)
 S HLARR=$NA(^TMP("HLS",$J)) K @HLARR
"RTN","PSORRX1",79,0)
 S HLDAT=$NA(^XTMP("REFREQ^PSORRX1",$J)) K @HLDAT
"RTN","PSORRX1",80,0)
 ; TODO - protocol may be named differently.
"RTN","PSORRX1",81,0)
 S HLPROT="ZJTH PHARM RDS-O13 EVENT"
"RTN","PSORRX1",82,0)
 S MW="W"
"RTN","PSORRX1",83,0)
 D FULL^VALM1
"RTN","PSORRX1",84,0)
 S LOCSITE=$$STA^XUAF4(DUZ(2))
"RTN","PSORRX1",85,0)
 S PHARM=$$GET1^DIQ(200,DUZ,.01,"E"),PHARMLN=$P(PHARM,","),PHARMFN=$P($P(PHARM,",",2)," "),PHARMMI=$P($P(PHARM,",",2)," ",2)
"RTN","PSORRX1",86,0)
 S PHONE=$$GET1^DIQ(200,DUZ,.132,"E")
"RTN","PSORRX1",87,0)
 S RXNUM=$P(PSOLST(ORN),U,2) I 'RXNUM S MSG(1)="Invalid Rx #. Please contact technical support." Q
"RTN","PSORRX1",88,0)
 I RXSTAT'="ACTIVE" W !!,"Only 'ACTIVE' remote prescriptions may be refilled at this time." S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",89,0)
 S REMSITE=$P(PSOLST(ORN),U,4)
"RTN","PSORRX1",90,0)
 S PSOREF("DFLG")=""
"RTN","PSORRX1",91,0)
 S REMDRUG=$P(REMDATA,U) S LOCDRUG=$$DRUGMTCH(REMDRUG)
"RTN","PSORRX1",92,0)
 I '$G(LOCDRUG) W !!,"Could not match remote drug to a local drug. Cannot refill." S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",93,0)
 S PSOREF("FLD")=1 D FILLDT^PSODIR2(.PSOREF) ; Get Fill date
"RTN","PSORRX1",94,0)
 S FILLDT=$G(PSOREF("FILL DATE")) I '$L(FILLDT) W !,"Invalid fill date.",! K DIR S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",95,0)
 S FILLDT=$$FMTHL7^XLFDT(FILLDT)
"RTN","PSORRX1",96,0)
 S TFSTRING=$$PIDSEG(PSODFN,REMSITE) Q:TFSTRING=-1
"RTN","PSORRX1",97,0)
 S @HLARR@(1)="PID|||"_TFSTRING
"RTN","PSORRX1",98,0)
 S @HLARR@(2)="ORC|RF|"_RXNUM_U_REMSITE_"|||||||"_FILLDT_"|"_DUZ_U_PHARMLN_U_PHARMFN_U_PHARMMI_"|||^^^"_LOCSITE_"|"_PHONE
"RTN","PSORRX1",99,0)
 S @HLARR@(3)="RXO||||||||"_MW_"^^^"_LOCSITE
"RTN","PSORRX1",100,0)
 W !!,"Please be patient. It may take a moment for the originating site to generate"
"RTN","PSORRX1",101,0)
 W !,"your label data."
"RTN","PSORRX1",102,0)
 D INIT^HLFNC2(HLPROT,.RXMSG)
"RTN","PSORRX1",103,0)
 D DIRECT^HLMA(HLPROT,"GM",1,.RXDAT)
"RTN","PSORRX1",104,0)
 D READMSG(.HLDAT,"RF",LOCDRUG)
"RTN","PSORRX1",105,0)
 K @HLDAT,@HLARR
"RTN","PSORRX1",106,0)
 Q
"RTN","PSORRX1",107,0)
 ; build and send partial fill request
"RTN","PSORRX1",108,0)
PARTIAL() ;
"RTN","PSORRX1",109,0)
 N DIR,DONE,I,PRMPDAT,VAR,VARSTR,PRXNUM,PHARM,PHARMLN,PHARMFN,PHARMMI,PHONE,RXNUM,HLPROT,TFSTRING,HLARR,PHONE,REMSITE,HLDAT,LOCDRUG,EXIT
"RTN","PSORRX1",110,0)
 S HLPROT="ZJTH PHARM RDS-O13 EVENT"
"RTN","PSORRX1",111,0)
 S HLDAT=$NA(^XTMP("PARTIAL^PSORRX1",$J)) K @HLDAT
"RTN","PSORRX1",112,0)
 S HLARR=$NA(^TMP("HLS",$J)) K @HLARR
"RTN","PSORRX1",113,0)
 D FULL^VALM1
"RTN","PSORRX1",114,0)
 I RXSTAT'="ACTIVE" W !!,"Only 'ACTIVE' remote prescriptions may be actioned at this time." S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",115,0)
 S LOCSITE=$$STA^XUAF4(DUZ(2))
"RTN","PSORRX1",116,0)
 S PHONE=$$GET1^DIQ(200,DUZ,.132,"E")
"RTN","PSORRX1",117,0)
 S PRXNUM=$P(PSOLST(ORN),U,2) I 'PRXNUM S MSG(1)="Invalid Rx #. Please contact technical support." Q
"RTN","PSORRX1",118,0)
 S REMSITE=$P(PSOLST(ORN),U,4)
"RTN","PSORRX1",119,0)
 ;S PHARM=$$GET1^DIQ(200,DUZ,.01,"E"),PHARMLN=$P(PHARM,","),PHARMFN=$P($P(PHARM,",",2)," "),PHARMMI=$P($P(PHARM,",",2)," ",2)
"RTN","PSORRX1",120,0)
 S DONE=0,CNT=1
"RTN","PSORRX1",121,0)
 ; prompt for fields that would normally be prompted for a local partial fill.
"RTN","PSORRX1",122,0)
 D FULL^VALM1
"RTN","PSORRX1",123,0)
 S REMDRUG=$P(REMDATA,U) S LOCDRUG=$$DRUGMTCH(REMDRUG)
"RTN","PSORRX1",124,0)
 I '$G(LOCDRUG) W !!,"Could not match remote drug to a local drug. Cannot complete partial fill." S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",125,0)
 S EXIT=0
"RTN","PSORRX1",126,0)
 F I=1:1 D  Q:DONE!(EXIT)
"RTN","PSORRX1",127,0)
 .S PRMPDAT=$T(PRMPTXT+I)
"RTN","PSORRX1",128,0)
 .S PRMPDAT=$P(PRMPDAT,";;",2)
"RTN","PSORRX1",129,0)
 .I PRMPDAT="Q" S DONE=1 Q
"RTN","PSORRX1",130,0)
 .K DIR
"RTN","PSORRX1",131,0)
 .S DIR(0)=$P(PRMPDAT,"|"),DIR("A")=$P(PRMPDAT,"|",2),VAR=$P(PRMPDAT,"|",4) S:$L($P(PRMPDAT,"|",3)) DIR("B")=$P(PRMPDAT,"|",3)
"RTN","PSORRX1",132,0)
 .I $G(DIR("B"))["~" D
"RTN","PSORRX1",133,0)
 ..S EXE=$TR(DIR("B"),"~","^") X EXE S DIR("B")=DEF
"RTN","PSORRX1",134,0)
 .D ^DIR
"RTN","PSORRX1",135,0)
 .;I '$L(VARSTR) S VARSTR=VAR
"RTN","PSORRX1",136,0)
 .;S VARSTR=VARSTR_","_VAR
"RTN","PSORRX1",137,0)
 .I Y="^" S EXIT=1 Q
"RTN","PSORRX1",138,0)
 .S @VAR=$S(DIR(0)["P":$P(Y,U,2),1:Y)
"RTN","PSORRX1",139,0)
 ;
"RTN","PSORRX1",140,0)
 I EXIT W !,"Cancelling partial fill request.",! K DIR S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",141,0)
 S PDATE=$$FMTHL7^XLFDT(PDATE)
"RTN","PSORRX1",142,0)
 S PHARMLN=$P(PHARM,","),PHARMFN=$P($P(PHARM,",",2)," "),PHARMMI=$P($P(PHARM,",",2)," ",2)
"RTN","PSORRX1",143,0)
 S TFSTRING=$$PIDSEG(PSODFN,REMSITE) Q:TFSTRING=-1
"RTN","PSORRX1",144,0)
 S @HLARR@(1)="PID|||"_TFSTRING
"RTN","PSORRX1",145,0)
 S @HLARR@(2)="ORC|PF|"_PRXNUM_U_REMSITE_"|||||||"_PDATE_"|"_DUZ_U_PHARMLN_U_PHARMFN_U_PHARMMI_"|||^^^"_LOCSITE_"|"_PHONE
"RTN","PSORRX1",146,0)
 S @HLARR@(3)="RXO|1|"_QTY_"||||||"_MW_"^^^"_LOCSITE_"|||"_DSUPP
"RTN","PSORRX1",147,0)
 S @HLARR@(4)="NTE|1|L|"_REMARKS
"RTN","PSORRX1",148,0)
 W !!,"Please be patient. It may take a moment for the originating site to generate"
"RTN","PSORRX1",149,0)
 W !,"your label data."
"RTN","PSORRX1",150,0)
 D INIT^HLFNC2(HLPROT,.RXMSG)
"RTN","PSORRX1",151,0)
 D DIRECT^HLMA(HLPROT,"GM",1,.RXDAT)
"RTN","PSORRX1",152,0)
 ; clean up variables used
"RTN","PSORRX1",153,0)
 ;S EXEK="K "_VARSTR X EXEK
"RTN","PSORRX1",154,0)
 D READMSG(.HLDAT,"PR",LOCDRUG)
"RTN","PSORRX1",155,0)
 K PDATE,QTY,DSUPP,PHARM,REMARKS,MW
"RTN","PSORRX1",156,0)
 K @HLDAT,@HLARR
"RTN","PSORRX1",157,0)
 Q
"RTN","PSORRX1",158,0)
 ; read response from refill site
"RTN","PSORRX1",159,0)
READMSG(HLDAT,TYPE,LOCDRUG) ;
"RTN","PSORRX1",160,0)
 N ORFS,ORCS,ORRS,ORES,ORSS,HLQUIT,ORQUIT,OREMSG1,OREMSG2,ORSMSG,ORSMSG,GBLLOC,LBLOOP,LBLGBL,LBTXT,LBLOVF
"RTN","PSORRX1",161,0)
 S ORFS=$G(HL("FS")),ORCS=$E($G(HL("ECH")),1),ORRS=$E($G(HL("ECH")),2),ORES=$E($G(HL("ECH")),3),ORSS=$E($G(HL("ECH")),4)
"RTN","PSORRX1",162,0)
 S TYPE=$G(TYPE,"")
"RTN","PSORRX1",163,0)
 S HLQUIT=0,ORQUIT="",OREMSG1="",OREMSG2="",ORERR=""
"RTN","PSORRX1",164,0)
 F  X HLNEXT Q:HLQUIT'>0!(ORQUIT'="")  D
"RTN","PSORRX1",165,0)
 .I $E(HLNODE,1,3)="MSA"&($P(HLNODE,ORFS,2)'="AA") S ORERR=$P(HLNODE,ORFS,2)
"RTN","PSORRX1",166,0)
 .I $E(HLNODE,1,3)="ERR" S OREMSG1=$P(HLNODE,ORFS,9)
"RTN","PSORRX1",167,0)
 ..;I $E(HLNODE,1,3)="ERR" S OREMSG1=$P($P(HLNODE,ORFS,4),ORCS,2),OREMSG2=$P($P(HLNODE,ORFS,4),ORCS,9),ORQUIT=$P(HLNODE,ORFS,2)
"RTN","PSORRX1",168,0)
 .I $E(HLNODE,1,3)="NTE" D
"RTN","PSORRX1",169,0)
 ..D REFNTE(.HLNODE,.HLDAT)
"RTN","PSORRX1",170,0)
 ..S ORSMSG=$P(@HLDAT@(1),ORFS)
"RTN","PSORRX1",171,0)
 .I $E(HLNODE,1,3)="PID" D
"RTN","PSORRX1",172,0)
 ..S @HLDAT@(0)=$$FMADD^XLFDT($$NOW^XLFDT,2)_U_$$NOW^XLFDT
"RTN","PSORRX1",173,0)
 ..D REFPID(.HLNODE,.HLDAT)
"RTN","PSORRX1",174,0)
 .I $E(HLNODE,1,3)="ORC" D
"RTN","PSORRX1",175,0)
 ..D REFORC(.HLNODE,.HLDAT)
"RTN","PSORRX1",176,0)
 .I $E(HLNODE,1,3)="RXD" D
"RTN","PSORRX1",177,0)
 ..D REFRXD(.HLNODE,.HLDAT)
"RTN","PSORRX1",178,0)
 I '$L(ORERR) D
"RTN","PSORRX1",179,0)
 .; if there is a global location for label data, prompt user for label device
"RTN","PSORRX1",180,0)
 .S LBLGBL=$S($P(@HLDAT@(1),U,11)'="":"^"_$P(@HLDAT@(1),U,11),1:"")
"RTN","PSORRX1",181,0)
 .D LOGDATA(.HLDAT,TYPE,LOCDRUG,.LBLGBL)
"RTN","PSORRX1",182,0)
 I OREMSG1'="" W !!,OREMSG1_". "_$S($L(OREMSG2):OREMSG2_".",1:""),! S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR
"RTN","PSORRX1",183,0)
 I $D(ORSMSG) W !!,ORSMSG S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR
"RTN","PSORRX1",184,0)
 ;K @HLDAT
"RTN","PSORRX1",185,0)
 Q
"RTN","PSORRX1",186,0)
 ; HLDAT(1)=MESSAGE^PATIENT DFN^RX NUMBER^REMOTE SITE#^FILL/PARTIAL DATE^PHARMACIST NAME^QUANTITY^DISPENSE DATE^DRUG NAME^DAYS SUPPLY
"RTN","PSORRX1",187,0)
REFNTE(DATA,HLDAT) ;
"RTN","PSORRX1",188,0)
 ; Message details
"RTN","PSORRX1",189,0)
 S $P(@HLDAT@(1),U)=$P(DATA,ORFS,4)
"RTN","PSORRX1",190,0)
 Q
"RTN","PSORRX1",191,0)
 ;Q $P(DATA,ORFS,4)
"RTN","PSORRX1",192,0)
 ;
"RTN","PSORRX1",193,0)
REFPID(DATA,HLDAT) ;
"RTN","PSORRX1",194,0)
 ; patient IEN from remote site - TODO - may be easier to just retain DFN locally, since we already have it
"RTN","PSORRX1",195,0)
 S $P(@HLDAT@(1),U,2)=$P($P($P(DATA,ORFS,4),U,6),"~",2)
"RTN","PSORRX1",196,0)
 Q
"RTN","PSORRX1",197,0)
 ;
"RTN","PSORRX1",198,0)
REFORC(DATA,HLDAT) ;
"RTN","PSORRX1",199,0)
 N RXNUM,RXSITE,RXDATE,PHARMLN,PHARMFN,REQSITE,PHONE
"RTN","PSORRX1",200,0)
 S RXNUM=$P($P(DATA,ORFS,3),U)
"RTN","PSORRX1",201,0)
 S RXSITE=$P($P(DATA,ORFS,3),U,2)
"RTN","PSORRX1",202,0)
 S RPDATE=$P(DATA,ORFS,10)
"RTN","PSORRX1",203,0)
 S PNAME=$P(DATA,ORFS,11),PHARMLN=$P(PNAME,U,2),PHARMFN=$P(PNAME,U,3)
"RTN","PSORRX1",204,0)
 S PHNAME=PHARMLN_","_PHARMFN
"RTN","PSORRX1",205,0)
 S $P(@HLDAT@(1),U,3)=RXNUM
"RTN","PSORRX1",206,0)
 S $P(@HLDAT@(1),U,4)=RXSITE
"RTN","PSORRX1",207,0)
 S $P(@HLDAT@(1),U,5)=$$HL7TFM^XLFDT(RPDATE)
"RTN","PSORRX1",208,0)
 S $P(@HLDAT@(1),U,6)=PHNAME
"RTN","PSORRX1",209,0)
 Q
"RTN","PSORRX1",210,0)
REFRXD(DATA,HLDAT)  ;
"RTN","PSORRX1",211,0)
 N QTY,DSUPP,DNAME
"RTN","PSORRX1",212,0)
 ; quantity
"RTN","PSORRX1",213,0)
 S $P(@HLDAT@(1),U,7)=$P(DATA,ORFS,5)
"RTN","PSORRX1",214,0)
 ; dispense date
"RTN","PSORRX1",215,0)
 S $P(@HLDAT@(1),U,8)=$$HL7TFM^XLFDT($E($P(DATA,ORFS,4),1,8))
"RTN","PSORRX1",216,0)
 ; drug name
"RTN","PSORRX1",217,0)
 S $P(@HLDAT@(1),U,9)=$P($P(DATA,ORFS,3),"^",2)
"RTN","PSORRX1",218,0)
 ; days supply
"RTN","PSORRX1",219,0)
 S $P(@HLDAT@(1),U,10)=$P(DATA,ORFS,13)
"RTN","PSORRX1",220,0)
 ; label data location
"RTN","PSORRX1",221,0)
 S $P(@HLDAT@(1),U,11)=$P(DATA,ORFS,10)
"RTN","PSORRX1",222,0)
 Q
"RTN","PSORRX1",223,0)
 ; log information about the refill or partial fill locally for reporting
"RTN","PSORRX1",224,0)
 ;HLDAT(1)=MESSAGE^PATIENT DFN^RX NUMBER^REMOTE SITE#^FILL/PARTIAL DATE^PHARMACIST NAME^QUANTITY^DISPENSE DATE^DRUG NAME^DAYS SUPPLY
"RTN","PSORRX1",225,0)
LOGDATA(HLDAT,TYPE,LOCDRUG,LBLGBL) ;
"RTN","PSORRX1",226,0)
 N F,ERR,FDA,DATA,FILERR,NIEN,MSG,LBL,TMPIEN,REFREM,LIEN,LDCOST,TCOST
"RTN","PSORRX1",227,0)
 S DATA=$G(@HLDAT@(1))
"RTN","PSORRX1",228,0)
 I '$G(PSODFN) S PSODFN=$$GET1^DIQ(52,PSOIEN,2,"I")
"RTN","PSORRX1",229,0)
 S F=52.09
"RTN","PSORRX1",230,0)
 ;set up FDA and file data
"RTN","PSORRX1",231,0)
 S FDA(F,"+1,",.01)=$$NOW^XLFDT
"RTN","PSORRX1",232,0)
 S FDA(F,"+1,",.02)=PSODFN
"RTN","PSORRX1",233,0)
 S FDA(F,"+1,",.03)=$P(@HLDAT@(1),U,3)
"RTN","PSORRX1",234,0)
 S FDA(F,"+1,",.04)=$O(^DIC(4,"D",$P(@HLDAT@(1),U,4),0))
"RTN","PSORRX1",235,0)
 S FDA(F,"+1,",.05)=TYPE
"RTN","PSORRX1",236,0)
 I TYPE="PR"!(TYPE="RF") S FDA(F,"+1,",.06)=$G(DUZ)
"RTN","PSORRX1",237,0)
 I TYPE="OF"!(TYPE="OP") S FDA(F,"+1,",.061)=$P(@HLDAT@(1),U,11)
"RTN","PSORRX1",238,0)
 S FDA(F,"+1,",.07)=$P(@HLDAT@(1),U,7)
"RTN","PSORRX1",239,0)
 S FDA(F,"+1,",.08)=$P(@HLDAT@(1),U,10)
"RTN","PSORRX1",240,0)
 S FDA(F,"+1,",.09)=$P(@HLDAT@(1),U,4)
"RTN","PSORRX1",241,0)
 S FDA(F,"+1,",.1)=$P(@HLDAT@(1),U,8)
"RTN","PSORRX1",242,0)
 S FDA(F,"+1,",1)=$P(@HLDAT@(1),U,9)
"RTN","PSORRX1",243,0)
 ; local drug will not be passed in if this is an OF or OR type.
"RTN","PSORRX1",244,0)
 I $G(LOCDRUG) D
"RTN","PSORRX1",245,0)
 .S FDA(F,"+1,",1.1)=LOCDRUG
"RTN","PSORRX1",246,0)
 .S QTY=$P(@HLDAT@(1),U,7) Q:'QTY
"RTN","PSORRX1",247,0)
 .S LDCOST=$$GET1^DIQ(50,LOCDRUG,16,"I") Q:LDCOST=""
"RTN","PSORRX1",248,0)
 .S TCOST=QTY*LDCOST
"RTN","PSORRX1",249,0)
 .S FDA(F,"+1,",1.2)=TCOST
"RTN","PSORRX1",250,0)
 D UPDATE^DIE(,"FDA","NIEN","FILERR")
"RTN","PSORRX1",251,0)
 I $D(FILERR) D  Q
"RTN","PSORRX1",252,0)
 .; display error
"RTN","PSORRX1",253,0)
 ; for now use piece 1 for the message. TODO - ask Jim how we get multiple lines of a message returned within the HL7
"RTN","PSORRX1",254,0)
 S NIEN=$G(NIEN(1))
"RTN","PSORRX1",255,0)
 ;I TYPE="RF" D
"RTN","PSORRX1",256,0)
 ;.S LIEN=$G(PSORRLST(ORN)) Q:'LIEN
"RTN","PSORRX1",257,0)
 ;.S STR=$G(^TMP("PSOPF",$J,LIEN,0))
"RTN","PSORRX1",258,0)
 ;.S $E(STR,68,72)=$E(DT,4,5)_"-"_$E(DT,6,7)
"RTN","PSORRX1",259,0)
 ;.S REFREM=$E(STR,75,76),REFREM=REFREM-1,$E(STR,75,76)=REFREM
"RTN","PSORRX1",260,0)
 ;.S ^TMP("PSOPF",$J,LIEN,0)=STR
"RTN","PSORRX1",261,0)
 S MSG(1)=$P(@HLDAT@(1),U)
"RTN","PSORRX1",262,0)
 D WP^DIE(52.09,NIEN_",",2,"K","MSG")
"RTN","PSORRX1",263,0)
 I $D(LBLGBL) D
"RTN","PSORRX1",264,0)
 .M LBL=@LBLGBL
"RTN","PSORRX1",265,0)
 .D WP^DIE(52.09,NIEN_",",3,"K","LBL")
"RTN","PSORRX1",266,0)
 .; prompt for device and print the label (NOTE: this could be enhanced to allow queueing)
"RTN","PSORRX1",267,0)
 .W ! K POP S %ZIS("B")="",%ZIS="MNQ",%ZIS("A")="Select LABEL DEVICE: " D ^%ZIS
"RTN","PSORRX1",268,0)
 .U IO
"RTN","PSORRX1",269,0)
 .S LBLOOP=0 F  S LBLOOP=$O(@LBLGBL@(LBLOOP)) Q:'LBLOOP  D
"RTN","PSORRX1",270,0)
 ..S LBTXT=$G(@LBLGBL@(LBLOOP,0))
"RTN","PSORRX1",271,0)
 ..I $D(@LBLGBL@(LBLOOP,"OVF")) D
"RTN","PSORRX1",272,0)
 ...S LBLOVF=0 F  S LBLOVF=$O(@LBLGBL@(LBLOOP,"OVF",LBLOVF)) Q:'LBLOVF  D
"RTN","PSORRX1",273,0)
 ....S LBTXT=$G(LBTXT)_$G(@LBLGBL@(LBLOOP,"OVF",LBLOVF,0))
"RTN","PSORRX1",274,0)
 ..W !,LBTXT
"RTN","PSORRX1",275,0)
 .C IO
"RTN","PSORRX1",276,0)
 Q
"RTN","PSORRX1",277,0)
PIDSEG(DFN,REMSITE) ;
"RTN","PSORRX1",278,0)
 N SITE,LOOP,TFSTRING,STATION
"RTN","PSORRX1",279,0)
 S SITE=DUZ(2),STATION=$$STA^XUAF4(DUZ(2))
"RTN","PSORRX1",280,0)
 S REMSITE=$G(REMSITE,"")
"RTN","PSORRX1",281,0)
 D TFL^VAFCTFU2(.TFLIST,DFN_"^PI^USVHA^"_STATION)
"RTN","PSORRX1",282,0)
 I $P(TFLIST(1),U)'=-1 D
"RTN","PSORRX1",283,0)
 .S LOOP=0 F  S LOOP=$O(TFLIST(LOOP)) Q:'LOOP  D
"RTN","PSORRX1",284,0)
 ..S TFDAT=$G(TFLIST(LOOP)) I LOOP>1,$L(REMSITE),$P(TFDAT,U,4)'=REMSITE Q
"RTN","PSORRX1",285,0)
 ..S TFSTRING=$G(TFSTRING)_$P(TFDAT,U)_U_U_U_$P(TFDAT,U,3)_U_$P(TFDAT,U,2)_U_$P(TFDAT,U,4)
"RTN","PSORRX1",286,0)
 ..; if there is more data, place a separater.
"RTN","PSORRX1",287,0)
 ..I $O(TFLIST(LOOP)) S TFSTRING=TFSTRING_"~"
"RTN","PSORRX1",288,0)
 ;I '$D(TFSTRING) S TFSTRING=DFN_"^^^USVHA^PI^"_STATION
"RTN","PSORRX1",289,0)
 I '$D(TFSTRING) S TFSTRING=-1
"RTN","PSORRX1",290,0)
 Q TFSTRING
"RTN","PSORRX1",291,0)
DRUGMTCH(DRGNM) ;
"RTN","PSORRX1",292,0)
 N LDIEN,MATCH,EXIT
"RTN","PSORRX1",293,0)
 W !!,"Remote site drug name: "_DRGNM
"RTN","PSORRX1",294,0)
 I $D(^PSDRUG("B",DRGNM)) S LDIEN=$O(^PSDRUG("B",DRGNM,0))
"RTN","PSORRX1",295,0)
 I $D(LDIEN) S LDNAME=$$GET1^DIQ(50,LDIEN,.01,"E")
"RTN","PSORRX1",296,0)
 W !,"Local match found: "_LDNAME
"RTN","PSORRX1",297,0)
 S DIR(0)="Y",DIR("A")="Would you like to use this drug" D ^DIR
"RTN","PSORRX1",298,0)
 I Y="^" Q 0
"RTN","PSORRX1",299,0)
 I Y=1 Q LDIEN
"RTN","PSORRX1",300,0)
 S LDIEN=""
"RTN","PSORRX1",301,0)
 ; if user answered no, let them search for the drug by name
"RTN","PSORRX1",302,0)
 S (MATCH,EXIT)=0
"RTN","PSORRX1",303,0)
 F  D  Q:MATCH!(EXIT)
"RTN","PSORRX1",304,0)
 .S DIC=50,DIC(0)="AEQMZ",DIC("A")="Select matching local drug: " D ^DIC
"RTN","PSORRX1",305,0)
 .I Y=-1 S EXIT=1 Q
"RTN","PSORRX1",306,0)
 .S LDIEN=$P(Y,U) I LDIEN>0 S MATCH=1 Q
"RTN","PSORRX1",307,0)
 Q $G(LDIEN)
"RTN","PSORRX1",308,0)
 ; TEXT to build prompts
"RTN","PSORRX1",309,0)
 ;;DIR(0)|DIR(A)|DIR(B)|VARIABLE
"RTN","PSORRX1",310,0)
PRMPTXT ;
"RTN","PSORRX1",311,0)
 ;;D|Enter PARTIAL FILL date|NOW|PDATE
"RTN","PSORRX1",312,0)
 ;;S^M:MAIL;W:WINDOW|MAIL or WINDOW||MW
"RTN","PSORRX1",313,0)
 ;;N|Enter Quantity||QTY
"RTN","PSORRX1",314,0)
 ;;N|DAYS SUPPLY||DSUPP
"RTN","PSORRX1",315,0)
 ;;P^200:QEAMZ|Select PHARMACIST Name|S DEF=$$GET1~DIQ(200,DUZ,.01,"E")|PHARM
"RTN","PSORRX1",316,0)
 ;;F^0:60|REMARKS||REMARKS
"RTN","PSORRX1",317,0)
 ;;Q
"RTN","PSORRX1",318,0)
 Q
"RTN","PSORWRAP")
0^10^B4004
"RTN","PSORWRAP",1,0)
PSORWRAP ;INO/JTH/BWF - Remote RX API wrapper
"RTN","PSORWRAP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;;DEC 1997;Build 16
"RTN","PSORWRAP",3,0)
 Q
"RTN","PSORWRAP",4,0)
REFILL(QBSESSID,QBDUZ)
"RTN","PSORWRAP",5,0)
 ; RET - return data
"RTN","PSORWRAP",6,0)
 ; RXNUM - RX Number from remote system
"RTN","PSORWRAP",7,0)
 ; FDATE - Fill Date
"RTN","PSORWRAP",8,0)
 ; MW - Mail/Window - Default of 'W' for now.
"RTN","PSORWRAP",9,0)
 ; RPHARM - Remote pharmacist's name
"RTN","PSORWRAP",10,0)
 ; RPHONE - remote pharmacists phone number
"RTN","PSORWRAP",11,0)
 ; RSITE - remote filling site.
"RTN","PSORWRAP",12,0)
 ;
"RTN","PSORWRAP",13,0)
 ; REMREF(RET,RXNUM,FDATE,MW,RPHARM,RPHONE,RSITE)
"RTN","PSORWRAP",14,0)
 N QBLIST,U,DT
"RTN","PSORWRAP",15,0)
 S U="^"
"RTN","PSORWRAP",16,0)
 S DT=$P($$NOW^XLFDT,".")
"RTN","PSORWRAP",17,0)
 D DUZ^XUP(QBDUZ)
"RTN","PSORWRAP",18,0)
 ;
"RTN","PSORWRAP",19,0)
 S RXNUM=^XTMP(QBSESSID,"input","rxNumber")
"RTN","PSORWRAP",20,0)
 S FDATE=^XTMP(QBSESSID,"input","fillDate")
"RTN","PSORWRAP",21,0)
 S MW=^XTMP(QBSESSID,"input","location")
"RTN","PSORWRAP",22,0)
 S RPHARM=^XTMP(QBSESSID,"input","pharmacist")
"RTN","PSORWRAP",23,0)
 S RPHONE=^XTMP(QBSESSID,"input","phoneNumber")
"RTN","PSORWRAP",24,0)
 S RSITE=^XTMP(QBSESSID,"input","requestingSite")
"RTN","PSORWRAP",25,0)
 ;
"RTN","PSORWRAP",26,0)
 D REMREF^PSORREF(.QBLIST,RXNUM,FDATE,MW,RPHARM,RPHONE,RSITE)
"RTN","PSORWRAP",27,0)
 M ^XTMP(QBSESSID,"output")=QBLIST
"RTN","PSORWRAP",28,0)
 Q "1^"_QBSESSID
"RTN","PSORWRAP",29,0)
 ;
"RTN","PSORWRAP",30,0)
PARTIAL(QBSESSID,QBDUZ)
"RTN","PSORWRAP",31,0)
 ; VALMSG - return data for remote facility
"RTN","PSORWRAP",32,0)
 ; RXNUM - rx number
"RTN","PSORWRAP",33,0)
 ; FDATE - Partial Fill Date
"RTN","PSORWRAP",34,0)
 ; MW - Mail or Window
"RTN","PSORWRAP",35,0)
 ; QTY - Quantity
"RTN","PSORWRAP",36,0)
 ; DSUPP - Days Supply
"RTN","PSORWRAP",37,0)
 ; REMARKS - Remarks entered by 'remote' (filling) facility.
"RTN","PSORWRAP",38,0)
 ; RPHARM - Remote pharmacist's name
"RTN","PSORWRAP",39,0)
 ; RPHONE - remote pharmacists phone number
"RTN","PSORWRAP",40,0)
 ; RSITE - remote filling site.
"RTN","PSORWRAP",41,0)
 ;
"RTN","PSORWRAP",42,0)
 ; PAR(VALMSG,RXNUM,PFDATE,MW,QTY,DSUPP,REMARKS,PHARM,PHONE,SITE)
"RTN","PSORWRAP",43,0)
 N QBLIST,U,DT
"RTN","PSORWRAP",44,0)
 S U="^"
"RTN","PSORWRAP",45,0)
 S DT=$P($$NOW^XLFDT,".")
"RTN","PSORWRAP",46,0)
 D DUZ^XUP(QBDUZ)
"RTN","PSORWRAP",47,0)
 ;
"RTN","PSORWRAP",48,0)
 S RXNUM=^XTMP(QBSESSID,"input","rxNumber")
"RTN","PSORWRAP",49,0)
 S FDATE=^XTMP(QBSESSID,"input","fillDate")
"RTN","PSORWRAP",50,0)
 S MW=^XTMP(QBSESSID,"input","location")
"RTN","PSORWRAP",51,0)
 S QTY=^XTMP(QBSESSID,"input","quantity")
"RTN","PSORWRAP",52,0)
 S DSUPP=^XTMP(QBSESSID,"input","daysSupply")
"RTN","PSORWRAP",53,0)
 S REMARKS=^XTMP(QBSESSID,"input","remarks")
"RTN","PSORWRAP",54,0)
 S RPHARM=^XTMP(QBSESSID,"input","pharmacist")
"RTN","PSORWRAP",55,0)
 S RPHONE=^XTMP(QBSESSID,"input","phoneNumber")
"RTN","PSORWRAP",56,0)
 S RSITE=^XTMP(QBSESSID,"input","requestingSite")
"RTN","PSORWRAP",57,0)
 ;
"RTN","PSORWRAP",58,0)
 D PAR^PSORRPA1(.QBLIST,RXNUM,FDATE,MW,QTY,DSUPP,REMARKS,RPHARM,RPHONE,RSITE)
"RTN","PSORWRAP",59,0)
 M ^XTMP(QBSESSID,"output")=QBLIST
"RTN","PSORWRAP",60,0)
 Q "1^"_QBSESSID
"RTN","PSORX1")
0^7^B67963824
"RTN","PSORX1",1,0)
PSORX1 ;BIR/SAB-medication processing driver ;3/28/05 1:14pm
"RTN","PSORX1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**7,22,23,57,62,46,74,71,90,95,115,117,146,139,135,182,195,233,268,300,170,320,326,324,334,251**;DEC 1997;Build 16
"RTN","PSORX1",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSORX1",4,0)
 ;External reference ^DIC(31 supported by DBIA 658
"RTN","PSORX1",5,0)
 ;External reference ^DPT(D0,.372 supported by DBIA 1476
"RTN","PSORX1",6,0)
 ;External reference DISPPRF^DGPFAPI supported by DBIA #4563
"RTN","PSORX1",7,0)
 ;External reference ^ORRDI1 is supported by DBIA 4659
"RTN","PSORX1",8,0)
 ;External reference ^XTMP("ORRDI" is supported by DBIA 4660
"RTN","PSORX1",9,0)
 ;External reference ^PSUHL supported by DBIA 4803
"RTN","PSORX1",10,0)
 ;
"RTN","PSORX1",11,0)
 ;PSO*195 add call to display Patient Record Flag (DISPPRF^DGPFAPI)
"RTN","PSORX1",12,0)
 ;
"RTN","PSORX1",13,0)
START K PSOQFLG,PSOID,PSOFIN,PSOQUIT,PSODRUG,^TMP($J,"PSOTDD"),^TMP("PSORXPO",$J),^TMP("PSORXBO",$J)
"RTN","PSORX1",14,0)
 D EOJ S (PSOBCK,PSOERR)=1 D INIT G:PSORX("QFLG") END
"RTN","PSORX1",15,0)
 D PT G:$G(PSORX("QFLG")) END D FULL^VALM1 I $G(NOPROC) K NOPROC G NX
"RTN","PSORX1",16,0)
 ;call to add bingo board data to file 52.11
"RTN","PSORX1",17,0)
 F SLPPL=0:0 S SLPPL=$O(RXRS(SLPPL)) Q:'SLPPL  D
"RTN","PSORX1",18,0)
 .I $P($G(^PSRX(SLPPL,"STA")),"^")'=5 K RXRS(SLPPL) Q
"RTN","PSORX1",19,0)
 .S RXREC=SLPPL D WIND^PSOSUPOE I $G(PBINGRTE) D BBADD^PSOSUPOE S (BINGCRT,BINGRTE)=1 S:$G(PSOFROM)'="NEW" PSOFROM="REFILL"
"RTN","PSORX1",20,0)
 K TM,TM1 I $G(PSORX("PSOL",1))]""!($D(RXRS)) D ^PSORXL K PSORX
"RTN","PSORX1",21,0)
 G:$G(NOBG) NX
"RTN","PSORX1",22,0)
 S TM=$P(^TMP("PSOBB",$J),"^"),TM1=$P(^TMP("PSOBB",$J),"^",2) K ^TMP("PSOBB",$J)
"RTN","PSORX1",23,0)
 I $G(PSOFROM)="NEW"!($G(PSOFROM)="REFILL")!($G(PSOFROM)="PARTIAL") D:$D(BINGCRT)&($D(BINGRTE)&($D(DISGROUP))) ^PSOBING1 K BINGCRT,BINGRTE,BBRX,BBFLG
"RTN","PSORX1",24,0)
NX I $G(POERR("DEAD"))!$G(PSOQFLG) D EOJ G START
"RTN","PSORX1",25,0)
 D EOJ G START
"RTN","PSORX1",26,0)
END Q
"RTN","PSORX1",27,0)
 ;---------------------------------------------------------
"RTN","PSORX1",28,0)
INIT ;
"RTN","PSORX1",29,0)
 S PSORX("QFLG")=0
"RTN","PSORX1",30,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) S PSORX("QFLG")=1
"RTN","PSORX1",31,0)
 I $P($G(PSOPAR),"^",2),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("VERIFY")=1
"RTN","PSORX1",32,0)
INITX Q
"RTN","PSORX1",33,0)
 ;
"RTN","PSORX1",34,0)
PT ;
"RTN","PSORX1",35,0)
 K ^TMP("PSORXDC",$J),^TMP($J,"PSEXC","OUT"),CLOZPAT,DIC,PSODFN,PSOPTLK
"RTN","PSORX1",36,0)
 S PSORX("QFLG")=0,DIC(0)="QEAM" D EN^PSOPATLK S Y=PSOPTLK
"RTN","PSORX1",37,0)
 I +Y'>0 S PSORX("QFLG")=1 G PTX
"RTN","PSORX1",38,0)
OERR N:$G(MEDP) PAT,POERR K PSOXFLG S (DFN,PSODFN)=+Y,PSORX("NAME")=$P(Y,"^",2)
"RTN","PSORX1",39,0)
 K NPPROC,PSOQFLG,DIC,DR,DIQ S DIC=2,DA=PSODFN,DR=.351,DIQ="PSOPTPST" D EN^DIQ1
"RTN","PSORX1",40,0)
 K DIC,DA,DR,DIQ D DEAD^PSOPTPST I $G(PSOQFLG) S NOPROC=1 Q
"RTN","PSORX1",41,0)
 ;PSO*195 move SSN write to here and add DISPPRF call
"RTN","PSORX1",42,0)
 S SSN=$P(^DPT(PSODFN,0),"^",9) W !!?10,$C(7),PSORX("NAME")
"RTN","PSORX1",43,0)
 W " ("_$E(SSN,1,3)_"-"_$E(SSN,4,5)_"-"_$E(SSN,6,9)_")" K SSN
"RTN","PSORX1",44,0)
 I $G(XQY0)["PSO LMOE FINISH",'$G(MEDP),$D(^TMP($J,"PSOFLPO",PSODFN)) D
"RTN","PSORX1",45,0)
 .I '$D(IOINORM)!('$D(IOINHI)) S X="IORVOFF;IORVON;IOINHI;IOINORM" D ENDR^%ZISS
"RTN","PSORX1",46,0)
 .W "  ",IORVON_IOINHI,"<This patient has flagged orders>",IOINORM_IORVOFF
"RTN","PSORX1",47,0)
 S PSONOAL="" D ALLERGY^PSOORUT2 D  I PSONOAL'="" D PAUSE
"RTN","PSORX1",48,0)
 .I PSONOAL'="" W !,$C(7),"     No Allergy Assessment!"
"RTN","PSORX1",49,0)
 D REMOTE
"RTN","PSORX1",50,0)
 ; bwf - 1/9/2014 - PHARMACY INNOVATIONS, adding call and on scren message to get remote rx's from MDWS.
"RTN","PSORX1",51,0)
 W !!,"Please wait. Checking for remote prescriptions. This may take a moment...",!
"RTN","PSORX1",52,0)
 D REMOTERX^PSORRX1(PSODFN)
"RTN","PSORX1",53,0)
 N PSOUPDT
"RTN","PSORX1",54,0)
 S PSOUPDT=1
"RTN","PSORX1",55,0)
 I $G(XQY0)["PSO LMOE FINISH" S PSOUPDT=0
"RTN","PSORX1",56,0)
 D CHKADDR^PSOBAI(PSODFN,1,PSOUPDT)
"RTN","PSORX1",57,0)
 D:($G(XQY0)["PSO LMOE FINISH")&('$G(SNGLPAT)) DISPPRF^DGPFAPI(PSODFN)
"RTN","PSORX1",58,0)
 ;
"RTN","PSORX1",59,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") W !?10,"Patient has another language preference!",! H 3
"RTN","PSORX1",60,0)
 I $G(^PS(55,"ASTALK",PSODFN)) W !,"Patient is enrolled to receive ScripTalk 'talking' prescription labels.",! H 2 D MAIL
"RTN","PSORX1",61,0)
 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2) S ^TMP("PSOBB",$J)=TM_"^"_TM1
"RTN","PSORX1",62,0)
 ;Call to display remote/local prescriptions
"RTN","PSORX1",63,0)
 I '$G(PSOFIN) D RDICHK^PSORMRX(PSODFN)
"RTN","PSORX1",64,0)
 S PSOQFLG=0,DIC="^PS(55,",DLAYGO=55
"RTN","PSORX1",65,0)
 I '$D(^PS(55,PSODFN,0)) D
"RTN","PSORX1",66,0)
 .K DD,DO S DIC(0)="L",(DINUM,X)=PSODFN D FILE^DICN D:Y<1  K DIC,DA,DR,DD,DO
"RTN","PSORX1",67,0)
 ..S $P(^PS(55,PSODFN,0),"^")=PSODFN K DIK S DA=PSODFN,DIK="^PS(55,",DIK(1)=.01 D EN^DIK K DIK
"RTN","PSORX1",68,0)
 D RXSTA
"RTN","PSORX1",69,0)
 S PSOLOUD=1 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN) K PSOLOUD
"RTN","PSORX1",70,0)
 I $G(^PS(55,PSODFN,"PS"))']"" D  I $G(POERR("QFLG")) G EOJ
"RTN","PSORX1",71,0)
 .L +^PS(55,PSODFN):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W $C(7),!!,"Patient Data is Being Edited by Another User!",! S POERR("QFLG")=1 S:$G(PSOFIN) PSOQUIT=1 Q
"RTN","PSORX1",72,0)
 .S PSOXFLG=1,SSN=$P(^DPT(PSODFN,0),"^",9) W !!?10,$C(7),PSORX("NAME")_" ("_$E(SSN,1,3)_"-"_$E(SSN,4,5)_"-"_$E(SSN,6,9)_")",! K SSN
"RTN","PSORX1",73,0)
 .S DIE=55,DR=".02;.03;.04;.05;1;D ELIG^PSORX1;3;50;106;106.1",DA=PSODFN W !!,?5,">>PHARMACY PATIENT DATA<<",! D ^DIE L -^PS(55,PSODFN)
"RTN","PSORX1",74,0)
 S PSOX=$G(^PS(55,PSODFN,"PS")) I PSOX]"" S PSORX("PATIENT STATUS")=$P($G(^PS(53,PSOX,0)),"^")
"RTN","PSORX1",75,0)
 I $G(^PS(55,PSODFN,"PS"))']"" D  I $G(POERR("QFLG")) G EOJ
"RTN","PSORX1",76,0)
 .W !!,"Patient Status Required!!",! D ELIG
"RTN","PSORX1",77,0)
 .W ! K POERR("QFLG"),DIC,DR,DIE S DIC("A")="RX PATIENT STATUS: ",DIC(0)="QEAMZ",DIC=53 D ^DIC K DIC
"RTN","PSORX1",78,0)
 .I $D(DIRUT)!(Y=-1) D  Q
"RTN","PSORX1",79,0)
 ..W $C(7),"Required Data!",! S POERR("QFLG")=1 S:$G(PSOFIN) PSOQUIT=1
"RTN","PSORX1",80,0)
 ..I $O(^PS(55,PSODFN,0))="" S DA=PSODFN,DIK="^PS(55," D ^DIK
"RTN","PSORX1",81,0)
 .S ^PS(55,PSODFN,"PS")=+Y,PSORX("PATIENT STATUS")=$P(^PS(53,+Y,0),"^")
"RTN","PSORX1",82,0)
 .K DIRUT,DTOUT,DUOUT,X,Y,DA
"RTN","PSORX1",83,0)
 Q:$G(PSOFIN)
"RTN","PSORX1",84,0)
 D ^PSOBUILD
"RTN","PSORX1",85,0)
 F PT="GET","DEAD","INP","CNH","TPB","ADDRESS","COPAY" S RTN=PT_"^PSOPTPST" D @RTN Q:$G(POERR("DEAD"))!($G(PSOQFLG))
"RTN","PSORX1",86,0)
 I $G(POERR("DEAD")) S POERR("QFLG")=1 F II=0:0 S II=$O(^PS(52.41,"P",PSODFN,II)) D:$P($G(^PS(52.41,II,0)),"^",3)'="DC"&($P($G(^(0)),"^",3)'="DE") DC^PSOORFI2
"RTN","PSORX1",87,0)
 K PSOERR("DEAD"),II I $G(PSOQFLG) S POERR("QFLG")=1 G EOJ Q
"RTN","PSORX1",88,0)
 S (PAT,PSOXXDFN)=PSODFN,POERR=1 D ^PSOORUT2,BLD^PSOORUT1,EN^PSOLMUTL
"RTN","PSORX1",89,0)
 D CLEAR^VALM1 G:$G(PSOQUIT) PTX D EN^PSOLMAO
"RTN","PSORX1",90,0)
 S (DFN,PSODFN)=PSOXXDFN K DIE,DIC,DLAYGO,DR,DA,PSOX,PSORXED
"RTN","PSORX1",91,0)
 I $O(RXFL("")),$P(^PS(55,PSODFN,0),"^",7)="" D
"RTN","PSORX1",92,0)
 . N %
"RTN","PSORX1",93,0)
 . D NOW^%DTC
"RTN","PSORX1",94,0)
 . S $P(^PS(55,PSODFN,0),"^",7)=$E(%,1,12),$P(^(0),"^",8)="A" D LOGDFN^PSUHL(PSODFN)
"RTN","PSORX1",95,0)
PTX ;
"RTN","PSORX1",96,0)
 K X,Y,^TMP("PS",$J),^TMP($J,"PSEXC","OUT"),C,DEA,PRC,PSCNT,PSOACT,PSOCLC,PSOCS,PSOCT,PSOFINFL,PSOHD,PSOLST,PSOOPT,PSOPF,PSOX,PSOX1,PSOXXDFN,SIGOK,STP,STR,PSOPTLK
"RTN","PSORX1",97,0)
 Q
"RTN","PSORX1",98,0)
EOJ ;
"RTN","PSORX1",99,0)
 I $G(PSODFN) K ^TMP($J,"PSOINTERVENE",PSODFN)
"RTN","PSORX1",100,0)
 K PSOERR,PSOMED,PSORX,PSOSD,PSODRUG,PSODFN,PSOOPT,PSOBILL,PSOIBQS,PSOCPAY,PSOPF,PSOPI,COMM,DGI,DGS,PT,PTDY,PTRF,RN,RTN,SERS,ST0,STAT,DFN,STOP,SLPPL,RXREC
"RTN","PSORX1",101,0)
 K:'$G(MEDP) PSOQFLG
"RTN","PSORX1",102,0)
 D KVA^VADPT,FULL^VALM1 K PSOLST,PSOXFLG,PSCNT,PSDIS,PSOAL,P1,LOG,%,%DT,%I,D0,DAT,DFN,DRG,ORX,PSON,PSOPTPST,PSORX,PTST,PSOBCK,PSOID,PSOBXPUL
"RTN","PSORX1",103,0)
 K INCOM,SIG,SG,STP,RX0,RXN,RX2,RX3,RTS,C,DEAD,PS,PSOCLC,PSOCNT,PSOCT,PSODA,PSOFROM,PSOHD,R3,REA,RF,RFD,RFM,RLD,RXNUM,RXP,RXPR,RXRP,RXRS,STR,POERR,VALMSG
"RTN","PSORX1",104,0)
 K ^TMP("PSORXDD",$J),^TMP("PSORXDC",$J),^TMP("PSOAL",$J),^TMP("PSOAO",$J),^TMP("PSOSF",$J),^TMP("PSOPF",$J),^TMP("PSOPI",$J),^TMP("PSOPO",$J),^TMP("PSOHDR",$J),^TMP("PSORXPO",$J)
"RTN","PSORX1",105,0)
 I '$G(MEDP),'$G(PSOQUIT) K PAT
"RTN","PSORX1",106,0)
 K ^TMP("PSORXBO",$J),PSORX,RFN,PSOXXDFN,VALM,VALMKEY,PSOBCK,SPOERR,PSOFLAG,VALMBCK,D,GMRA,GMRAL,GMRAREC,PSOSTA,PSODT,RXFL,NOBG,BBRX,BBFLG,^TMP($J,"PSOFLPO")
"RTN","PSORX1",107,0)
 K PPL,PPL1,PSOQFLAG ;*334 ADDED KILLS
"RTN","PSORX1",108,0)
 Q
"RTN","PSORX1",109,0)
ELIG ; shows eligibility and disabilities
"RTN","PSORX1",110,0)
 D ELIG^VADPT W !,"Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:"") S N=0 F  S N=$O(VAEL(1,N)) Q:'N  W !,?10,$P(VAEL(1,N),"^",2)
"RTN","PSORX1",111,0)
 W !,"Disabilities: " F I=0:0 S I=$O(^DPT(DFN,.372,I)) Q:'I  S I1=$S($D(^DPT(DFN,.372,I,0)):^(0),1:"") D:+I1
"RTN","PSORX1",112,0)
 .S PSDIS=$S($P($G(^DIC(31,+I1,0)),"^")]""&($P($G(^(0)),"^",4)']""):$P(^(0),"^"),$P($G(^DIC(31,+I1,0)),"^",4)]"":$P(^(0),"^",4),1:""),PSCNT=$P(I1,"^",2)
"RTN","PSORX1",113,0)
 .W:$L(PSDIS_"-"_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), ")>80 !,?15
"RTN","PSORX1",114,0)
 .W $S($G(PSDIS)]"":PSDIS_"-",1:"")_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), "
"RTN","PSORX1",115,0)
 K N
"RTN","PSORX1",116,0)
 Q
"RTN","PSORX1",117,0)
PROFILE ;
"RTN","PSORX1",118,0)
 S (PSORX("REFILL"),PSORX("RENEW"))=0,PSOX="" D ^PSOBUILD
"RTN","PSORX1",119,0)
 I '$G(PSOSD) W !,"This patient has no prescriptions" S:'$D(DFN) DFN=PSODFN D GMRA^PSODEM G PROFILEX
"RTN","PSORX1",120,0)
 S (PSODRG,PSOX)="" F  S PSODRG=$O(PSOSD(PSODRG)) Q:PSODRG=""  F  S PSOX=$O(PSOSD(PSODRG,PSOX)) Q:PSOX=""  S:$P(PSOSD(PSODRG,PSOX),"^",3)="" PSORX("RENEW")=1 S:$P(PSOSD(PSODRG,PSOX),"^",4)="" PSORX("REFILL")=1
"RTN","PSORX1",121,0)
 K PSOX
"RTN","PSORX1",122,0)
PROFILEX Q
"RTN","PSORX1",123,0)
 ;
"RTN","PSORX1",124,0)
MAIL ; MAKE SURE MAIL STATUS IS COMPATIBLE WITH SCRIPTALK PATIENT
"RTN","PSORX1",125,0)
 I $P($G(^PS(59,PSOSITE,"STALK")),"^")="" Q  ; NO SCRIPTALK PRINTER SET UP FOR THIS DIVISION
"RTN","PSORX1",126,0)
 N MAIL
"RTN","PSORX1",127,0)
 S MAIL=$G(^PS(55,PSODFN,0)) I $P(MAIL,"^",3)>1 Q
"RTN","PSORX1",128,0)
MAILP W !!,"REMINDER: CMOP does not fill ScripTalk prescriptions. Please select mail"
"RTN","PSORX1",129,0)
 W !,"status:  2 (DO NOT MAIL), 3 (LOCAL REGULAR MAIL) or 4 (LOCAL CERTFIED MAIL)."
"RTN","PSORX1",130,0)
 R !,"MAIL: ",MAIL:120
"RTN","PSORX1",131,0)
 I MAIL?1"^".E Q
"RTN","PSORX1",132,0)
 I MAIL<2!(MAIL>4) W !,"INVALID MAIL SETTING - ENTER 2,3, OR 4" G MAILP
"RTN","PSORX1",133,0)
 W "  ",$S(MAIL=2:"DO NOT MAIL",MAIL=3:"LOCAL REGULAR MAIL",1:"LOCAL CERTIFIED MAIL")
"RTN","PSORX1",134,0)
 S $P(^PS(55,PSODFN,0),"^",3)=MAIL
"RTN","PSORX1",135,0)
 Q
"RTN","PSORX1",136,0)
REMOTE ; 
"RTN","PSORX1",137,0)
 I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSORX1",138,0)
 I '$$HAVEHDR^ORRDI1 Q
"RTN","PSORX1",139,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSORX1",140,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) W !!,"Remote data not available - Only local order checks processed.",! D HD^PSODDPR2():(($Y+5)'>IOSL) Q
"RTN","PSORX1",141,0)
 Q
"RTN","PSORX1",142,0)
PAUSE ;
"RTN","PSORX1",143,0)
 W ! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSORX1",144,0)
 Q
"RTN","PSORX1",145,0)
 ;
"RTN","PSORX1",146,0)
RXSTA ; DISPLAY ELIGIBILITY & PROMPT FOR RX PATIENT STATUS
"RTN","PSORX1",147,0)
 N DA,PSOSTA
"RTN","PSORX1",148,0)
 I '$G(PSODFN) Q
"RTN","PSORX1",149,0)
 S DA=PSODFN,PSOSTA=$G(^PS(55,PSODFN,"PS"))
"RTN","PSORX1",150,0)
 I $G(XQY0)["PSO LMOE FINISH"!(XQY0["PSO LM BACKDOOR ORDERS") I PSOSTA]"" D
"RTN","PSORX1",151,0)
 .D ELIG^VADPT W !,"Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:"")
"RTN","PSORX1",152,0)
 .S N=0 F  S N=$O(VAEL(1,N)) Q:'N  W !,?10,$P(VAEL(1,N),"^",2)
"RTN","PSORX1",153,0)
 .S DIC("A")="RX PATIENT STATUS: ",DIC("B")=PSOSTA,DIC(0)="QEAMZ",DIC=53 D ^DIC K DIC
"RTN","PSORX1",154,0)
 .I +Y>0,+Y'=PSOSTA S DIE="^PS(55,",DR="3////"_+Y D ^DIE
"RTN","PSORX1",155,0)
 Q
"SEC","^DIC",52.09,52.09,0,"AUDIT")
@
"SEC","^DIC",52.09,52.09,0,"DD")
@
"SEC","^DIC",52.09,52.09,0,"DEL")
@
"SEC","^DIC",52.09,52.09,0,"LAYGO")
@
"SEC","^DIC",52.09,52.09,0,"RD")
@
"SEC","^DIC",52.09,52.09,0,"WR")
@
"UP",52,52.1,-1)
52^1
"UP",52,52.1,0)
52.1
"UP",52,52.2,-1)
52^P
"UP",52,52.2,0)
52.2
"VER")
8.0^22.0
"^DD",52,52.1,91,0)
REMOTE FILL SITE^P4'^DIC(4,^RF;1^Q
"^DD",52,52.1,91,1,0)
^.1
"^DD",52,52.1,91,1,1,0)
52^RFIL
"^DD",52,52.1,91,1,1,1)
S ^PSRX("RFIL",$E(X,1,30),DA(1),DA)=""
"^DD",52,52.1,91,1,1,2)
K ^PSRX("RFIL",$E(X,1,30),DA(1),DA)
"^DD",52,52.1,91,1,1,"%D",0)
^.101^1^1^3140506^^
"^DD",52,52.1,91,1,1,"%D",1,0)
Index to identify remote refills.
"^DD",52,52.1,91,1,1,"DT")
3140426
"^DD",52,52.1,91,21,0)
^.001^2^2^3140422^^
"^DD",52,52.1,91,21,1,0)
This is the institution number of the facility that performed the 
"^DD",52,52.1,91,21,2,0)
physical refill.
"^DD",52,52.1,91,"DT")
3140426
"^DD",52,52.1,92,0)
REMOTE PHARMACIST^F^^RF;2^K:$L(X)>45!($L(X)<1) X
"^DD",52,52.1,92,3)
Answer must be 1-45 characters in length.
"^DD",52,52.1,92,21,0)
^^2^2^3140422^
"^DD",52,52.1,92,21,1,0)
This is the name of the Pharmacist that remotely completed a refill for a 
"^DD",52,52.1,92,21,2,0)
prescription.
"^DD",52,52.1,92,"DT")
3140422
"^DD",52,52.1,93,0)
REMOTE PHARMACIST PHONE^F^^RF;3^K:$L(X)>15!($L(X)<1) X
"^DD",52,52.1,93,3)
Answer must be 1-15 characters in length.
"^DD",52,52.1,93,21,0)
^^2^2^3140422^
"^DD",52,52.1,93,21,1,0)
This is the contact telephone number for the remote pharmacist requesting 
"^DD",52,52.1,93,21,2,0)
a refill.
"^DD",52,52.1,93,"DT")
3140422
"^DD",52,52.2,91,0)
REMOTE FILL SITE^P4'^DIC(4,^PF;1^Q
"^DD",52,52.2,91,1,0)
^.1
"^DD",52,52.2,91,1,1,0)
52^PFIL
"^DD",52,52.2,91,1,1,1)
S ^PSRX("PFIL",$E(X,1,30),DA(1),DA)=""
"^DD",52,52.2,91,1,1,2)
K ^PSRX("PFIL",$E(X,1,30),DA(1),DA)
"^DD",52,52.2,91,1,1,"%D",0)
^^1^1^3140426^
"^DD",52,52.2,91,1,1,"%D",1,0)
Index to identify partial fills.
"^DD",52,52.2,91,1,1,"DT")
3140426
"^DD",52,52.2,91,3)
Enter the site number that is requesting this partial fill.
"^DD",52,52.2,91,21,0)
^^2^2^3140426^
"^DD",52,52.2,91,21,1,0)
This holds the site number for the facility requesting a remote partial 
"^DD",52,52.2,91,21,2,0)
fill.
"^DD",52,52.2,91,"DT")
3140426
"^DD",52,52.2,92,0)
REMOTE PHARMACIST^F^^PF;2^K:$L(X)>45!($L(X)<1) X
"^DD",52,52.2,92,3)
Enter the name of the Pharmacist that made this remote partial fill request.
"^DD",52,52.2,92,21,0)
^^2^2^3140426^
"^DD",52,52.2,92,21,1,0)
This holds the name of the pharmacist that initiated the remote partail 
"^DD",52,52.2,92,21,2,0)
fill request.
"^DD",52,52.2,92,"DT")
3140426
"^DD",52,52.2,93,0)
REMOTE PHARMACIST PHONE^F^^PF;3^K:$L(X)>15!($L(X)<1) X
"^DD",52,52.2,93,3)
Enter the contact telephone number for the pharmacist requesting this partial fill.
"^DD",52,52.2,93,21,0)
^^2^2^3140426^
"^DD",52,52.2,93,21,1,0)
This is the contact number for the remote pharmacist who initiated this 
"^DD",52,52.2,93,21,2,0)
partial fill request.
"^DD",52,52.2,93,"DT")
3140426
"^DD",52.09,52.09,0)
FIELD^^1.2^16
"^DD",52.09,52.09,0,"DT")
3140828
"^DD",52.09,52.09,0,"IX","B",52.09,.01)

"^DD",52.09,52.09,0,"IX","C",52.09,.02)

"^DD",52.09,52.09,0,"IX","D",52.09,.03)

"^DD",52.09,52.09,0,"IX","E",52.09,.04)

"^DD",52.09,52.09,0,"NM","REMOTE PRESCRIPTION LOG")

"^DD",52.09,52.09,.01,0)
LOG DATE/TIME^RD^^0;1^S %DT="ESTR" D ^%DT S X=Y K:Y<1 X
"^DD",52.09,52.09,.01,1,0)
^.1
"^DD",52.09,52.09,.01,1,1,0)
52.09^B
"^DD",52.09,52.09,.01,1,1,1)
S ^PSRXR(52.09,"B",$E(X,1,30),DA)=""
"^DD",52.09,52.09,.01,1,1,2)
K ^PSRXR(52.09,"B",$E(X,1,30),DA)
"^DD",52.09,52.09,.01,3)
Enter the date/time for this transaction.
"^DD",52.09,52.09,.01,21,0)
^^3^3^3140426^
"^DD",52.09,52.09,.01,21,1,0)
This is the date/time associated with this remote prescription 
"^DD",52.09,52.09,.01,21,2,0)
transaction. The date/time represents the date/time the message was 
"^DD",52.09,52.09,.01,21,3,0)
processed and filed locally.
"^DD",52.09,52.09,.01,"DT")
3140426
"^DD",52.09,52.09,.02,0)
PATIENT^RP2'^DPT(^0;2^Q
"^DD",52.09,52.09,.02,1,0)
^.1
"^DD",52.09,52.09,.02,1,1,0)
52.09^C
"^DD",52.09,52.09,.02,1,1,1)
S ^PSRXR(52.09,"C",$E(X,1,30),DA)=""
"^DD",52.09,52.09,.02,1,1,2)
K ^PSRXR(52.09,"C",$E(X,1,30),DA)
"^DD",52.09,52.09,.02,1,1,"%D",0)
^^1^1^3140426^
"^DD",52.09,52.09,.02,1,1,"%D",1,0)
Cross reference for patient IEN.
"^DD",52.09,52.09,.02,1,1,"DT")
3140426
"^DD",52.09,52.09,.02,3)
Enter the Patient for which this refill or partial fill occured.
"^DD",52.09,52.09,.02,21,0)
^^2^2^3140426^
"^DD",52.09,52.09,.02,21,1,0)
This is the patient for which a refill or partial fill request was 
"^DD",52.09,52.09,.02,21,2,0)
generated.
"^DD",52.09,52.09,.02,"DT")
3140426
"^DD",52.09,52.09,.03,0)
RX NUMBER^RF^^0;3^K:$L(X)>20!($L(X)<1) X
"^DD",52.09,52.09,.03,1,0)
^.1
"^DD",52.09,52.09,.03,1,1,0)
52.09^D
"^DD",52.09,52.09,.03,1,1,1)
S ^PSRXR(52.09,"D",$E(X,1,30),DA)=""
"^DD",52.09,52.09,.03,1,1,2)
K ^PSRXR(52.09,"D",$E(X,1,30),DA)
"^DD",52.09,52.09,.03,1,1,"%D",0)
^^1^1^3140426^
"^DD",52.09,52.09,.03,1,1,"%D",1,0)
Cross reference for site number.
"^DD",52.09,52.09,.03,1,1,"DT")
3140426
"^DD",52.09,52.09,.03,3)
Enter the remote RX number. This is the RX number from the remote facility.
"^DD",52.09,52.09,.03,21,0)
^^1^1^3140426^
"^DD",52.09,52.09,.03,21,1,0)
The RX# as stored at the remote facility.
"^DD",52.09,52.09,.03,"DT")
3140426
"^DD",52.09,52.09,.04,0)
SITE NUMBER^RP4'^DIC(4,^0;4^Q
"^DD",52.09,52.09,.04,1,0)
^.1
"^DD",52.09,52.09,.04,1,1,0)
52.09^E
"^DD",52.09,52.09,.04,1,1,1)
S ^PSRXR(52.09,"E",$E(X,1,30),DA)=""
"^DD",52.09,52.09,.04,1,1,2)
K ^PSRXR(52.09,"E",$E(X,1,30),DA)
"^DD",52.09,52.09,.04,1,1,"%D",0)
^^1^1^3140428^
"^DD",52.09,52.09,.04,1,1,"%D",1,0)
Site Number Cross reference.
"^DD",52.09,52.09,.04,1,1,"DT")
3140428
"^DD",52.09,52.09,.04,3)
This is the site number of the facility for the remote RX.
"^DD",52.09,52.09,.04,21,0)
^^1^1^3140426^
"^DD",52.09,52.09,.04,21,1,0)
Site number for the remote facility.
"^DD",52.09,52.09,.04,"DT")
3140428
"^DD",52.09,52.09,.05,0)
REQUEST TYPE^S^RF:REFILL;PR:PARTIAL FILL;OR:OUTSIDE REFILL;OP:OUTSIDE PARTIAL FILL;^0;5^Q
"^DD",52.09,52.09,.05,3)
This is the type of request that was made. Refill(RF), Partial Fill(PR), Outside Refill (OR), or Outside Partial Fill (OP).
"^DD",52.09,52.09,.05,21,0)
^.001^1^1^3140804^^^
"^DD",52.09,52.09,.05,21,1,0)
This fields holds the type of request being made for this RX.
"^DD",52.09,52.09,.05,"DT")
3140804
"^DD",52.09,52.09,.06,0)
OUTGOING REQUEST PHARMACIST^RP200'^VA(200,^0;6^Q
"^DD",52.09,52.09,.06,3)
Enter the Pharmacist for this refill or partial fill request.
"^DD",52.09,52.09,.06,21,0)
^^2^2^3140426^
"^DD",52.09,52.09,.06,21,1,0)
This is the Pharmacist who initiated the refill or partial fill request 
"^DD",52.09,52.09,.06,21,2,0)
to the remote facility.
"^DD",52.09,52.09,.06,"DT")
3140804
"^DD",52.09,52.09,.061,0)
REMOTE FILLING PHARMACIST^F^^0;11^K:$L(X)>30!($L(X)<3) X
"^DD",52.09,52.09,.061,3)
Answer must be 3-30 characters in length.
"^DD",52.09,52.09,.061,"DT")
3140804
"^DD",52.09,52.09,.07,0)
QUANTITY^NJ4,0^^0;7^K:+X'=X!(X>9999)!(X<0)!(X?.E1"."1N.N) X
"^DD",52.09,52.09,.07,3)
Enter the quantity that was dispensed with this refill or partial fill.
"^DD",52.09,52.09,.07,21,0)
^^1^1^3140426^
"^DD",52.09,52.09,.07,21,1,0)
This is the quantity associated with this refill or partial fill.
"^DD",52.09,52.09,.07,"DT")
3140426
"^DD",52.09,52.09,.08,0)
DAYS SUPPLY^NJ3,0^^0;8^K:+X'=X!(X>999)!(X<0)!(X?.E1"."1N.N) X
"^DD",52.09,52.09,.08,3)
Enter the days supply for this refill or partial fill.
"^DD",52.09,52.09,.08,21,0)
^^1^1^3140426^
"^DD",52.09,52.09,.08,21,1,0)
This is the days supply for this refill or partial fill action.
"^DD",52.09,52.09,.08,"DT")
3140426
"^DD",52.09,52.09,.09,0)
REFILL/PARTIAL DATE^D^^0;9^S %DT="E" D ^%DT S X=Y K:Y<1 X
"^DD",52.09,52.09,.09,3)
Enter the date for this refill or partial fill request.
"^DD",52.09,52.09,.09,21,0)
^^3^3^3140426^
"^DD",52.09,52.09,.09,21,1,0)
This is the date for the refill or partial fill request. This represents 
"^DD",52.09,52.09,.09,21,2,0)
the date as it is logged in the .01 field of either the REFILL or PARTIAL 
"^DD",52.09,52.09,.09,21,3,0)
subfile within the PRESCRIPTION file (#52) on the remote system.
"^DD",52.09,52.09,.09,"DT")
3140426
"^DD",52.09,52.09,.1,0)
DISPENSED DATE^D^^0;10^S %DT="E" D ^%DT S X=Y K:Y<1 X
"^DD",52.09,52.09,.1,3)
Enter the dispense date for this refill or partial fill request.
"^DD",52.09,52.09,.1,21,0)
^^3^3^3140426^
"^DD",52.09,52.09,.1,21,1,0)
This is the Dispense date as it is held in the DISPENSED DATE within the 
"^DD",52.09,52.09,.1,21,2,0)
REFILL subfile of the PRESCRIPTION (#52) file, or the DISPENSED DATE 
"^DD",52.09,52.09,.1,21,3,0)
within the PARTIAL subfile of the PRESCRIPTION file.
"^DD",52.09,52.09,.1,"DT")
3140426
"^DD",52.09,52.09,1,0)
REMOTE DRUG NAME^F^^1;1^K:$L(X)>120!($L(X)<1) X
"^DD",52.09,52.09,1,3)
Enter the name of the drug associated with this refill or partial fill request.
"^DD",52.09,52.09,1,21,0)
^^1^1^3140426^
"^DD",52.09,52.09,1,21,1,0)
This is the name of the drug being dispense for this request.
"^DD",52.09,52.09,1,"DT")
3140812
"^DD",52.09,52.09,1.1,0)
LOCAL (MATCHED) DRUG^P50'^PSDRUG(^1;2^Q
"^DD",52.09,52.09,1.1,21,0)
^^3^3^3140812^
"^DD",52.09,52.09,1.1,21,1,0)
This is the drug that was used for locally for the 'remote' refill or 
"^DD",52.09,52.09,1.1,21,2,0)
partial fill. Since drug IENS and names may differ between sites, a user 
"^DD",52.09,52.09,1.1,21,3,0)
must match the remote drug name to a local drug.
"^DD",52.09,52.09,1.1,"DT")
3140812
"^DD",52.09,52.09,1.2,0)
TOTAL REFILL/PARTIAL FILL COST^NJ10,2^^1;3^S:X["$" X=$P(X,"$",2) K:X'?.N.1".".2N!(X>9999999.9999999)!(X<0) X
"^DD",52.09,52.09,1.2,3)
Type a dollar amount between 0 and 9999999.99, 2 decimal digits.
"^DD",52.09,52.09,1.2,21,0)
^^3^3^3140812^
"^DD",52.09,52.09,1.2,21,1,0)
This is the total cost for the 'remote'/filling facility. The cost is 
"^DD",52.09,52.09,1.2,21,2,0)
derived by using the cost of the drug at the time of the refill or 
"^DD",52.09,52.09,1.2,21,3,0)
partial fill. The cost is being retrieved from file 50, field 13.
"^DD",52.09,52.09,1.2,"DT")
3140812
"^DD",52.09,52.09,2,0)
MESSAGE DETAILS^52.092^^2;0
"^DD",52.09,52.09,3,0)
LABEL DATA^52.093^^3;0
"^DD",52.09,52.092,0)
MESSAGE DETAILS SUB-FIELD^^.01^1
"^DD",52.09,52.092,0,"DT")
3140426
"^DD",52.09,52.092,0,"NM","MESSAGE DETAILS")

"^DD",52.09,52.092,0,"UP")
52.09
"^DD",52.09,52.092,.01,0)
MESSAGE DETAILS^Wx^^0;1^Q
"^DD",52.09,52.092,.01,3)
Enter the message details for this refill or partial fill request.
"^DD",52.09,52.092,.01,21,0)
^^2^2^3140426^
"^DD",52.09,52.092,.01,21,1,0)
Contains the message details that were passed back by the remote system. 
"^DD",52.09,52.092,.01,21,2,0)
This gives more information on what occured with this RX request.
"^DD",52.09,52.092,.01,"DT")
3140426
"^DD",52.09,52.093,0)
LABEL DATA SUB-FIELD^^.01^1
"^DD",52.09,52.093,0,"DT")
3140828
"^DD",52.09,52.093,0,"NM","LABEL DATA")

"^DD",52.09,52.093,0,"UP")
52.09
"^DD",52.09,52.093,.01,0)
LABEL DATA^WLx^^0;1^Q
"^DD",52.09,52.093,.01,3)
Enter the label data, as processed and generated by the remote facility.
"^DD",52.09,52.093,.01,21,0)
^.001^2^2^3140828^^^^
"^DD",52.09,52.093,.01,21,1,0)
This is the label data that was built by the remote facility for printing 
"^DD",52.09,52.093,.01,21,2,0)
at the local (requesting) facility.
"^DD",52.09,52.093,.01,"DT")
3140828
"^DIC",52.09,52.09,0)
REMOTE PRESCRIPTION LOG^52.09
"^DIC",52.09,52.09,0,"GL")
^PSRXR(52.09,
"^DIC",52.09,"B","REMOTE PRESCRIPTION LOG",52.09)

**END**
**END**
